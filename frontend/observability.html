<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d1117">
    <meta name="description" content="Centro de Controle - Observability">
    <title>Observability | Centro de Controle</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="css/style.css?v=23">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Auth Check -->
    <script>
        if (!sessionStorage.getItem('auth_token')) {
            window.location.href = 'login';
        }
    </script>
    <style>
        /* Observability Specific Styles */
        .obs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: var(--radius-lg);
        }

        .obs-header h1 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .obs-header p {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Stat Cards Row */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .stat-cards-section {
            margin-bottom: var(--spacing-xl);
        }

        .stat-cards-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: var(--spacing-sm);
            padding-left: 4px;
        }

        @media (max-width: 700px) {
            .stat-cards { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 450px) {
            .stat-cards { grid-template-columns: 1fr; }
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .stat-card .stat-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-card .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .stat-card .stat-trend {
            font-size: 0.75rem;
            margin-top: 8px;
        }

        .stat-card .stat-trend.positive { color: #10b981; }
        .stat-card .stat-trend.negative { color: #ef4444; }
        .stat-card .stat-trend.neutral { color: var(--text-muted); }

        /* Embed Section */
        .embed-section {
            margin-bottom: var(--spacing-xl);
        }

        .embed-section h2 {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .embed-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }

        @media (max-width: 900px) {
            .embed-grid { grid-template-columns: 1fr; }
        }

        .embed-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .embed-card-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .embed-card-header h3 {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .embed-card-header a {
            font-size: 0.75rem;
            color: var(--accent-primary);
            text-decoration: none;
        }

        .embed-card-header a:hover { text-decoration: underline; }

        .embed-card iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .embed-placeholder {
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            gap: 12px;
        }

        .embed-placeholder .placeholder-icon { font-size: 3rem; opacity: 0.5; }
        .embed-placeholder a { color: var(--accent-primary); text-decoration: none; }
        .embed-placeholder a:hover { text-decoration: underline; }

        /* Reports Section */
        .reports-section {
            margin-bottom: var(--spacing-xl);
        }

        .report-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .report-card .report-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .report-card .report-summary {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .report-card .report-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .report-type.daily { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .report-type.weekly { background: rgba(16, 185, 129, 0.2); color: #34d399; }

        .loading-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Pular para o conteudo</a>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <h1 class="logo">Centro de Controle</h1>
            <nav class="header-nav">
                <a href="./" class="nav-link" aria-label="Dashboard">Dashboard</a>
                <a href="mba" class="nav-link" aria-label="MBA">MBA</a>
                <a href="work" class="nav-link" aria-label="Work Status">Work</a>
                <a href="files" class="nav-link" aria-label="Arquivos">Arquivos</a>
                <a href="observability" class="nav-link active" aria-label="Observability">Observability</a>
            </nav>
            <div class="header-actions">
                <button class="btn-icon" onclick="loadAllData()" title="Refresh" aria-label="Refresh">
                    <span>üîÑ</span>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main-content" id="main-content" style="max-width: 1200px; display: block;">

        <!-- Header -->
        <div class="obs-header">
            <div>
                <h1>Observability</h1>
                <p>Atlas AI Agent ‚Äî Traces, Metrics, Quality Scores</p>
            </div>
            <div style="text-align: right; font-size: 0.75rem; color: var(--text-muted);">
                <div>Langfuse v3 + Grafana</div>
                <div id="last-refresh">Last refresh: --</div>
            </div>
        </div>

        <!-- Stat Cards: Row 1 ‚Äî Cost -->
        <div class="stat-cards-section">
            <div class="stat-cards-label">Cost</div>
            <div class="stat-cards">
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value" id="stat-balance">--</div>
                    <div class="stat-label" title="Saldo atual da conta Moonshot AI">Moonshot Balance</div>
                    <div class="stat-trend neutral" id="stat-balance-trend">loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∏</div>
                    <div class="stat-value" id="stat-spend">--</div>
                    <div class="stat-label" title="Custo total da Nova nos ultimos 30 dias via Langfuse">Nova Spend (30d)</div>
                    <div class="stat-trend neutral" id="stat-spend-trend">loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ü§ñ</div>
                    <div class="stat-value" id="stat-llm-calls">--</div>
                    <div class="stat-label" title="Total de chamadas LLM (traces) nos ultimos 30 dias">LLM Calls (30d)</div>
                    <div class="stat-trend neutral" id="stat-llm-trend">loading...</div>
                </div>
            </div>
        </div>

        <!-- Stat Cards: Row 2 ‚Äî Token Cache -->
        <div class="stat-cards-section">
            <div class="stat-cards-label">Token Cache</div>
            <div class="stat-cards">
                <div class="stat-card">
                    <div class="stat-icon" style="font-size:1.3rem;">‚ö°</div>
                    <div class="stat-value" id="stat-cache-rate">--</div>
                    <div class="stat-label" title="Porcentagem dos tokens de input servidos pelo cache de contexto do Moonshot">Cache Hit Rate</div>
                    <div class="stat-trend neutral" id="stat-cache-rate-trend">loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="font-size:1.3rem;">üì¶</div>
                    <div class="stat-value" id="stat-cached-tokens">--</div>
                    <div class="stat-label" title="Tokens de input cacheados vs total de tokens de input consumidos">Cached vs Total Input</div>
                    <div class="stat-trend neutral" id="stat-cached-tokens-trend">loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="font-size:1.3rem;">üíé</div>
                    <div class="stat-value" id="stat-cache-savings">--</div>
                    <div class="stat-label" title="Economia estimada usando tokens cacheados ($0.10/1M) vs preco cheio ($0.60/1M)">Cache Savings</div>
                    <div class="stat-trend neutral" id="stat-cache-savings-trend">loading...</div>
                </div>
            </div>
        </div>

        <!-- Token breakdown bar -->
        <div id="token-bar-container" style="display:none; margin-bottom: var(--spacing-lg); padding: 12px var(--spacing-lg); background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-md);">
            <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Input Token Breakdown</div>
            <div style="display:flex; height:24px; border-radius:6px; overflow:hidden; background:rgba(255,255,255,0.05);">
                <div id="token-bar-cached" style="background:linear-gradient(135deg,#10b981,#059669); transition:width 0.6s ease;" title="Cached tokens"></div>
                <div id="token-bar-noncached" style="background:linear-gradient(135deg,#6366f1,#4f46e5); transition:width 0.6s ease;" title="Non-cached tokens"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:0.7rem; color:var(--text-muted);">
                <span><span style="color:#10b981;">&#9632;</span> Cached (<span id="token-bar-cached-pct">0</span>%) &mdash; $0.10/1M</span>
                <span><span style="color:#6366f1;">&#9632;</span> Non-cached (<span id="token-bar-noncached-pct">0</span>%) &mdash; $0.60/1M</span>
            </div>
        </div>

        <!-- Stat Cards: Row 3 ‚Äî Quality & Operations -->
        <div class="stat-cards-section">
            <div class="stat-cards-label">Quality & Operations</div>
            <div class="stat-cards">
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-value" id="stat-quality">--</div>
                    <div class="stat-label" title="Nota media de qualidade das respostas da Nova nos ultimos 30 dias (escala 1-5)">Quality Score (30d)</div>
                    <div class="stat-trend neutral" id="stat-quality-trend">loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîß</div>
                    <div class="stat-value" id="stat-tool-health">--</div>
                    <div class="stat-label" title="Porcentagem de chamadas MCP que funcionaram nas ultimas 24 horas">Tool Health (24h)</div>
                    <div class="stat-trend neutral" id="stat-tool-trend">loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üß≠</div>
                    <div class="stat-value" id="stat-routing">--</div>
                    <div class="stat-label" title="Frequencia com que o router de contexto selecionou as ferramentas corretas nos ultimos 7 dias">Routing Accuracy (7d)</div>
                    <div class="stat-trend neutral" id="stat-routing-trend">loading...</div>
                </div>
            </div>
        </div>

        <!-- System Health Section -->
        <div class="embed-section">
            <h2>System Health</h2>
            <div id="health-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                <div class="stat-card" id="health-api" style="text-align:center;">
                    <div class="stat-icon">üñ•Ô∏è</div>
                    <div class="stat-value" id="health-api-status" style="font-size:1rem;">checking...</div>
                    <div class="stat-label">Centro de Controle API</div>
                </div>
                <div class="stat-card" id="health-langfuse" style="text-align:center;">
                    <div class="stat-icon">üîç</div>
                    <div class="stat-value" id="health-langfuse-status" style="font-size:1rem;">checking...</div>
                    <div class="stat-label">Langfuse</div>
                </div>
                <div class="stat-card" id="health-grafana" style="text-align:center;">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="health-grafana-status" style="font-size:1rem;">checking...</div>
                    <div class="stat-label">Grafana</div>
                </div>
                <div class="stat-card" id="health-rag" style="text-align:center;">
                    <div class="stat-icon">üß†</div>
                    <div class="stat-value" id="health-rag-status" style="font-size:1rem;">checking...</div>
                    <div class="stat-label">RAG Server</div>
                </div>
            </div>
        </div>

        <!-- Daily Cost Chart -->
        <div class="embed-section">
            <h2>Daily Cost (30d)</h2>
            <div id="cost-chart-container" style="background:var(--bg-card); border:1px solid rgba(255,255,255,0.06); border-radius:var(--radius-lg); padding:var(--spacing-lg); min-height:180px;">
                <div class="loading-state" id="cost-chart-loading">Loading chart...</div>
                <div id="cost-chart" style="display:none;"></div>
            </div>
        </div>

        <!-- Model Breakdown -->
        <div class="embed-section">
            <h2>Model Breakdown</h2>
            <div id="model-breakdown" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:12px;">
                <div class="loading-state">Loading...</div>
            </div>
        </div>

        <!-- Recent Traces -->
        <div class="embed-section">
            <h2 style="display:flex; justify-content:space-between; align-items:center;">
                Recent Traces
                <a id="langfuse-link" href="#" target="_blank" style="font-size:0.8rem; color:var(--accent-primary); text-decoration:none;">Open Langfuse UI ‚Üó</a>
            </h2>
            <div id="traces-table-container" style="background:var(--bg-card); border:1px solid rgba(255,255,255,0.06); border-radius:var(--radius-lg); overflow:hidden;">
                <div class="loading-state" id="traces-loading">Loading traces...</div>
                <div id="traces-table" style="display:none; overflow-x:auto;"></div>
            </div>
        </div>

        <!-- Embed Section: Grafana -->
        <div class="embed-section">
            <h2>Live Dashboards</h2>
            <div class="embed-grid" id="dashboards-grid">
                <!-- Grafana -->
                <div class="embed-card" style="grid-column:1/-1;">
                    <div class="embed-card-header">
                        <h3 id="grafana-title">Grafana ‚Äî Nova Cost Tracker</h3>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button id="grafana-toggle" onclick="toggleGrafanaDashboard()" 
                                    style="font-size:0.7rem; padding:3px 8px; border:1px solid rgba(255,255,255,0.15); border-radius:4px; background:transparent; color:var(--accent-primary); cursor:pointer;">
                                Switch to Quality
                            </button>
                            <a id="grafana-link" href="#" target="_blank">Open Full UI</a>
                        </div>
                    </div>
                    <div id="grafana-embed">
                        <div class="embed-placeholder" id="grafana-placeholder">
                            <div class="placeholder-icon">üìà</div>
                            <div id="grafana-status">Checking connection...</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                Cost tracking, token usage, balance history
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div class="reports-section">
            <h2>Recent Reports</h2>
            <div id="reports-container">
                <div class="loading-state">Loading reports...</div>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.75rem;">
        Atlas Observability Layer ‚Äî Langfuse v3 + Grafana + Centro de Controle
    </footer>

    <script src="js/api.js?v=8"></script>
    <script>
        // ============================================
        // OBSERVABILITY PAGE LOGIC
        // ============================================

        function formatTokens(n) {
            if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(1)}M`;
            if (n >= 1_000) return `${(n / 1_000).toFixed(1)}K`;
            return n.toString();
        }

        async function loadCostMetrics() {
            try {
                // Fetch balance, legacy cost data, and Langfuse stats in parallel
                const [balanceData, langfuseData] = await Promise.all([
                    ObservabilityAPI.getCostBalance().catch(() => null),
                    ObservabilityAPI.getLangfuseStats(30).catch(() => null),
                ]);

                // Moonshot Balance (from cost-collector snapshots)
                if (balanceData && balanceData.available_balance != null) {
                    const bal = balanceData.available_balance;
                    document.getElementById('stat-balance').textContent = `$${bal.toFixed(2)}`;
                    document.getElementById('stat-balance-trend').textContent = 
                        bal > 10 ? 'Healthy' : bal > 2 ? 'Getting low' : 'Critical!';
                    document.getElementById('stat-balance-trend').className = 
                        'stat-trend ' + (bal > 10 ? 'positive' : bal > 2 ? 'neutral' : 'negative');
                } else {
                    document.getElementById('stat-balance').textContent = 'N/A';
                    document.getElementById('stat-balance-trend').textContent = 'Balance unavailable';
                    document.getElementById('stat-balance-trend').className = 'stat-trend neutral';
                }

                // Nova Spend + LLM Calls (from Langfuse)
                if (langfuseData) {
                    const spend = langfuseData.total_cost || 0;
                    const totalCalls = langfuseData.total_observations || 0;
                    const models = Object.keys(langfuseData.model_breakdown || {}).length;

                    document.getElementById('stat-spend').textContent = `$${spend.toFixed(2)}`;
                    document.getElementById('stat-spend-trend').textContent = 
                        totalCalls > 0 ? `$${(spend / totalCalls).toFixed(4)}/call avg` : 'No calls yet';
                    document.getElementById('stat-spend-trend').className = 'stat-trend neutral';

                    document.getElementById('stat-llm-calls').textContent = totalCalls.toLocaleString();
                    document.getElementById('stat-llm-trend').textContent = 
                        models > 0 ? `${models} model${models > 1 ? 's' : ''} via Langfuse` : 'No models';
                    document.getElementById('stat-llm-trend').className = 'stat-trend neutral';

                    // Token Cache stats
                    const tokens = langfuseData.tokens || {};
                    const savings = langfuseData.cache_savings || {};

                    // Cache Hit Rate card
                    const hitRate = tokens.cache_hit_rate_pct || 0;
                    document.getElementById('stat-cache-rate').textContent = `${hitRate}%`;
                    document.getElementById('stat-cache-rate-trend').textContent = 
                        hitRate > 50 ? 'Excellent cache utilization' : hitRate > 20 ? 'Moderate caching' : 'Low caching';
                    document.getElementById('stat-cache-rate-trend').className = 
                        'stat-trend ' + (hitRate > 50 ? 'positive' : hitRate > 20 ? 'neutral' : 'negative');

                    // Cached vs Total Input card
                    const cachedTk = tokens.cached_input || 0;
                    const totalInput = tokens.total_input || 0;
                    document.getElementById('stat-cached-tokens').textContent = 
                        `${formatTokens(cachedTk)} / ${formatTokens(totalInput)}`;
                    document.getElementById('stat-cached-tokens-trend').textContent = 
                        `Output: ${formatTokens(tokens.total_output || 0)} tokens`;
                    document.getElementById('stat-cached-tokens-trend').className = 'stat-trend neutral';

                    // Cache Savings card
                    const savedUsd = savings.savings_usd || 0;
                    const savedPct = savings.savings_pct || 0;
                    document.getElementById('stat-cache-savings').textContent = `$${savedUsd.toFixed(2)}`;
                    document.getElementById('stat-cache-savings-trend').textContent = 
                        `${savedPct}% saved vs no-cache ($${(savings.cost_without_cache || 0).toFixed(2)})`;
                    document.getElementById('stat-cache-savings-trend').className = 
                        'stat-trend ' + (savedPct > 30 ? 'positive' : savedPct > 10 ? 'neutral' : 'negative');

                    // Token breakdown bar
                    if (totalInput > 0) {
                        const cachedPct = hitRate;
                        const nonCachedPct = (100 - hitRate).toFixed(1);
                        document.getElementById('token-bar-container').style.display = 'block';
                        document.getElementById('token-bar-cached').style.width = `${cachedPct}%`;
                        document.getElementById('token-bar-noncached').style.width = `${nonCachedPct}%`;
                        document.getElementById('token-bar-cached-pct').textContent = cachedPct;
                        document.getElementById('token-bar-noncached-pct').textContent = nonCachedPct;
                    }
                } else {
                    document.getElementById('stat-spend').textContent = 'N/A';
                    document.getElementById('stat-spend-trend').textContent = 'Langfuse unavailable';
                    document.getElementById('stat-spend-trend').className = 'stat-trend neutral';
                    document.getElementById('stat-llm-calls').textContent = 'N/A';
                    document.getElementById('stat-llm-trend').textContent = 'Langfuse unavailable';
                    document.getElementById('stat-llm-trend').className = 'stat-trend neutral';
                    // Cache cards fallback
                    ['stat-cache-rate', 'stat-cached-tokens', 'stat-cache-savings'].forEach(id => {
                        document.getElementById(id).textContent = 'N/A';
                    });
                }
            } catch (e) {
                document.getElementById('stat-balance').textContent = 'ERR';
                document.getElementById('stat-spend').textContent = 'ERR';
                document.getElementById('stat-llm-calls').textContent = 'ERR';
                console.error('Cost metrics error:', e);
            }
        }

        async function loadToolMetrics() {
            try {
                const data = await ObservabilityAPI.getToolMetrics(1);
                const overall = data.overall || {};
                const rate = overall.success_rate;
                const total = overall.total || 0;

                document.getElementById('stat-tool-health').textContent = 
                    rate != null ? `${rate}%` : (total === 0 ? 'N/A' : '--');
                document.getElementById('stat-tool-trend').textContent = 
                    total > 0 ? `${total} calls today` : 'No calls yet';
                document.getElementById('stat-tool-trend').className = 
                    'stat-trend ' + (rate >= 95 ? 'positive' : rate >= 80 ? 'neutral' : 'negative');
            } catch (e) {
                document.getElementById('stat-tool-health').textContent = 'ERR';
                console.error('Tool metrics error:', e);
            }
        }

        async function loadRoutingMetrics() {
            try {
                const data = await ObservabilityAPI.getRoutingMetrics(7);
                const stats = data.stats || {};
                const total = stats.total_evals || 0;
                const acc = stats.avg_accuracy;

                document.getElementById('stat-routing').textContent = 
                    acc != null ? `${(acc * 100).toFixed(1)}%` : 'N/A';
                document.getElementById('stat-routing-trend').textContent = 
                    total > 0 ? `${total} evaluations` : 'No evaluations yet';
                document.getElementById('stat-routing-trend').className = 
                    'stat-trend ' + (acc >= 0.9 ? 'positive' : acc >= 0.7 ? 'neutral' : 'negative');
            } catch (e) {
                document.getElementById('stat-routing').textContent = 'ERR';
                console.error('Routing metrics error:', e);
            }
        }

        async function loadQualityMetrics() {
            try {
                const data = await ObservabilityAPI.getQualityMetrics(30);
                const overall = data.overall || {};
                const avg = overall.overall_avg;
                const total = overall.total_scores || 0;

                document.getElementById('stat-quality').textContent = 
                    avg != null ? `${avg}/5` : 'N/A';
                document.getElementById('stat-quality-trend').textContent = 
                    total > 0 ? `${total} evaluations` : 'No evaluations yet';
                document.getElementById('stat-quality-trend').className = 
                    'stat-trend ' + (avg >= 4 ? 'positive' : avg >= 3 ? 'neutral' : 'negative');
            } catch (e) {
                document.getElementById('stat-quality').textContent = 'ERR';
                console.error('Quality metrics error:', e);
            }
        }

        async function loadReports() {
            try {
                const [daily, weekly] = await Promise.all([
                    ObservabilityAPI.getDailyReports(3),
                    ObservabilityAPI.getWeeklyReports(2),
                ]);

                const container = document.getElementById('reports-container');
                const reports = [];

                // Merge and sort by date
                for (const r of (weekly.reports || [])) {
                    reports.push({ ...r, type: 'weekly' });
                }
                for (const r of (daily.reports || [])) {
                    reports.push({ ...r, type: 'daily' });
                }
                reports.sort((a, b) => (b.report_date || '').localeCompare(a.report_date || ''));

                if (reports.length === 0) {
                    container.innerHTML = `
                        <div class="report-card">
                            <div class="report-summary" style="color: var(--text-muted);">
                                No reports yet. Reports are generated daily at 07:00 and weekly on Sundays at 08:00.
                            </div>
                        </div>`;
                    return;
                }

                container.innerHTML = reports.map(r => `
                    <div class="report-card">
                        <div class="report-date">
                            <span class="report-type ${r.type}">${r.type}</span>
                            ${r.report_date || 'Unknown date'}
                        </div>
                        <div class="report-summary">${r.summary || 'No summary available'}</div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('reports-container').innerHTML = `
                    <div class="report-card">
                        <div class="report-summary" style="color: #ef4444;">Failed to load reports: ${e.message}</div>
                    </div>`;
            }
        }

        // ============================================
        // DAILY COST CHART (pure CSS bars)
        // ============================================
        async function loadDailyCostChart() {
            try {
                const data = await ObservabilityAPI.getLangfuseStats(30).catch(() => null);
                if (!data || !data.daily || data.daily.length === 0) {
                    document.getElementById('cost-chart-loading').textContent = 'No daily data available';
                    return;
                }
                const daily = data.daily;
                const maxCost = Math.max(...daily.map(d => d.cost), 0.001);
                
                let html = '<div style="display:flex; align-items:flex-end; gap:3px; height:140px; padding-top:8px;">';
                for (const d of daily) {
                    const pct = Math.max(2, (d.cost / maxCost) * 100);
                    const label = d.date.slice(5); // MM-DD
                    const tooltip = `${d.date}: $${d.cost.toFixed(4)} | ${d.traces} traces | ${d.observations} calls`;
                    html += `<div style="flex:1; display:flex; flex-direction:column; align-items:center; height:100%; justify-content:flex-end;" title="${tooltip}">
                        <div style="width:100%; max-width:28px; background:linear-gradient(180deg,#6366f1,#4f46e5); border-radius:3px 3px 0 0; height:${pct}%; min-height:2px; transition:height 0.3s;"></div>
                        <div style="font-size:0.55rem; color:var(--text-muted); margin-top:4px; transform:rotate(-45deg); white-space:nowrap;">${label}</div>
                    </div>`;
                }
                html += '</div>';
                html += `<div style="display:flex; justify-content:space-between; font-size:0.65rem; color:var(--text-muted); margin-top:12px;">
                    <span>Total: $${data.total_cost.toFixed(4)}</span>
                    <span>${data.total_traces} traces | ${data.total_observations} calls</span>
                </div>`;
                
                document.getElementById('cost-chart-loading').style.display = 'none';
                const chart = document.getElementById('cost-chart');
                chart.style.display = 'block';
                chart.innerHTML = html;
            } catch (e) {
                document.getElementById('cost-chart-loading').textContent = 'Error loading chart';
                console.error('Cost chart error:', e);
            }
        }

        // ============================================
        // MODEL BREAKDOWN
        // ============================================
        async function loadModelBreakdown() {
            try {
                const data = await ObservabilityAPI.getLangfuseStats(30).catch(() => null);
                const container = document.getElementById('model-breakdown');
                if (!data || !data.model_breakdown || Object.keys(data.model_breakdown).length === 0) {
                    container.innerHTML = '<div class="loading-state">No model data</div>';
                    return;
                }
                const models = Object.entries(data.model_breakdown).sort((a, b) => b[1].total_cost - a[1].total_cost);
                const totalCost = models.reduce((sum, [, v]) => sum + v.total_cost, 0);
                
                container.innerHTML = models.map(([name, v]) => {
                    const pct = totalCost > 0 ? ((v.total_cost / totalCost) * 100).toFixed(1) : 0;
                    return `<div style="background:var(--bg-card); border:1px solid rgba(255,255,255,0.06); border-radius:var(--radius-lg); padding:var(--spacing-lg);">
                        <div style="font-weight:600; color:var(--text-primary); font-size:0.9rem; margin-bottom:8px;">${name}</div>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--text-secondary); margin-bottom:4px;">
                            <span>$${v.total_cost.toFixed(4)}</span>
                            <span>${pct}%</span>
                        </div>
                        <div style="height:6px; background:rgba(255,255,255,0.05); border-radius:3px; overflow:hidden; margin-bottom:8px;">
                            <div style="height:100%; width:${pct}%; background:linear-gradient(90deg,#6366f1,#8b5cf6); border-radius:3px;"></div>
                        </div>
                        <div style="font-size:0.7rem; color:var(--text-muted);">
                            ${v.calls.toLocaleString()} calls ¬∑ ${formatTokens(v.input_tokens)} in ¬∑ ${formatTokens(v.output_tokens)} out
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                document.getElementById('model-breakdown').innerHTML = '<div class="loading-state">Error</div>';
                console.error('Model breakdown error:', e);
            }
        }

        // ============================================
        // RECENT TRACES TABLE
        // ============================================
        async function loadTracesTable() {
            try {
                const apiBase = window.location.hostname.includes('github.io')
                    ? 'https://srv1315519.hstgr.cloud' : '';
                const resp = await fetch(`${apiBase}/api/metrics/langfuse-traces?limit=20`);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                
                const container = document.getElementById('traces-table');
                const loading = document.getElementById('traces-loading');
                
                if (!data.traces || data.traces.length === 0) {
                    loading.textContent = 'No traces found';
                    return;
                }
                
                let html = `<table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
                    <thead>
                        <tr style="background:rgba(255,255,255,0.03); text-align:left;">
                            <th style="padding:10px 14px; color:var(--text-muted); font-weight:600; font-size:0.7rem; text-transform:uppercase;">Name</th>
                            <th style="padding:10px 14px; color:var(--text-muted); font-weight:600; font-size:0.7rem; text-transform:uppercase;">Model</th>
                            <th style="padding:10px 14px; color:var(--text-muted); font-weight:600; font-size:0.7rem; text-transform:uppercase;">Tokens</th>
                            <th style="padding:10px 14px; color:var(--text-muted); font-weight:600; font-size:0.7rem; text-transform:uppercase;">Cost</th>
                            <th style="padding:10px 14px; color:var(--text-muted); font-weight:600; font-size:0.7rem; text-transform:uppercase;">Time</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                for (const t of data.traces) {
                    const time = t.timestamp ? new Date(t.timestamp).toLocaleString('pt-BR', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    }) : '--';
                    const latency = t.latency_ms ? `${(t.latency_ms/1000).toFixed(1)}s` : '--';
                    html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.04);">
                        <td style="padding:10px 14px; color:var(--text-primary); font-weight:500; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${t.name || 'unnamed'}</td>
                        <td style="padding:10px 14px; color:var(--text-secondary); font-family:'JetBrains Mono',monospace; font-size:0.7rem;">${t.model || '--'}</td>
                        <td style="padding:10px 14px; color:var(--text-secondary);">${t.total_tokens > 0 ? formatTokens(t.total_tokens) : '--'}</td>
                        <td style="padding:10px 14px; color:var(--text-secondary); font-family:'JetBrains Mono',monospace;">${t.cost > 0 ? '$'+t.cost.toFixed(4) : '--'}</td>
                        <td style="padding:10px 14px; color:var(--text-muted); font-size:0.75rem; white-space:nowrap;">${time}<br><span style="font-size:0.65rem;">${latency}</span></td>
                    </tr>`;
                }
                html += '</tbody></table>';
                
                loading.style.display = 'none';
                container.style.display = 'block';
                container.innerHTML = html;
            } catch (e) {
                document.getElementById('traces-loading').textContent = 'Error loading traces';
                console.error('Traces error:', e);
            }
        }

        async function loadAllData() {
            document.getElementById('last-refresh').textContent = 
                `Last refresh: ${new Date().toLocaleTimeString()}`;
            
            // Load all in parallel
            await Promise.all([
                loadCostMetrics(),
                loadToolMetrics(),
                loadRoutingMetrics(),
                loadQualityMetrics(),
                loadDailyCostChart(),
                loadModelBreakdown(),
                loadTracesTable(),
                loadReports(),
            ]);
        }

        // ============================================
        // SMART EMBED DETECTION
        // Langfuse + Grafana via VPS HTTPS proxy or localhost
        // ============================================
        const VPS_BASE = 'https://srv1315519.hstgr.cloud';
        const TAILSCALE_IP = '100.126.23.80';

        function getServiceUrls() {
            const host = window.location.hostname;
            if (['localhost', '127.0.0.1'].includes(host)) {
                return {
                    langfuse: 'http://localhost:3100',
                    langfuseHealth: 'http://localhost:3100/api/public/health',
                    grafana: 'http://localhost:3001',
                    grafanaHealth: 'http://localhost:3001/api/health',
                    grafanaEmbed: 'http://localhost:3001'
                };
            }
            // From GitHub Pages or any remote device: use VPS HTTPS proxy on port 443
            return {
                langfuse: `${VPS_BASE}/langfuse`,
                langfuseHealth: `${VPS_BASE}/langfuse/api/public/health`,
                grafana: `${VPS_BASE}/grafana/`,
                grafanaHealth: `${VPS_BASE}/grafana/api/health`,
                grafanaEmbed: `${VPS_BASE}/grafana`
            };
        }

        async function checkService(url) {
            try {
                const r = await fetch(url, { signal: AbortSignal.timeout(5000) });
                return r.ok;
            } catch {
                return false;
            }
        }

        async function setupEmbeds() {
            const urls = getServiceUrls();

            // Check Grafana
            const gfUp = await checkService(urls.grafanaHealth);
            window._grafanaOnline = gfUp;
            window._grafanaEmbedBase = urls.grafanaEmbed;
            window._currentGrafanaDash = 'cost';
            if (gfUp) {
                document.getElementById('grafana-embed').innerHTML = 
                    `<iframe id="grafana-iframe" src="${urls.grafanaEmbed}/d/nova-cost-tracker/nova-cost-tracker?orgId=1&kiosk" 
                             loading="lazy" title="Grafana Nova Cost Tracker"></iframe>`;
            } else {
                document.getElementById('grafana-status').innerHTML = 
                    `<span style="color: #ef4444;">Grafana offline</span><br>
                     <span style="font-size:0.8rem">Ensure PC is on and Docker is running.<br>
                     Start: cd ~/Documents/langfuse-server && docker compose up -d</span>`;
            }
        }

        function toggleGrafanaDashboard() {
            if (!window._grafanaOnline) return;
            const iframe = document.getElementById('grafana-iframe');
            if (!iframe) return;
            const base = window._grafanaEmbedBase;
            const btn = document.getElementById('grafana-toggle');
            const title = document.getElementById('grafana-title');

            if (window._currentGrafanaDash === 'cost') {
                iframe.src = `${base}/d/atlas-quality-perf/atlas-quality-and-performance?orgId=1&kiosk`;
                btn.textContent = 'Switch to Cost';
                title.textContent = 'Grafana ‚Äî Quality & Performance';
                window._currentGrafanaDash = 'quality';
            } else {
                iframe.src = `${base}/d/nova-cost-tracker/nova-cost-tracker?orgId=1&kiosk`;
                btn.textContent = 'Switch to Quality';
                title.textContent = 'Grafana ‚Äî Nova Cost Tracker';
                window._currentGrafanaDash = 'cost';
            }
        }

        // ============================================
        // SYSTEM HEALTH CHECKS
        // ============================================
        async function checkSystemHealth() {
            const svcUrls = getServiceUrls();
            const apiBase = window.location.hostname.includes('github.io')
                ? VPS_BASE : '';

            const checks = [
                { id: 'health-api-status', url: `${apiBase}/api/health` },
                { id: 'health-langfuse-status', url: svcUrls.langfuseHealth },
                { id: 'health-grafana-status', url: svcUrls.grafanaHealth },
                { id: 'health-rag-status', url: `${apiBase}/api/health` }, // RAG check via API proxy
            ];

            for (const check of checks) {
                const el = document.getElementById(check.id);
                try {
                    const r = await fetch(check.url, { signal: AbortSignal.timeout(5000) });
                    if (r.ok) {
                        el.innerHTML = '<span style="color:#3fb950;">Online</span>';
                    } else {
                        el.innerHTML = '<span style="color:#f85149;">Offline</span>';
                    }
                } catch {
                    el.innerHTML = '<span style="color:#f85149;">Offline</span>';
                }
            }
        }
        checkSystemHealth();

        // Set dynamic links
        const urls = getServiceUrls();
        document.getElementById('langfuse-link').href = urls.langfuse;
        document.getElementById('grafana-link').href = urls.grafana;
        document.getElementById('langfuse-link').title = 'Open Langfuse (requires Tailscale or local access)';
        document.getElementById('grafana-link').title = 'Open Grafana';

        // Initial load
        loadAllData();
        setupEmbeds();

        // Auto-refresh every 60 seconds
        setInterval(loadAllData, 60000);
    </script>
    <script src="js/mobile-nav.js?v=7"></script>
</body>
</html>
