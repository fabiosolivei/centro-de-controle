<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d1117">
    <meta name="description" content="Centro de Controle - Observability">
    <title>Observability | Centro de Controle</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="css/style.css?v=6">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Auth Check -->
    <script>
        if (!sessionStorage.getItem('auth_token')) {
            window.location.href = 'login';
        }
    </script>
    <style>
        /* Observability Specific Styles */
        .obs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: var(--radius-lg);
        }

        .obs-header h1 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .obs-header p {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Stat Cards Row */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .stat-card .stat-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-card .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .stat-card .stat-trend {
            font-size: 0.75rem;
            margin-top: 8px;
        }

        .stat-card .stat-trend.positive { color: #10b981; }
        .stat-card .stat-trend.negative { color: #ef4444; }
        .stat-card .stat-trend.neutral { color: var(--text-muted); }

        /* Embed Section */
        .embed-section {
            margin-bottom: var(--spacing-xl);
        }

        .embed-section h2 {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .embed-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }

        @media (max-width: 900px) {
            .embed-grid { grid-template-columns: 1fr; }
        }

        .embed-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .embed-card-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .embed-card-header h3 {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .embed-card-header a {
            font-size: 0.75rem;
            color: var(--accent-primary);
            text-decoration: none;
        }

        .embed-card-header a:hover { text-decoration: underline; }

        .embed-card iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .embed-placeholder {
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            gap: 12px;
        }

        .embed-placeholder .placeholder-icon { font-size: 3rem; opacity: 0.5; }
        .embed-placeholder a { color: var(--accent-primary); text-decoration: none; }
        .embed-placeholder a:hover { text-decoration: underline; }

        /* Reports Section */
        .reports-section {
            margin-bottom: var(--spacing-xl);
        }

        .report-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .report-card .report-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .report-card .report-summary {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .report-card .report-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .report-type.daily { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .report-type.weekly { background: rgba(16, 185, 129, 0.2); color: #34d399; }

        .loading-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <h1 class="logo">Centro de Controle</h1>
            <nav class="header-nav">
                <a href="./" class="nav-link" aria-label="Dashboard">Dashboard</a>
                <a href="portfolio" class="nav-link" aria-label="Portfolio">Portfolio</a>
                <a href="mba" class="nav-link" aria-label="MBA">MBA</a>
                <a href="work" class="nav-link" aria-label="Work Status">Work</a>
                <a href="files" class="nav-link" aria-label="Arquivos">Arquivos</a>
                <a href="observability" class="nav-link active" aria-label="Observability">Observability</a>
            </nav>
            <div class="header-actions">
                <button class="btn-icon" onclick="loadAllData()" title="Refresh" aria-label="Refresh">
                    <span>üîÑ</span>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main-content" style="max-width: 1200px; display: block;">

        <!-- Header -->
        <div class="obs-header">
            <div>
                <h1>Observability</h1>
                <p>Atlas AI Agent ‚Äî Traces, Metrics, Quality Scores</p>
            </div>
            <div style="text-align: right; font-size: 0.75rem; color: var(--text-muted);">
                <div>Langfuse v3 + Grafana</div>
                <div id="last-refresh">Last refresh: --</div>
            </div>
        </div>

        <!-- Stat Cards -->
        <div class="stat-cards">
            <div class="stat-card">
                <div class="stat-icon">üîß</div>
                <div class="stat-value" id="stat-tool-health">--</div>
                <div class="stat-label">Tool Health (24h)</div>
                <div class="stat-trend neutral" id="stat-tool-trend">loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üß≠</div>
                <div class="stat-value" id="stat-routing">--</div>
                <div class="stat-label">Routing Evals (7d)</div>
                <div class="stat-trend neutral" id="stat-routing-trend">loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-value" id="stat-quality">--</div>
                <div class="stat-label">Quality Score (30d)</div>
                <div class="stat-trend neutral" id="stat-quality-trend">loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-value" id="stat-tool-calls">--</div>
                <div class="stat-label">Tool Calls (7d)</div>
                <div class="stat-trend neutral" id="stat-calls-trend">loading...</div>
            </div>
        </div>

        <!-- System Health Section -->
        <div class="embed-section">
            <h2>System Health</h2>
            <div id="health-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                <div class="stat-card" id="health-api" style="text-align:center;">
                    <div class="stat-icon">üñ•Ô∏è</div>
                    <div class="stat-value" id="health-api-status" style="font-size:1rem;">checking...</div>
                    <div class="stat-label">Centro de Controle API</div>
                </div>
                <div class="stat-card" id="health-langfuse" style="text-align:center;">
                    <div class="stat-icon">üîç</div>
                    <div class="stat-value" id="health-langfuse-status" style="font-size:1rem;">checking...</div>
                    <div class="stat-label">Langfuse</div>
                </div>
                <div class="stat-card" id="health-grafana" style="text-align:center;">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="health-grafana-status" style="font-size:1rem;">checking...</div>
                    <div class="stat-label">Grafana</div>
                </div>
                <div class="stat-card" id="health-rag" style="text-align:center;">
                    <div class="stat-icon">üß†</div>
                    <div class="stat-value" id="health-rag-status" style="font-size:1rem;">checking...</div>
                    <div class="stat-label">RAG Server</div>
                </div>
            </div>
        </div>

        <!-- Embed Section: Langfuse + Grafana -->
        <div class="embed-section">
            <h2>Live Dashboards</h2>
            <div class="embed-grid" id="dashboards-grid">
                <!-- Langfuse -->
                <div class="embed-card">
                    <div class="embed-card-header">
                        <h3>Langfuse ‚Äî Traces & Agent Graphs</h3>
                        <a id="langfuse-link" href="#" target="_blank">Open Full UI</a>
                    </div>
                    <div id="langfuse-embed">
                        <div class="embed-placeholder" id="langfuse-placeholder">
                            <div class="placeholder-icon">üîç</div>
                            <div id="langfuse-status">Checking connection...</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                Traces, spans, agent graphs, LLM-as-judge scores
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grafana -->
                <div class="embed-card">
                    <div class="embed-card-header">
                        <h3>Grafana ‚Äî System Health & Analytics</h3>
                        <a id="grafana-link" href="#" target="_blank">Open Full UI</a>
                    </div>
                    <div id="grafana-embed">
                        <div class="embed-placeholder" id="grafana-placeholder">
                            <div class="placeholder-icon">üìà</div>
                            <div id="grafana-status">Checking connection...</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                System health, routing analytics, weekly quality trends
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div class="reports-section">
            <h2>Recent Reports</h2>
            <div id="reports-container">
                <div class="loading-state">Loading reports...</div>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.75rem;">
        Atlas Observability Layer ‚Äî Langfuse v3 + Grafana + Centro de Controle
    </footer>

    <script src="js/api.js?v=6"></script>
    <script>
        // ============================================
        // OBSERVABILITY PAGE LOGIC
        // ============================================

        async function loadToolMetrics() {
            try {
                const data = await ObservabilityAPI.getToolMetrics(1);
                const overall = data.overall || {};
                const rate = overall.success_rate;
                const total = overall.total || 0;

                document.getElementById('stat-tool-health').textContent = 
                    rate != null ? `${rate}%` : (total === 0 ? 'N/A' : '--');
                document.getElementById('stat-tool-trend').textContent = 
                    total > 0 ? `${total} calls today` : 'No calls yet';
                document.getElementById('stat-tool-trend').className = 
                    'stat-trend ' + (rate >= 95 ? 'positive' : rate >= 80 ? 'neutral' : 'negative');

                // Also load 7d stats for total calls card
                const weekData = await ObservabilityAPI.getToolMetrics(7);
                const weekTotal = weekData.overall?.total || 0;
                document.getElementById('stat-tool-calls').textContent = weekTotal.toString();
                document.getElementById('stat-calls-trend').textContent = 
                    `${weekData.tools?.length || 0} distinct tools`;
                document.getElementById('stat-calls-trend').className = 'stat-trend neutral';
            } catch (e) {
                document.getElementById('stat-tool-health').textContent = 'ERR';
                console.error('Tool metrics error:', e);
            }
        }

        async function loadRoutingMetrics() {
            try {
                const data = await ObservabilityAPI.getRoutingMetrics(7);
                const stats = data.stats || {};
                const total = stats.total_evals || 0;
                const acc = stats.avg_accuracy;

                document.getElementById('stat-routing').textContent = total.toString();
                document.getElementById('stat-routing-trend').textContent = 
                    acc != null ? `Accuracy: ${(acc * 100).toFixed(1)}%` : 'No accuracy data';
                document.getElementById('stat-routing-trend').className = 
                    'stat-trend ' + (acc >= 0.9 ? 'positive' : acc >= 0.7 ? 'neutral' : 'negative');
            } catch (e) {
                document.getElementById('stat-routing').textContent = 'ERR';
                console.error('Routing metrics error:', e);
            }
        }

        async function loadQualityMetrics() {
            try {
                const data = await ObservabilityAPI.getQualityMetrics(30);
                const overall = data.overall || {};
                const avg = overall.overall_avg;
                const total = overall.total_scores || 0;

                document.getElementById('stat-quality').textContent = 
                    avg != null ? `${avg}/5` : 'N/A';
                document.getElementById('stat-quality-trend').textContent = 
                    total > 0 ? `${total} evaluations` : 'No evaluations yet';
                document.getElementById('stat-quality-trend').className = 
                    'stat-trend ' + (avg >= 4 ? 'positive' : avg >= 3 ? 'neutral' : 'negative');
            } catch (e) {
                document.getElementById('stat-quality').textContent = 'ERR';
                console.error('Quality metrics error:', e);
            }
        }

        async function loadReports() {
            try {
                const [daily, weekly] = await Promise.all([
                    ObservabilityAPI.getDailyReports(3),
                    ObservabilityAPI.getWeeklyReports(2),
                ]);

                const container = document.getElementById('reports-container');
                const reports = [];

                // Merge and sort by date
                for (const r of (weekly.reports || [])) {
                    reports.push({ ...r, type: 'weekly' });
                }
                for (const r of (daily.reports || [])) {
                    reports.push({ ...r, type: 'daily' });
                }
                reports.sort((a, b) => (b.report_date || '').localeCompare(a.report_date || ''));

                if (reports.length === 0) {
                    container.innerHTML = `
                        <div class="report-card">
                            <div class="report-summary" style="color: var(--text-muted);">
                                No reports yet. Reports are generated daily at 07:00 and weekly on Sundays at 08:00.
                            </div>
                        </div>`;
                    return;
                }

                container.innerHTML = reports.map(r => `
                    <div class="report-card">
                        <div class="report-date">
                            <span class="report-type ${r.type}">${r.type}</span>
                            ${r.report_date || 'Unknown date'}
                        </div>
                        <div class="report-summary">${r.summary || 'No summary available'}</div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('reports-container').innerHTML = `
                    <div class="report-card">
                        <div class="report-summary" style="color: #ef4444;">Failed to load reports: ${e.message}</div>
                    </div>`;
            }
        }

        async function loadAllData() {
            document.getElementById('last-refresh').textContent = 
                `Last refresh: ${new Date().toLocaleTimeString()}`;
            
            // Load all in parallel
            await Promise.all([
                loadToolMetrics(),
                loadRoutingMetrics(),
                loadQualityMetrics(),
                loadReports(),
            ]);
        }

        // ============================================
        // SMART EMBED DETECTION
        // Langfuse + Grafana via VPS HTTPS proxy or localhost
        // ============================================
        const VPS_BASE = 'https://srv1315519.hstgr.cloud';
        const TAILSCALE_IP = '100.126.23.80';

        function getServiceUrls() {
            const host = window.location.hostname;
            if (['localhost', '127.0.0.1'].includes(host)) {
                return {
                    langfuse: 'http://localhost:3100',
                    langfuseHealth: 'http://localhost:3100/api/public/health',
                    grafana: 'http://localhost:3001',
                    grafanaHealth: 'http://localhost:3001/api/health',
                    grafanaEmbed: 'http://localhost:3001'
                };
            }
            // From GitHub Pages or any remote device: use VPS HTTPS proxy
            return {
                langfuse: `http://${TAILSCALE_IP}:3100`,
                langfuseHealth: `${VPS_BASE}/langfuse/api/public/health`,
                grafana: `${VPS_BASE}/grafana/`,
                grafanaHealth: `${VPS_BASE}/grafana/api/health`,
                grafanaEmbed: `${VPS_BASE}/grafana`
            };
        }

        async function checkService(url) {
            try {
                const r = await fetch(url, { signal: AbortSignal.timeout(5000) });
                return r.ok;
            } catch {
                return false;
            }
        }

        async function setupEmbeds() {
            const urls = getServiceUrls();

            // Check Langfuse
            const lfUp = await checkService(urls.langfuseHealth);
            if (lfUp) {
                document.getElementById('langfuse-status').innerHTML = 
                    `Langfuse v3 <strong style="color: #10b981;">online</strong><br>
                     <a href="${urls.langfuse}" target="_blank">Open Langfuse Dashboard</a>`;
            } else {
                document.getElementById('langfuse-status').innerHTML = 
                    `<span style="color: #ef4444;">Langfuse offline</span><br>
                     <span style="font-size:0.8rem">Ensure PC is on and Docker is running.<br>
                     Start: cd ~/Documents/langfuse-server && docker compose up -d</span>`;
            }

            // Check Grafana
            const gfUp = await checkService(urls.grafanaHealth);
            if (gfUp) {
                document.getElementById('grafana-embed').innerHTML = 
                    `<iframe src="${urls.grafanaEmbed}/d/atlas-system-health/atlas-system-health?orgId=1&kiosk" 
                             loading="lazy" title="Grafana System Health Dashboard"></iframe>`;
            } else {
                document.getElementById('grafana-status').innerHTML = 
                    `<span style="color: #ef4444;">Grafana offline</span><br>
                     <span style="font-size:0.8rem">Ensure PC is on and Docker is running.<br>
                     Start: cd ~/Documents/langfuse-server && docker compose up -d</span>`;
            }
        }

        // ============================================
        // SYSTEM HEALTH CHECKS
        // ============================================
        async function checkSystemHealth() {
            const svcUrls = getServiceUrls();
            const apiBase = window.location.hostname.includes('github.io')
                ? VPS_BASE : '';

            const checks = [
                { id: 'health-api-status', url: `${apiBase}/api/health` },
                { id: 'health-langfuse-status', url: svcUrls.langfuseHealth },
                { id: 'health-grafana-status', url: svcUrls.grafanaHealth },
                { id: 'health-rag-status', url: `${apiBase}/api/health` }, // RAG check via API proxy
            ];

            for (const check of checks) {
                const el = document.getElementById(check.id);
                try {
                    const r = await fetch(check.url, { signal: AbortSignal.timeout(5000) });
                    if (r.ok) {
                        el.innerHTML = '<span style="color:#3fb950;">Online</span>';
                    } else {
                        el.innerHTML = '<span style="color:#f85149;">Offline</span>';
                    }
                } catch {
                    el.innerHTML = '<span style="color:#f85149;">Offline</span>';
                }
            }
        }
        checkSystemHealth();

        // Set dynamic links
        const urls = getServiceUrls();
        document.getElementById('langfuse-link').href = urls.langfuse;
        document.getElementById('grafana-link').href = urls.grafana;
        document.getElementById('langfuse-link').title = 'Open Langfuse (requires Tailscale or local access)';
        document.getElementById('grafana-link').title = 'Open Grafana';

        // Initial load
        loadAllData();
        setupEmbeds();

        // Auto-refresh every 60 seconds
        setInterval(loadAllData, 60000);
    </script>
    <script src="js/mobile-nav.js?v=6"></script>
</body>
</html>
