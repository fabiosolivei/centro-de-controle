<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d1117">
    <title>Projeto - Centro de Controle</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="css/style.css?v=22">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        if (!sessionStorage.getItem('auth_token')) {
            window.location.href = 'login';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1 class="logo">Centro de Controle</h1>
            <nav class="header-nav">
                <a href="./" class="nav-link" aria-label="Dashboard">Dashboard</a>
                <a href="mba" class="nav-link" aria-label="MBA">MBA</a>
                <a href="work" class="nav-link" aria-label="Work Status">Work</a>
                <a href="files" class="nav-link" aria-label="Arquivos">Arquivos</a>
                <a href="observability" class="nav-link" aria-label="Observability">Observability</a>
            </nav>
            <div class="header-actions"></div>
        </div>
    </header>

    <main class="main-content" style="display: block;">

        <!-- ===== HERO CARD ===== -->
        <div class="proj-hero" id="proj-hero">
            <a href="./" class="proj-hero-back" id="back-btn">‚Üê Dashboard</a>
            <div class="proj-hero-top">
                <div class="proj-hero-info">
                    <h1 id="project-name" class="proj-hero-title">Carregando...</h1>
                    <div class="proj-hero-meta">
                        <span id="project-category"></span>
                        <span id="project-status" class="badge"></span>
                        <span id="project-priority" class="badge" style="display:none;"></span>
                    </div>
                    <p id="project-description" class="proj-hero-desc"></p>
                </div>
                <div class="proj-hero-health" id="hero-health" style="display:none;"></div>
            </div>
            <div class="proj-hero-chips" id="hero-chips" style="display:none;"></div>
        </div>

        <!-- ===== PROGRESS BAR (non-work only, hidden by default) ===== -->
        <div class="project-progress-large" id="progress-section" style="display: none;">
            <div class="progress-bar-large">
                <div class="progress-fill-large" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-label">
                <span>Progresso</span>
                <span id="progress-text">0%</span>
            </div>
        </div>

        <!-- ===== STAT CARDS (non-work only, hidden if all zeros) ===== -->
        <div class="project-stats" id="project-stats" style="display: none;">
            <div class="stat-card">
                <div class="number" id="stat-tasks-todo">0</div>
                <div class="label">A Fazer</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-tasks-doing">0</div>
                <div class="label">Fazendo</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-tasks-done">0</div>
                <div class="label">Feito</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-notes">0</div>
                <div class="label">Notas</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-docs">0</div>
                <div class="label">Docs</div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- WORK PROJECT VIEW                          -->
        <!-- ========================================== -->
        <div id="work-project-view" style="display:none;">

            <!-- 1. This Week (open by default) -->
            <section class="card collapsible-section report-card-section" id="this-week-section" style="display:none; margin-bottom: var(--spacing-lg);">
                <div class="collapsible-toggle" onclick="toggleCollapsible(this)">
                    <h2>Esta Semana</h2>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span id="rc-week-label" style="font-size:0.75rem;color:var(--text-muted);"></span>
                        <span class="collapse-indicator open"></span>
                    </div>
                </div>
                <div class="collapsible-body open" id="this-week-content">
                    <div id="rc-meetings-list" class="rc-meetings-list" style="margin-bottom:var(--spacing-md);"></div>
                    <div id="rc-confluence-row" class="rc-confluence-row"></div>
                </div>
            </section>

            <!-- 2. Documentation (OPEN by default) -->
            <section class="card collapsible-section" id="work-sections-card" style="margin-bottom: var(--spacing-lg);">
                <div class="collapsible-toggle" onclick="toggleCollapsible(this)">
                    <h2>Documentacao</h2>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span class="badge" id="work-sections-count" style="font-size:0.7rem;"></span>
                        <span class="collapse-indicator open"></span>
                    </div>
                </div>
                <div class="collapsible-body open" id="work-sections-content">
                    <div id="work-sections-list" class="sections-grid">
                        <div class="empty-section">Carregando...</div>
                    </div>
                </div>
            </section>

            <!-- 3. Meetings (collapsed) -->
            <section class="card collapsible-section reference-section" id="work-meetings-section" style="margin-bottom: var(--spacing-lg);">
                <div class="collapsible-toggle" onclick="toggleCollapsible(this)">
                    <h2>Reunioes</h2>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span class="badge badge-active" id="work-meetings-count" style="font-size:0.7rem;"></span>
                        <span class="collapse-indicator"></span>
                    </div>
                </div>
                <div class="collapsible-body" id="work-meetings-content">
                    <div id="work-meetings-list">
                        <div class="empty-section">Carregando...</div>
                    </div>
                </div>
            </section>

            <!-- 4. Project Info (collapsed) -->
            <section class="card collapsible-section reference-section" id="work-overview-section" style="margin-bottom: var(--spacing-lg);">
                <div class="collapsible-toggle" onclick="toggleCollapsible(this)">
                    <h2>Informacoes do Projeto</h2>
                    <span class="collapse-indicator"></span>
                </div>
                <div class="collapsible-body" id="work-overview-content">
                    <div class="overview-grid">
                        <div class="overview-card">
                            <h3>Definicao</h3>
                            <p id="work-definition">Carregando...</p>
                        </div>
                        <div class="overview-card">
                            <h3>Contexto</h3>
                            <p id="work-context">Carregando...</p>
                        </div>
                        <div class="overview-card full-width">
                            <h3>Status Atual</h3>
                            <p id="work-current-status">Carregando...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. Intelligence (collapsed, hidden if no data) -->
            <section class="card collapsible-section intel-section" id="intel-section" style="margin-bottom: var(--spacing-lg); display: none;">
                <div class="collapsible-toggle" onclick="toggleCollapsible(this)">
                    <h2>Intelligence</h2>
                    <span class="collapse-indicator"></span>
                </div>
                <div class="collapsible-body" id="intel-content">
                    <div id="intel-body"></div>
                </div>
            </section>

            <!-- 6. Cases (collapsed, hidden if empty) -->
            <section class="card collapsible-section reference-section" id="work-cases-section" style="margin-bottom: var(--spacing-lg); display:none;">
                <div class="collapsible-toggle" onclick="toggleCollapsible(this)">
                    <h2>Cases</h2>
                    <span class="collapse-indicator"></span>
                </div>
                <div class="collapsible-body" id="work-cases-content">
                    <div id="work-cases-list"></div>
                </div>
            </section>

            <!-- Doc Preview (shared for work) -->
            <section class="card" id="work-doc-preview-section" style="display:none; margin-bottom: var(--spacing-lg);">
                <div class="section-header">
                    <h2 id="work-preview-title">Documento</h2>
                    <div class="preview-actions">
                        <button class="btn-icon" onclick="openFullscreen()" title="Expandir (F)">Expandir</button>
                        <button class="btn-primary" onclick="closePreview()">Fechar</button>
                    </div>
                </div>
                <div class="doc-preview-wrapper" id="work-doc-preview-wrapper">
                    <div id="work-doc-preview" class="doc-preview-content"></div>
                </div>
            </section>
        </div>

        <!-- ========================================== -->
        <!-- MBA PROJECT VIEW                           -->
        <!-- ========================================== -->
        <div id="mba-project-view" style="display:none;">
            <section class="card" style="margin-bottom: var(--spacing-lg);">
                <div class="section-header">
                    <h2>üìÖ Proximos Prazos</h2>
                </div>
                <div id="mba-deadlines-list">
                    <div class="empty-section">Carregando...</div>
                </div>
            </section>
            <section class="card" style="margin-bottom: var(--spacing-lg);">
                <div class="section-header">
                    <h2>üìã Atividades Pendentes</h2>
                    <span class="badge badge-active" id="mba-pending-count" style="font-size:0.7rem;"></span>
                </div>
                <div id="mba-activities-list">
                    <div class="empty-section">Carregando...</div>
                </div>
            </section>
        </div>

        <!-- ========================================== -->
        <!-- REGULAR PROJECT VIEW                       -->
        <!-- ========================================== -->
        <div class="project-sections" id="regular-project-view" style="display:none;">
            <section class="card">
                <div class="section-header">
                    <h2>üìã Tarefas</h2>
                    <button class="btn-primary" onclick="toggleAddTask()">+ Nova Tarefa</button>
                </div>
                <div class="add-form" id="add-task-form">
                    <input type="text" id="new-task-title" placeholder="Titulo da tarefa">
                    <div class="form-row">
                        <select id="new-task-priority" style="flex:1;">
                            <option value="low">Baixa</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">Alta</option>
                        </select>
                        <button class="btn-primary" onclick="addTask()">Adicionar</button>
                    </div>
                </div>
                <div id="tasks-list">
                    <div class="empty-section">Carregando...</div>
                </div>
            </section>

            <section class="card" id="files-section" style="display:none;">
                <div class="section-header">
                    <h2>üìÇ Arquivos da Nova</h2>
                    <span class="badge badge-active" id="files-status" style="font-size:0.7rem;"></span>
                </div>
                <div id="files-list">
                    <div class="empty-section">Escaneando...</div>
                </div>
            </section>

            <section class="card" id="doc-preview-section" style="display:none;">
                <div class="section-header">
                    <h2 id="preview-title">üìÑ Documento</h2>
                    <div class="preview-actions">
                        <button class="btn-icon" onclick="openFullscreen()" title="Expandir (F)">Expandir</button>
                        <button class="btn-primary" onclick="closePreview()">Fechar</button>
                    </div>
                </div>
                <div class="doc-preview-wrapper" id="doc-preview-wrapper">
                    <div id="doc-preview" class="doc-preview-content"></div>
                </div>
            </section>

            <section class="card">
                <div class="section-header">
                    <h2>üìÑ Documentos</h2>
                    <button class="btn-primary" onclick="toggleAddDoc()">+ Adicionar</button>
                </div>
                <div class="add-form" id="add-doc-form">
                    <input type="text" id="new-doc-title" placeholder="Nome do documento">
                    <input type="url" id="new-doc-url" placeholder="URL (opcional)">
                    <textarea id="new-doc-description" rows="2" placeholder="Descricao/Notas do documento..." class="add-form-textarea"></textarea>
                    <div class="form-row">
                        <select id="new-doc-type" style="flex:1;">
                            <option value="doc">üìÑ Documento</option>
                            <option value="link">üîó Link</option>
                            <option value="notion">üìù Notion</option>
                            <option value="figma">üé® Figma</option>
                            <option value="github">üíª GitHub</option>
                            <option value="jira">üìã Jira</option>
                            <option value="pdf">üìï PDF</option>
                            <option value="sheet">üìä Planilha</option>
                            <option value="slides">üìΩÔ∏è Apresentacao</option>
                        </select>
                        <button class="btn-primary" onclick="addDoc()">Adicionar</button>
                    </div>
                </div>
                <div id="docs-list">
                    <div class="empty-section">Carregando...</div>
                </div>
            </section>

            <section class="card">
                <div class="section-header">
                    <h2>üóíÔ∏è Notas</h2>
                    <button class="btn-primary" onclick="toggleAddNote()">+ Nova Nota</button>
                </div>
                <div class="add-form" id="add-note-form">
                    <input type="text" id="new-note-title" placeholder="Titulo da nota">
                    <textarea id="new-note-content" rows="3" placeholder="Conteudo..."></textarea>
                    <button class="btn-primary" onclick="addNote()">Adicionar</button>
                </div>
                <div id="notes-list">
                    <div class="empty-section">Carregando...</div>
                </div>
            </section>
        </div>

        <!-- FULLSCREEN OVERLAY (shared) -->
        <div class="fullscreen-overlay" id="fullscreen-overlay">
            <div class="fullscreen-content">
                <div class="fullscreen-header">
                    <h2 id="fullscreen-title">Documento</h2>
                    <button class="fullscreen-close" onclick="closeFullscreen()">Fechar (Esc)</button>
                </div>
                <div id="fullscreen-content" class="doc-preview-content" style="max-height: none;"></div>
            </div>
        </div>
    </main>

    <script>
        const isGitHubPages = window.location.hostname.includes('github.io');
        const API_BASE = isGitHubPages
            ? 'https://srv1315519.hstgr.cloud/api'
            : '/api';
        let projectId = null;
        let projectData = null;
        let workProjectData = null;
        let currentWorkSlug = null;
        let currentPreviewTitle = '';
        let currentPreviewContent = '';

        const urlParams = new URLSearchParams(window.location.search);
        projectId = urlParams.get('id');
        if (!projectId) window.location.href = 'index.html';

        // ===== WORK PROJECT SLUG MAPPING =====
        const WORK_PROJECT_SLUGS = {
            '3TPM': '3tpm', '3tpm': '3tpm',
            'Catalog Admin': 'catalog-admin', 'Catalog': 'catalog-admin', 'CATALOG-ADMIN': 'catalog-admin',
            'Company Store': 'company-store', 'Company & Store': 'company-store', 'COMPANY-STORE': 'company-store',
            'CMS DAM': 'cms-dam', 'CMS-DAM': 'cms-dam', 'CMS': 'cms-dam', 'DAM': 'cms-dam',
            'DAM - Documenta√ß√£o': 'cms-dam', 'CMS / DAM': 'cms-dam',
            'POCs IA': 'pocs-ia', 'POCS-IA': 'pocs-ia',
            'Autonomy': 'autonomy', 'AUTONOMY-AUTOMATION': 'autonomy'
        };

        function isWorkProject(name, cat) { return cat === 'trabalho' || !!WORK_PROJECT_SLUGS[name]; }
        function getWorkSlug(name) { return WORK_PROJECT_SLUGS[name] || name.toLowerCase().replace(/\s+/g, '-'); }
        function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function formatMeetingDate(s) {
            if (!s) return '';
            const [y,m,d] = s.split('-');
            const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            return `${parseInt(d)} ${months[parseInt(m)-1]}`;
        }
        function formatTimeAgo(date) {
            const diff = Math.floor((new Date() - date) / 1000);
            if (diff < 60) return 'agora';
            if (diff < 3600) return `ha ${Math.floor(diff/60)} min`;
            if (diff < 86400) return `ha ${Math.floor(diff/3600)}h`;
            if (diff < 604800) return `ha ${Math.floor(diff/86400)} dias`;
            return date.toLocaleDateString('pt-BR');
        }
        function extractDateFromFilename(f) { const m = f.match(/^(\d{4}-\d{2}-\d{2})-/); return m ? m[1] : null; }

        // ===== MAIN ENTRY POINT =====
        async function loadProjectWithWorkCheck() {
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}/full`);
                if (!response.ok) throw new Error('Projeto nao encontrado');
                projectData = await response.json();
                const { project } = projectData;

                renderHeroCard(project);

                if (isWorkProject(project.name, project.category)) {
                    const ok = await loadWorkProject(project.name);
                    if (ok) return;
                }

                if (project.category === 'mba') {
                    renderMbaView(project);
                    return;
                }

                renderRegularProject(project);
            } catch (error) {
                console.error(error);
                document.getElementById('project-name').textContent = 'Projeto nao encontrado';
            }
        }

        // ===== HERO CARD =====
        function renderHeroCard(project) {
            document.title = `${project.name} - Centro de Controle`;
            document.getElementById('project-name').textContent = project.name;
            document.getElementById('project-description').textContent = project.description || '';

            // Back button context
            const backBtn = document.getElementById('back-btn');
            if (isWorkProject(project.name, project.category)) {
                backBtn.href = 'work';
                backBtn.textContent = '‚Üê Work Status';
            } else if (project.category === 'mba') {
                backBtn.href = 'mba';
                backBtn.textContent = '‚Üê MBA';
            }

            // Category
            const catIcons = { trabalho: 'üíº', mba: 'üéì', pessoal: 'üë§', familia: 'üë®‚Äçüë©‚Äçüëß' };
            document.getElementById('project-category').textContent =
                (catIcons[project.category] || 'üìÅ') + ' ' + (project.category || 'Geral');

            // Status
            const statusEl = document.getElementById('project-status');
            statusEl.textContent = project.status === 'active' ? 'Ativo' : project.status === 'paused' ? 'Pausado' : 'Concluido';
            statusEl.className = 'badge ' + (project.status === 'active' ? 'badge-active' : 'badge-paused');

            // Priority
            const prioEl = document.getElementById('project-priority');
            if (project.priority === 'high') {
                prioEl.textContent = 'üî• Alta Prioridade';
                prioEl.className = 'badge badge-high';
                prioEl.style.display = 'inline';
            }
        }

        // Populate hero health badge (called async after report card loads)
        function setHeroHealth(health) {
            const el = document.getElementById('hero-health');
            const colors = { green: '#22c55e', yellow: '#eab308', red: '#ef4444' };
            const labels = { green: 'On Track', yellow: 'Atencao', red: 'Critico' };
            const c = colors[health] || colors.green;
            el.style.display = '';
            el.innerHTML = `<span class="health-badge" style="background:${c}22;color:${c};border:1px solid ${c}44;">${labels[health] || health}</span>`;
        }

        // Populate hero chips (called from work project render)
        function setHeroChips(chips) {
            const el = document.getElementById('hero-chips');
            if (chips.length > 0) {
                el.innerHTML = chips.map(c => `<span class="header-chip${c.muted?' header-chip-muted':''}">${c.text}</span>`).join('');
                el.style.display = '';
            }
        }

        // ===== WORK PROJECT =====
        async function loadWorkProject(name) {
            const slug = getWorkSlug(name);
            currentWorkSlug = slug;
            try {
                const resp = await fetch(`${API_BASE}/work-projects/${slug}`);
                if (!resp.ok) return false;
                workProjectData = await resp.json();
                renderWorkView(workProjectData);
                return true;
            } catch (e) { console.error(e); return false; }
        }

        function renderWorkView(data) {
            document.getElementById('work-project-view').style.display = 'block';
            document.getElementById('regular-project-view').style.display = 'none';
            document.getElementById('mba-project-view').style.display = 'none';

            // Hero chips from work data
            const chips = [];
            const sCount = data.sections ? data.sections.length : 0;
            const mCount = data.meeting_notes ? data.meeting_notes.length : 0;
            const cCount = data.cases ? data.cases.length : 0;
            if (sCount > 0) chips.push({ text: `üìÑ ${sCount} docs` });
            if (mCount > 0) chips.push({ text: `üìÖ ${mCount} reunioes` });
            if (cCount > 0) chips.push({ text: `üìã ${cCount} cases` });
            if (data.meeting_notes && data.meeting_notes.length > 0) {
                const last = data.meeting_notes[0];
                const d = last.date || extractDateFromFilename(last.file);
                if (d) chips.push({ text: `üïê Ultima: ${formatMeetingDate(d)}`, muted: true });
            }
            setHeroChips(chips);

            // Overview
            const ov = data.overview || {};
            const defText = ov.definition || '', ctxText = ov.context || '', stText = ov.current_status || '';
            const defCard = document.getElementById('work-definition').closest('.overview-card');
            const ctxCard = document.getElementById('work-context').closest('.overview-card');
            const stCard = document.getElementById('work-current-status').closest('.overview-card');
            if (defText) { document.getElementById('work-definition').textContent = defText; defCard.style.display = ''; } else defCard.style.display = 'none';
            if (ctxText) { document.getElementById('work-context').textContent = ctxText; ctxCard.style.display = ''; } else ctxCard.style.display = 'none';
            if (stText) { document.getElementById('work-current-status').textContent = stText; stCard.style.display = ''; } else stCard.style.display = 'none';
            document.getElementById('work-overview-section').style.display = (!defText && !ctxText && !stText) ? 'none' : '';

            renderWorkSections(data.sections || []);
            renderWorkMeetings(data.meeting_notes || []);
            if (data.cases && data.cases.length > 0) renderWorkCases(data.cases);

            if (currentWorkSlug) loadReportCard(currentWorkSlug);
        }

        async function loadReportCard(slug) {
            try {
                const rc = await fetch(`${API_BASE}/work-projects/${slug}/report-card`).then(r => r.ok ? r.json() : null);
                if (!rc) return;

                // Health in hero card
                setHeroHealth(rc.health);

                // This Week section
                const twSection = document.getElementById('this-week-section');
                const hasMeetings = rc.meetings_this_week && rc.meetings_this_week.length > 0;
                const c = rc.confluence || {};
                const hasConf = c.current_sprint || c.epics_open || c.risks || c.bugs;

                if (hasMeetings || hasConf) {
                    twSection.style.display = '';
                    document.getElementById('rc-week-label').textContent = rc.week ? `Semana de ${rc.week}` : '';

                    const meetEl = document.getElementById('rc-meetings-list');
                    if (hasMeetings) {
                        meetEl.innerHTML = rc.meetings_this_week.map(m => `
                            <div class="rc-meeting-item">
                                <span class="rc-meeting-date">${m.date||''}</span>
                                <span class="rc-meeting-title">${escapeHtml(m.title)}</span>
                                ${m.summary ? `<span class="rc-meeting-summary">${escapeHtml(m.summary)}</span>` : ''}
                            </div>
                        `).join('');
                    } else {
                        meetEl.innerHTML = '<span class="text-muted">Nenhuma reuniao esta semana</span>';
                    }

                    const confEl = document.getElementById('rc-confluence-row');
                    if (hasConf) {
                        const chips = [];
                        if (c.current_sprint) chips.push(`<span class="rc-chip">${escapeHtml(c.current_sprint)}</span>`);
                        if (c.epics_open) chips.push(`<span class="rc-chip">${c.epics_open} open epics</span>`);
                        if (c.epics_closed) chips.push(`<span class="rc-chip rc-chip-done">${c.epics_closed} closed</span>`);
                        if (c.risks) chips.push(`<span class="rc-chip rc-chip-risk">${c.risks} risk${c.risks>1?'s':''}</span>`);
                        if (c.bugs) chips.push(`<span class="rc-chip rc-chip-bug">${c.bugs} bug${c.bugs>1?'s':''}</span>`);
                        confEl.innerHTML = chips.join('');
                    } else {
                        confEl.innerHTML = '';
                    }
                }

                // Intelligence -- only show if real summary exists
                const intelSection = document.getElementById('intel-section');
                const intelBody = document.getElementById('intel-body');
                if (rc.intelligence_summary) {
                    intelSection.style.display = '';
                    intelBody.innerHTML = `
                        <div class="intel-source">Fonte: ${escapeHtml(rc.intelligence_file || 'Deep Dive')}</div>
                        <p class="intel-summary">${escapeHtml(rc.intelligence_summary)}</p>
                    `;
                } else {
                    intelSection.style.display = 'none';
                }

                // Hide Reunioes section if empty and This Week already shows meetings
                const reunioesList = document.getElementById('work-meetings-list');
                const hasFullMeetings = reunioesList && reunioesList.querySelector('.meeting-item');
                if (!hasFullMeetings && hasMeetings) {
                    document.getElementById('work-meetings-section').style.display = 'none';
                }
            } catch (e) { console.error('Error loading report card:', e); }
        }

        function renderWorkSections(sections) {
            const container = document.getElementById('work-sections-list');
            const badge = document.getElementById('work-sections-count');
            if (sections.length === 0) {
                container.innerHTML = '<div class="empty-section">Nenhuma secao de documentacao</div>';
                badge.textContent = '';
                return;
            }
            badge.textContent = `${sections.length} secoes`;
            const icons = { context:'üéØ', definition:'üìã', history:'üìú', architecture:'üèóÔ∏è', people:'üë•', timeline:'üìÖ', status:'üìç', roadmap:'üó∫Ô∏è', readme:'üìñ' };
            container.innerHTML = sections.map(s => `
                <div class="section-item" onclick="openWorkFile('${s.file}')">
                    <div class="section-name">${icons[s.key]||'üìÑ'} ${s.name}</div>
                    <div class="section-summary">${s.summary || 'Clique para ver detalhes'}</div>
                </div>
            `).join('');
        }

        function renderWorkMeetings(meetings) {
            const container = document.getElementById('work-meetings-list');
            const badge = document.getElementById('work-meetings-count');
            if (meetings.length === 0) {
                container.innerHTML = '<div class="empty-section">Nenhuma nota de reuniao</div>';
                badge.textContent = '';
                return;
            }
            badge.textContent = `${meetings.length} reunioes`;
            container.innerHTML = meetings.slice(0, 10).map(m => `
                <div class="meeting-item" onclick="openWorkFile('${m.file}')">
                    <div class="meeting-header">
                        <span class="meeting-title">${escapeHtml(m.title)}</span>
                        ${m.date ? `<span class="meeting-date">${formatMeetingDate(m.date)}</span>` : ''}
                    </div>
                    <div class="meeting-preview">${escapeHtml(m.preview) || 'Clique para ver detalhes'}</div>
                </div>
            `).join('');
        }

        function renderWorkCases(cases) {
            const section = document.getElementById('work-cases-section');
            const container = document.getElementById('work-cases-list');
            section.style.display = 'block';
            container.innerHTML = cases.map(c => `
                <div class="case-item" onclick="openWorkFile('${c.file}')">
                    <div class="meeting-title">${escapeHtml(c.title)}</div>
                    <div class="meeting-preview">${escapeHtml(c.summary)||''}</div>
                </div>
            `).join('');
        }

        async function openWorkFile(filePath) {
            if (!currentWorkSlug) return;
            try {
                const resp = await fetch(`${API_BASE}/work-projects/${currentWorkSlug}/file/${filePath}`);
                if (!resp.ok) throw new Error('Not found');
                const d = await resp.json();
                showWorkPreview(d.title, d.content);
            } catch (e) { console.error(e); alert('Erro ao carregar arquivo'); }
        }

        function showWorkPreview(title, content) {
            currentPreviewTitle = title;
            currentPreviewContent = content;
            document.getElementById('work-preview-title').textContent = title;
            document.getElementById('work-doc-preview').innerHTML = marked.parse(content);
            document.getElementById('work-doc-preview-section').style.display = 'block';
            document.getElementById('work-doc-preview-section').scrollIntoView({ behavior: 'smooth' });
        }

        // ===== MBA PROJECT VIEW =====
        async function renderMbaView(project) {
            document.getElementById('mba-project-view').style.display = 'block';
            document.getElementById('work-project-view').style.display = 'none';
            document.getElementById('regular-project-view').style.display = 'none';

            // Also load files section (in regular view), but we show it conditionally
            loadProjectFiles();

            try {
                const stats = await fetch(`${API_BASE}/mba/stats`).then(r => r.ok ? r.json() : null);
                if (!stats) {
                    document.getElementById('mba-deadlines-list').innerHTML = '<div class="empty-section">Dados do MBA nao disponiveis. Sincronize o Adalove.</div>';
                    document.getElementById('mba-activities-list').innerHTML = '<div class="empty-section">Sem dados</div>';
                    return;
                }

                // Hero chips for MBA
                const chips = [];
                if (stats.pendentes > 0) chips.push({ text: `üìã ${stats.pendentes} pendentes` });
                if (stats.em_andamento > 0) chips.push({ text: `üîÑ ${stats.em_andamento} em andamento` });
                if (stats.concluidas > 0) chips.push({ text: `‚úÖ ${stats.concluidas} concluidas`, muted: true });
                setHeroChips(chips);

                // Deadlines
                const dlContainer = document.getElementById('mba-deadlines-list');
                if (stats.proximos_prazos && stats.proximos_prazos.length > 0) {
                    dlContainer.innerHTML = stats.proximos_prazos.map(d => {
                        const isOverdue = d.due_date && new Date(d.due_date) < new Date();
                        return `<div class="task-item-project ${isOverdue ? 'status-doing' : ''}">
                            <div class="task-info">
                                <div class="task-title">${escapeHtml(d.title)}</div>
                                <div class="task-meta">${d.due_date || ''} ${d.turma ? '‚Ä¢ ' + escapeHtml(d.turma) : ''}</div>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    dlContainer.innerHTML = '<div class="empty-section">Nenhum prazo proximo</div>';
                }

                // Pending count
                document.getElementById('mba-pending-count').textContent = stats.pendentes > 0 ? `${stats.pendentes} pendentes` : '';

                // Activities list (from the full data)
                const fullData = await fetch(`${API_BASE}/mba/data`).then(r => r.ok ? r.json() : null).catch(() => null);
                const actContainer = document.getElementById('mba-activities-list');
                if (fullData) {
                    const pending = [];
                    for (const turma of (fullData.turmas || [])) {
                        for (const semana of (turma.semanas || [])) {
                            for (const a of (semana.atividades?.a_fazer || [])) {
                                pending.push({ ...a, turma: turma.nome, semana: semana.nome });
                            }
                        }
                    }
                    if (pending.length > 0) {
                        actContainer.innerHTML = pending.slice(0, 10).map(a => `
                            <div class="task-item-project">
                                <div class="task-info">
                                    <div class="task-title">${escapeHtml(a.titulo || a.title || 'Atividade')}</div>
                                    <div class="task-meta">${a.prazo ? a.prazo + ' ‚Ä¢ ' : ''}${escapeHtml(a.turma || '')} ${a.semana ? '‚Ä¢ ' + escapeHtml(a.semana) : ''}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        actContainer.innerHTML = '<div class="empty-section">Nenhuma atividade pendente</div>';
                    }
                } else {
                    actContainer.innerHTML = '<div class="empty-section">Dados completos nao disponiveis</div>';
                }
            } catch (e) {
                console.error('Error loading MBA data:', e);
                document.getElementById('mba-deadlines-list').innerHTML = '<div class="empty-section">Erro ao carregar dados</div>';
            }
        }

        // ===== REGULAR PROJECT VIEW =====
        function renderRegularProject(project) {
            document.getElementById('work-project-view').style.display = 'none';
            document.getElementById('mba-project-view').style.display = 'none';
            document.getElementById('regular-project-view').style.display = 'grid';

            const { tasks, notes, docs, stats } = projectData;
            const hasAnyStats = stats.tasks_todo + stats.tasks_doing + stats.tasks_done + stats.total_notes + stats.total_docs > 0;

            // Only show progress and stats if there's actual data
            if (hasAnyStats) {
                document.getElementById('project-stats').style.display = '';
                document.getElementById('stat-tasks-todo').textContent = stats.tasks_todo;
                document.getElementById('stat-tasks-doing').textContent = stats.tasks_doing;
                document.getElementById('stat-tasks-done').textContent = stats.tasks_done;
                document.getElementById('stat-notes').textContent = stats.total_notes;
                document.getElementById('stat-docs').textContent = stats.total_docs;
            }

            // Show progress bar only if progress > 0
            if (project.progress > 0) {
                document.getElementById('progress-section').style.display = '';
                document.getElementById('progress-fill').style.width = project.progress + '%';
                document.getElementById('progress-text').textContent = project.progress + '%';
            }

            renderTasks(tasks);
            renderDocs(docs);
            renderNotes(notes);
            loadProjectFiles();
        }

        // ===== REGULAR VIEW RENDERERS =====
        function renderTasks(tasks) {
            const container = document.getElementById('tasks-list');
            if (tasks.length === 0) { container.innerHTML = '<div class="empty-section">Nenhuma tarefa ainda</div>'; return; }
            container.innerHTML = tasks.map(t => `
                <div class="task-item-project status-${t.status}">
                    <div class="task-checkbox ${t.status==='done'?'checked':''}" onclick="toggleTask(${t.id},'${t.status}')"></div>
                    <div class="task-info">
                        <div class="task-title">${escapeHtml(t.title)}</div>
                        <div class="task-meta">${t.priority==='high'?'‚ö° Alta':t.priority==='low'?'‚Üì Baixa':''}${t.due_date?' ‚Ä¢ '+t.due_date:''}</div>
                    </div>
                    <button onclick="deleteTask(${t.id})" class="btn-delete-subtle">üóë</button>
                </div>
            `).join('');
        }

        function renderDocs(docs) {
            const container = document.getElementById('docs-list');
            if (docs.length === 0) { container.innerHTML = '<div class="empty-section">Nenhum documento ainda</div>'; return; }
            const icons = { link:'üîó', doc:'üìÑ', notion:'üìù', figma:'üé®', github:'üíª', jira:'üìã', pdf:'üìï', sheet:'üìä', slides:'üìΩÔ∏è' };
            container.innerHTML = docs.map(d => `
                <div class="doc-item">
                    <span class="doc-icon">${icons[d.doc_type]||'üìÑ'}</span>
                    <div class="doc-info">
                        <div class="doc-title">${d.url?`<a href="${d.url}" target="_blank">${escapeHtml(d.title)}</a>`:escapeHtml(d.title)}</div>
                        ${d.description?`<div class="doc-desc">${escapeHtml(d.description)}</div>`:''}
                    </div>
                    <button onclick="deleteDoc(${d.id})" class="btn-delete-subtle">üóë</button>
                </div>
            `).join('');
        }

        function renderNotes(notes) {
            const container = document.getElementById('notes-list');
            if (notes.length === 0) { container.innerHTML = '<div class="empty-section">Nenhuma nota ainda</div>'; return; }
            container.innerHTML = notes.map(n => `
                <div class="note-item">
                    <div class="note-header">
                        <div class="note-title">${escapeHtml(n.title)}</div>
                        <div class="note-date">${n.meeting_date||n.created_at?.split('T')[0]||''}</div>
                    </div>
                    ${n.content?`<div class="note-content">${escapeHtml(n.content).substring(0,200)}${n.content.length>200?'...':''}</div>`:''}
                </div>
            `).join('');
        }

        // ===== PROJECT FILES =====
        async function loadProjectFiles() {
            try {
                const resp = await fetch(`${API_BASE}/projects/${projectId}/files`);
                const data = await resp.json();
                renderFiles(data);
            } catch (e) {
                console.error('Error loading files:', e);
                const el = document.getElementById('files-list');
                if (el) el.innerHTML = '<div class="empty-section">Erro ao carregar arquivos</div>';
            }
        }

        function renderFiles(data) {
            const section = document.getElementById('files-section');
            const container = document.getElementById('files-list');
            const statusEl = document.getElementById('files-status');
            if (!section || !container || !statusEl) return;

            const files = data.exists ? (data.files || []).filter(f => f.name !== 'manifest.json') : [];

            // Hide entire section if no real files
            if (files.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = '';
            statusEl.textContent = `${files.length} arquivo${files.length > 1 ? 's' : ''}`;
            const icons = { epic:'üìú', draft:'‚úèÔ∏è', doc:'üìÑ', note:'üìù', file:'üìÅ' };
            const labels = { epic:'Epico Principal', draft:'Rascunho', doc:'Documento', note:'Nota', file:'Arquivo' };

            container.innerHTML = files.map(file => {
                const fd = extractDateFromFilename(file.name);
                const dateDisplay = fd ? formatMeetingDate(fd) : 'Atualizado ' + formatTimeAgo(new Date(file.modified * 1000));
                return `<div class="file-item type-${file.type}" onclick="openFile('${data.slug}/${file.path}')">
                    <span class="file-icon">${icons[file.type]||'üìÑ'}</span>
                    <div class="file-info">
                        <div class="file-name">${file.name.replace('.md','').replace(/^\d{4}-\d{2}-\d{2}-/,'')}</div>
                        <div class="file-meta">${labels[file.type]||'Arquivo'} ‚Ä¢ ${dateDisplay}</div>
                    </div>
                </div>`;
            }).join('');
        }

        async function openFile(filePath) {
            try {
                const resp = await fetch(`${API_BASE}/projects/files/${filePath}`);
                const data = await resp.json();
                if (data.content) showPreview(filePath.split('/').pop().replace('.md',''), data.content);
            } catch (e) { console.error(e); alert('Erro ao carregar arquivo'); }
        }

        function showPreview(title, content) {
            currentPreviewTitle = title;
            currentPreviewContent = content;
            const titleEl = document.getElementById('preview-title');
            if (titleEl) titleEl.textContent = 'üìÑ ' + title;
            const previewEl = document.getElementById('doc-preview');
            if (previewEl) previewEl.innerHTML = marked.parse(content);
            const section = document.getElementById('doc-preview-section');
            if (section) { section.style.display = 'block'; section.scrollIntoView({ behavior: 'smooth' }); }
        }

        function closePreview() {
            const s1 = document.getElementById('doc-preview-section');
            const s2 = document.getElementById('work-doc-preview-section');
            if (s1) s1.style.display = 'none';
            if (s2) s2.style.display = 'none';
        }

        function openFullscreen() {
            document.getElementById('fullscreen-title').textContent = currentPreviewTitle;
            document.getElementById('fullscreen-content').innerHTML = marked.parse(currentPreviewContent);
            document.getElementById('fullscreen-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFullscreen() {
            document.getElementById('fullscreen-overlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ===== FORM ACTIONS =====
        function toggleAddTask() { document.getElementById('add-task-form').classList.toggle('active'); }
        function toggleAddDoc() { document.getElementById('add-doc-form').classList.toggle('active'); }
        function toggleAddNote() { document.getElementById('add-note-form').classList.toggle('active'); }

        async function addTask() {
            const title = document.getElementById('new-task-title').value.trim();
            if (!title) return;
            await fetch(`${API_BASE}/tasks`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title, priority: document.getElementById('new-task-priority').value, project_id: parseInt(projectId) }) });
            document.getElementById('new-task-title').value = '';
            toggleAddTask();
            loadProjectWithWorkCheck();
        }

        async function toggleTask(taskId, currentStatus) {
            await fetch(`${API_BASE}/tasks/${taskId}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ status: currentStatus === 'done' ? 'todo' : 'done' }) });
            loadProjectWithWorkCheck();
        }

        async function deleteTask(taskId) {
            if (!confirm('Deletar tarefa?')) return;
            await fetch(`${API_BASE}/tasks/${taskId}`, { method: 'DELETE' });
            loadProjectWithWorkCheck();
        }

        async function addDoc() {
            const title = document.getElementById('new-doc-title').value.trim();
            if (!title) return;
            const url = document.getElementById('new-doc-url').value.trim();
            const docType = document.getElementById('new-doc-type').value;
            const description = document.getElementById('new-doc-description').value.trim();
            let apiUrl = `${API_BASE}/projects/${projectId}/docs?title=${encodeURIComponent(title)}&doc_type=${docType}`;
            if (url) apiUrl += `&url=${encodeURIComponent(url)}`;
            if (description) apiUrl += `&description=${encodeURIComponent(description)}`;
            await fetch(apiUrl, { method: 'POST' });
            document.getElementById('new-doc-title').value = '';
            document.getElementById('new-doc-url').value = '';
            document.getElementById('new-doc-description').value = '';
            toggleAddDoc();
            loadProjectWithWorkCheck();
        }

        async function deleteDoc(docId) {
            if (!confirm('Remover documento?')) return;
            await fetch(`${API_BASE}/projects/${projectId}/docs/${docId}`, { method: 'DELETE' });
            loadProjectWithWorkCheck();
        }

        async function addNote() {
            const title = document.getElementById('new-note-title').value.trim();
            if (!title) return;
            await fetch(`${API_BASE}/notes`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title, content: document.getElementById('new-note-content').value, project_id: parseInt(projectId) }) });
            document.getElementById('new-note-title').value = '';
            document.getElementById('new-note-content').value = '';
            toggleAddNote();
            loadProjectWithWorkCheck();
        }

        // ===== COLLAPSIBLE SECTIONS =====
        function toggleCollapsible(toggleEl) {
            const section = toggleEl.closest('.collapsible-section');
            const body = section.querySelector('.collapsible-body');
            const indicator = section.querySelector('.collapse-indicator');
            const isOpen = body.classList.contains('open');
            if (isOpen) {
                body.classList.remove('open');
                indicator.classList.remove('open');
                toggleEl.setAttribute('aria-expanded', 'false');
            } else {
                body.classList.add('open');
                indicator.classList.add('open');
                toggleEl.setAttribute('aria-expanded', 'true');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.collapsible-toggle').forEach(toggle => {
                const body = toggle.nextElementSibling;
                const isOpen = body && body.classList.contains('open');
                toggle.setAttribute('role', 'button');
                toggle.setAttribute('tabindex', '0');
                toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                if (body && body.id) toggle.setAttribute('aria-controls', body.id);
                toggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCollapsible(toggle); }
                });
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('fullscreen-overlay').classList.contains('active')) closeFullscreen();
                else closePreview();
            }
            if ((e.key === 'f' || e.key === 'F') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                const docSection = document.getElementById('doc-preview-section');
                const workSection = document.getElementById('work-doc-preview-section');
                if ((docSection && docSection.style.display !== 'none') || (workSection && workSection.style.display !== 'none')) {
                    if (!document.getElementById('fullscreen-overlay').classList.contains('active')) openFullscreen();
                }
            }
        });

        // ===== START =====
        loadProjectWithWorkCheck();
    </script>
    <script src="js/mobile-nav.js?v=7"></script>
</body>
</html>
