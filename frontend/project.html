<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d1117">
    <title>Projeto - Centro de Controle</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="css/style.css?v=26">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        if (!sessionStorage.getItem('auth_token')) {
            window.location.href = 'login';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1 class="logo">Centro de Controle</h1>
            <nav class="header-nav">
                <a href="./" class="nav-link" aria-label="Dashboard">Dashboard</a>
                <a href="mba" class="nav-link" aria-label="MBA">MBA</a>
                <a href="work" class="nav-link" aria-label="Work Status">Work</a>
                <a href="files" class="nav-link" aria-label="Arquivos">Arquivos</a>
                <a href="observability" class="nav-link" aria-label="Observability">Observability</a>
            </nav>
            <div class="header-actions"></div>
        </div>
    </header>

    <main class="main-content" style="display: block;">

        <!-- ===== HERO CARD ===== -->
        <div class="proj-hero" id="proj-hero">
            <div class="ph-top-row">
                <a href="./" class="ph-back" id="back-btn">‚Üê Dashboard</a>
                <div class="ph-health" id="hero-health" style="display:none;"></div>
            </div>
            <div class="ph-main-row">
                <h1 id="project-name" class="ph-title">Carregando...</h1>
                <div class="ph-right" id="ph-right">
                    <div class="ph-sprint-wrap" id="ph-sprint-wrap" style="display:none;">
                        <button class="ph-sprint-btn" id="ph-sprint-btn" aria-expanded="false"></button>
                        <div class="ph-sprint-drawer" id="ph-sprint-drawer"></div>
                    </div>
                </div>
            </div>
            <!-- Non-work meta (shown for MBA/regular projects) -->
            <div class="ph-meta" id="ph-meta-nonwork" style="display:none;">
                <span id="project-category"></span>
                <span id="project-status" class="badge"></span>
                <span id="project-priority" class="badge" style="display:none;"></span>
                <p id="project-description" class="ph-desc"></p>
            </div>
            <!-- Project Switcher (work projects only) -->
            <nav class="ph-switcher" id="ph-switcher" style="display:none;" aria-label="Switch project"></nav>
            <div class="proj-hero-chips" id="hero-chips" style="display:none;"></div>
        </div>

        <!-- ===== PROGRESS BAR (non-work only, hidden by default) ===== -->
        <div class="project-progress-large" id="progress-section" style="display: none;">
            <div class="progress-bar-large">
                <div class="progress-fill-large" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-label">
                <span>Progresso</span>
                <span id="progress-text">0%</span>
            </div>
        </div>

        <!-- ===== STAT CARDS (non-work only, hidden if all zeros) ===== -->
        <div class="project-stats" id="project-stats" style="display: none;">
            <div class="stat-card">
                <div class="number" id="stat-tasks-todo">0</div>
                <div class="label">A Fazer</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-tasks-doing">0</div>
                <div class="label">Fazendo</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-tasks-done">0</div>
                <div class="label">Feito</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-notes">0</div>
                <div class="label">Notas</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-docs">0</div>
                <div class="label">Docs</div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- WORK PROJECT VIEW (Spatial Status Page)     -->
        <!-- ========================================== -->
        <div id="work-project-view" style="display:none;">

            <!-- TAB BAR -->
            <nav class="sp-tabs" role="tablist" aria-label="Project sections">
                <button class="sp-tab sp-tab--active" role="tab" aria-selected="true" aria-controls="tab-overview" id="tab-btn-overview" data-tab="overview">Overview</button>
                <button class="sp-tab" role="tab" aria-selected="false" aria-controls="tab-meetings" id="tab-btn-meetings" data-tab="meetings">Meetings <span class="sp-tab-badge" id="tab-meetings-badge"></span></button>
                <button class="sp-tab" role="tab" aria-selected="false" aria-controls="tab-docs" id="tab-btn-docs" data-tab="docs">Docs & Knowledge <span class="sp-tab-badge" id="tab-docs-badge"></span></button>
            </nav>

            <!-- ===== OVERVIEW TAB ===== -->
            <div class="sp-panel" id="tab-overview" role="tabpanel" aria-labelledby="tab-btn-overview">

                <!-- This Week Meetings (compact row above the brief) -->
                <div class="sp-week-bar" id="sp-week-bar" style="display:none;">
                    <span class="sp-week-bar-label" id="sp-week-label"></span>
                    <div class="sp-week-bar-list" id="sp-week-list"></div>
                </div>

                <!-- Executive Brief v2 -->
                <div class="eb-card" id="eb-card">
                    <div class="eb-header">
                        <h3 class="eb-title">Executive Brief</h3>
                        <span class="eb-updated" id="eb-updated"></span>
                    </div>

                    <!-- Status -->
                    <div class="eb-section" id="eb-status-section">
                        <h4 class="eb-section-title">Status</h4>
                        <div class="eb-status-text" id="eb-status-text">Loading...</div>
                    </div>

                    <!-- Important Dates -->
                    <div class="eb-section" id="eb-dates-section" style="display:none;">
                        <h4 class="eb-section-title">Important Dates</h4>
                        <div class="eb-dates-list" id="eb-dates-list"></div>
                    </div>

                    <!-- Last Meetings (horizontal tabs) -->
                    <div class="eb-section" id="eb-meetings-section" style="display:none;">
                        <div class="eb-section-header">
                            <h4 class="eb-section-title">Last Meetings</h4>
                            <button class="eb-link-btn" id="eb-meetings-more" onclick="switchTab('meetings')">Ver mais &rarr;</button>
                        </div>
                        <div class="eb-meeting-tabs" id="eb-meeting-tabs"></div>
                        <div class="eb-meeting-detail" id="eb-meeting-detail"></div>
                    </div>

                    <!-- Decisions -->
                    <div class="eb-section" id="eb-decisions-section" style="display:none;">
                        <h4 class="eb-section-title">Decisions</h4>
                        <ul class="eb-list eb-list--indigo" id="eb-decisions-list"></ul>
                    </div>

                    <!-- To-dos (LEMBRETES style) -->
                    <div class="eb-section" id="eb-todos-section" style="display:none;">
                        <h4 class="eb-section-title">To-Dos</h4>
                        <div class="eb-todos-list" id="eb-todos-list"></div>
                    </div>

                    <!-- Upcoming Meetings -->
                    <div class="eb-section" id="eb-upcoming-section" style="display:none;">
                        <h4 class="eb-section-title">Upcoming Meetings</h4>
                        <div class="eb-upcoming-list" id="eb-upcoming-list"></div>
                    </div>

                    <!-- Key People -->
                    <div class="eb-section" id="eb-people-section" style="display:none;">
                        <h4 class="eb-section-title">Key People</h4>
                        <div class="eb-people" id="eb-people-list"></div>
                    </div>
                </div>
            </div>

            <!-- ===== MEETINGS TAB ===== -->
            <div class="sp-panel sp-panel--hidden" id="tab-meetings" role="tabpanel" aria-labelledby="tab-btn-meetings">
                <!-- Upcoming meetings prep -->
                <div class="mt-upcoming" id="mt-upcoming" style="display:none;"></div>
                <!-- Key Insights from exec brief -->
                <div class="mt-insights" id="mt-insights" style="display:none;">
                    <h4 class="mt-insights-title">Key Insights</h4>
                    <div class="mt-insights-list" id="mt-insights-list"></div>
                </div>
                <!-- Timeline -->
                <div class="sp-timeline" id="sp-timeline">
                    <div class="sp-empty-state">Loading meetings...</div>
                </div>
            </div>

            <!-- ===== DOCS & KNOWLEDGE TAB ===== -->
            <div class="sp-panel sp-panel--hidden" id="tab-docs" role="tabpanel" aria-labelledby="tab-btn-docs">
                <!-- Project Identity -->
                <div class="sp-identity" id="sp-identity" style="display:none;">
                    <div class="sp-id-card" id="sp-id-definition" style="display:none;">
                        <h4 class="sp-id-label">Definition</h4>
                        <p class="sp-id-text" id="sp-id-def-text"></p>
                    </div>
                    <div class="sp-id-card" id="sp-id-context" style="display:none;">
                        <h4 class="sp-id-label">Context</h4>
                        <p class="sp-id-text" id="sp-id-ctx-text"></p>
                    </div>
                    <div class="sp-id-card" id="sp-id-status" style="display:none;">
                        <h4 class="sp-id-label">Current Status</h4>
                        <p class="sp-id-text" id="sp-id-st-text"></p>
                    </div>
                </div>

                <!-- Documentation List -->
                <div class="dl-section" id="dl-docs-section">
                    <h3 class="dl-heading">Documentation <span class="dl-count" id="dl-docs-count"></span></h3>
                    <div class="dl-list" id="dl-docs-list">
                        <div class="sp-empty-state">Loading...</div>
                    </div>
                </div>

                <!-- Cases -->
                <div class="dl-section" id="dl-cases-section" style="display:none;">
                    <h3 class="dl-heading">Cases</h3>
                    <div class="dl-list" id="dl-cases-list"></div>
                </div>
            </div>

            <!-- Doc Preview (shared for work) -->
            <section class="card" id="work-doc-preview-section" style="display:none; margin-bottom: var(--spacing-lg);">
                <div class="section-header">
                    <h2 id="work-preview-title">Documento</h2>
                    <div class="preview-actions">
                        <button class="btn-icon" onclick="openFullscreen()" title="Expandir (F)">Expandir</button>
                        <button class="btn-primary" onclick="closePreview()">Fechar</button>
                    </div>
                </div>
                <div class="doc-preview-wrapper" id="work-doc-preview-wrapper">
                    <div id="work-doc-preview" class="doc-preview-content"></div>
                </div>
            </section>
        </div>

        <!-- ========================================== -->
        <!-- MBA PROJECT VIEW                           -->
        <!-- ========================================== -->
        <div id="mba-project-view" style="display:none;">
            <section class="card" style="margin-bottom: var(--spacing-lg);">
                <div class="section-header">
                    <h2>üìÖ Proximos Prazos</h2>
                </div>
                <div id="mba-deadlines-list">
                    <div class="empty-section">Carregando...</div>
                </div>
            </section>
            <section class="card" style="margin-bottom: var(--spacing-lg);">
                <div class="section-header">
                    <h2>üìã Atividades Pendentes</h2>
                    <span class="badge badge-active" id="mba-pending-count" style="font-size:0.7rem;"></span>
                </div>
                <div id="mba-activities-list">
                    <div class="empty-section">Carregando...</div>
                </div>
            </section>
        </div>

        <!-- ========================================== -->
        <!-- REGULAR PROJECT VIEW                       -->
        <!-- ========================================== -->
        <div class="project-sections" id="regular-project-view" style="display:none;">
            <section class="card">
                <div class="section-header">
                    <h2>üìã Tarefas</h2>
                    <button class="btn-primary" onclick="toggleAddTask()">+ Nova Tarefa</button>
                </div>
                <div class="add-form" id="add-task-form">
                    <input type="text" id="new-task-title" placeholder="Titulo da tarefa">
                    <div class="form-row">
                        <select id="new-task-priority" style="flex:1;">
                            <option value="low">Baixa</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">Alta</option>
                        </select>
                        <button class="btn-primary" onclick="addTask()">Adicionar</button>
                    </div>
                </div>
                <div id="tasks-list">
                    <div class="empty-section">Carregando...</div>
                </div>
            </section>

            <section class="card" id="files-section" style="display:none;">
                <div class="section-header">
                    <h2>üìÇ Arquivos da Nova</h2>
                    <span class="badge badge-active" id="files-status" style="font-size:0.7rem;"></span>
                </div>
                <div id="files-list">
                    <div class="empty-section">Escaneando...</div>
                </div>
            </section>

            <section class="card" id="doc-preview-section" style="display:none;">
                <div class="section-header">
                    <h2 id="preview-title">üìÑ Documento</h2>
                    <div class="preview-actions">
                        <button class="btn-icon" onclick="openFullscreen()" title="Expandir (F)">Expandir</button>
                        <button class="btn-primary" onclick="closePreview()">Fechar</button>
                    </div>
                </div>
                <div class="doc-preview-wrapper" id="doc-preview-wrapper">
                    <div id="doc-preview" class="doc-preview-content"></div>
                </div>
            </section>

            <section class="card">
                <div class="section-header">
                    <h2>üìÑ Documentos</h2>
                    <button class="btn-primary" onclick="toggleAddDoc()">+ Adicionar</button>
                </div>
                <div class="add-form" id="add-doc-form">
                    <input type="text" id="new-doc-title" placeholder="Nome do documento">
                    <input type="url" id="new-doc-url" placeholder="URL (opcional)">
                    <textarea id="new-doc-description" rows="2" placeholder="Descricao/Notas do documento..." class="add-form-textarea"></textarea>
                    <div class="form-row">
                        <select id="new-doc-type" style="flex:1;">
                            <option value="doc">üìÑ Documento</option>
                            <option value="link">üîó Link</option>
                            <option value="notion">üìù Notion</option>
                            <option value="figma">üé® Figma</option>
                            <option value="github">üíª GitHub</option>
                            <option value="jira">üìã Jira</option>
                            <option value="pdf">üìï PDF</option>
                            <option value="sheet">üìä Planilha</option>
                            <option value="slides">üìΩÔ∏è Apresentacao</option>
                        </select>
                        <button class="btn-primary" onclick="addDoc()">Adicionar</button>
                    </div>
                </div>
                <div id="docs-list">
                    <div class="empty-section">Carregando...</div>
                </div>
            </section>

            <section class="card">
                <div class="section-header">
                    <h2>üóíÔ∏è Notas</h2>
                    <button class="btn-primary" onclick="toggleAddNote()">+ Nova Nota</button>
                </div>
                <div class="add-form" id="add-note-form">
                    <input type="text" id="new-note-title" placeholder="Titulo da nota">
                    <textarea id="new-note-content" rows="3" placeholder="Conteudo..."></textarea>
                    <button class="btn-primary" onclick="addNote()">Adicionar</button>
                </div>
                <div id="notes-list">
                    <div class="empty-section">Carregando...</div>
                </div>
            </section>
        </div>

        <!-- FULLSCREEN OVERLAY (shared) -->
        <div class="fullscreen-overlay" id="fullscreen-overlay">
            <div class="fullscreen-content">
                <div class="fullscreen-header">
                    <h2 id="fullscreen-title">Documento</h2>
                    <button class="fullscreen-close" onclick="closeFullscreen()">Fechar (Esc)</button>
                </div>
                <div id="fullscreen-content" class="doc-preview-content" style="max-height: none;"></div>
            </div>
        </div>
    </main>

    <script>
        const isGitHubPages = window.location.hostname.includes('github.io');
        const API_BASE = isGitHubPages
            ? 'https://srv1315519.hstgr.cloud/api'
            : '/api';
        let projectId = null;
        let projectData = null;
        let workProjectData = null;
        let currentWorkSlug = null;
        let currentPreviewTitle = '';
        let currentPreviewContent = '';

        const urlParams = new URLSearchParams(window.location.search);
        projectId = urlParams.get('id');
        if (!projectId) window.location.href = 'index.html';

        // ===== WORK PROJECT SLUG MAPPING =====
        const WORK_PROJECT_SLUGS = {
            '3TPM': '3tpm', '3tpm': '3tpm',
            'Catalog & 3TPM': '3tpm', 'Catalog Admin': '3tpm', 'Catalog': '3tpm', 'CATALOG-ADMIN': '3tpm',
            'Company Store': 'company-store', 'Company & Store': 'company-store', 'COMPANY-STORE': 'company-store',
            'Content': 'cms-dam', 'Content (CMS + DAM)': 'cms-dam', 'CMS DAM': 'cms-dam', 'CMS-DAM': 'cms-dam',
            'CMS': 'cms-dam', 'DAM': 'cms-dam', 'DAM - Documenta√ß√£o': 'cms-dam', 'CMS / DAM': 'cms-dam',
            'POCs IA': 'pocs-ia', 'POCS-IA': 'pocs-ia',
            'Autonomy': 'autonomy', 'Autonomy & Automation': 'autonomy', 'AUTONOMY-AUTOMATION': 'autonomy'
        };

        function isWorkProject(name, cat) { return cat === 'trabalho' || !!WORK_PROJECT_SLUGS[name]; }
        function getWorkSlug(name) { return WORK_PROJECT_SLUGS[name] || name.toLowerCase().replace(/\s+/g, '-'); }
        function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function formatMeetingDate(s) {
            if (!s) return '';
            const [y,m,d] = s.split('-');
            const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            return `${parseInt(d)} ${months[parseInt(m)-1]}`;
        }
        function formatTimeAgo(date) {
            const diff = Math.floor((new Date() - date) / 1000);
            if (diff < 60) return 'agora';
            if (diff < 3600) return `ha ${Math.floor(diff/60)} min`;
            if (diff < 86400) return `ha ${Math.floor(diff/3600)}h`;
            if (diff < 604800) return `ha ${Math.floor(diff/86400)} dias`;
            return date.toLocaleDateString('pt-BR');
        }
        function extractDateFromFilename(f) { const m = f.match(/^(\d{4}-\d{2}-\d{2})-/); return m ? m[1] : null; }

        // ===== MAIN ENTRY POINT =====
        async function loadProjectWithWorkCheck() {
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}/full`);
                if (!response.ok) throw new Error('Projeto nao encontrado');
                projectData = await response.json();
                const { project } = projectData;

                renderHeroCard(project);

                if (isWorkProject(project.name, project.category)) {
                    const ok = await loadWorkProject(project.name);
                    if (ok) return;
                }

                if (project.category === 'mba') {
                    renderMbaView(project);
                    return;
                }

                renderRegularProject(project);
            } catch (error) {
                console.error(error);
                document.getElementById('project-name').textContent = 'Projeto nao encontrado';
            }
        }

        // ===== HERO CARD =====
        // DB project ID -> work slug lookup (for project switcher)
        const WORK_PROJECT_DB = [
            { id: 1, name: 'Catalog', slug: '3tpm' },
            { id: 2, name: 'CMS', slug: 'cms-dam' },
            { id: 3, name: 'DAM', slug: 'cms-dam' },
        ];

        function renderHeroCard(project) {
            document.title = `${project.name} - Centro de Controle`;
            document.getElementById('project-name').textContent = project.name;

            const backBtn = document.getElementById('back-btn');
            const isWork = isWorkProject(project.name, project.category);
            if (isWork) {
                backBtn.href = 'work';
                backBtn.textContent = '‚Üê Work Status';
            } else if (project.category === 'mba') {
                backBtn.href = 'mba';
                backBtn.textContent = '‚Üê MBA';
            }

            if (isWork) {
                // Work project: show project switcher, hide non-work meta
                document.getElementById('ph-meta-nonwork').style.display = 'none';
                renderProjectSwitcher(project);
            } else {
                // Non-work: show traditional meta
                const meta = document.getElementById('ph-meta-nonwork');
                meta.style.display = '';
                const catIcons = { trabalho: 'üíº', mba: 'üéì', pessoal: 'üë§', familia: 'üë®‚Äçüë©‚Äçüëß' };
                document.getElementById('project-category').textContent =
                    (catIcons[project.category] || 'üìÅ') + ' ' + (project.category || 'Geral');
                const statusEl = document.getElementById('project-status');
                statusEl.textContent = project.status === 'active' ? 'Ativo' : project.status === 'paused' ? 'Pausado' : 'Concluido';
                statusEl.className = 'badge ' + (project.status === 'active' ? 'badge-active' : 'badge-paused');
                const prioEl = document.getElementById('project-priority');
                if (project.priority === 'high') { prioEl.textContent = 'üî• Alta Prioridade'; prioEl.className = 'badge badge-high'; prioEl.style.display = 'inline'; }
                document.getElementById('project-description').textContent = project.description || '';
            }
        }

        function renderProjectSwitcher(currentProject) {
            const nav = document.getElementById('ph-switcher');
            nav.style.display = '';
            const currentId = parseInt(projectId);
            nav.innerHTML = WORK_PROJECT_DB
                .filter(p => p.id !== currentId)
                .map(p => `<a href="project?id=${p.id}" class="ph-switch-pill">${escapeHtml(p.name)}</a>`)
                .join('');
        }

        function setHeroHealth(health, reason) {
            const el = document.getElementById('hero-health');
            const colors = { green: '#22c55e', yellow: '#eab308', red: '#ef4444' };
            const labels = { green: 'On Track', yellow: 'Attention', red: 'Critical' };
            const c = colors[health] || colors.green;
            el.style.display = '';
            el.innerHTML = `<span class="ph-health-badge" style="background:${c}18;color:${c};border:1px solid ${c}33;">
                <span class="ph-dot" style="background:${c};"></span>${labels[health] || health}${reason ? ` ‚Äî ${escapeHtml(reason)}` : ''}
            </span>`;
        }

        function setHeroSprint(conf) {
            if (!conf || !conf.current_sprint) return;
            const wrap = document.getElementById('ph-sprint-wrap');
            const btn = document.getElementById('ph-sprint-btn');
            const drawer = document.getElementById('ph-sprint-drawer');
            wrap.style.display = '';
            btn.textContent = conf.current_sprint + ' ‚ñæ';
            btn.onclick = () => {
                const open = drawer.classList.toggle('ph-sprint-drawer--open');
                btn.setAttribute('aria-expanded', open);
            };
            const rows = [];
            if (conf.initiatives) rows.push(`<div class="ph-sd-row"><span class="ph-sd-label">Initiatives</span><span class="ph-sd-val">${conf.initiatives}</span></div>`);
            if (conf.epics_open || conf.epics_closed) rows.push(`<div class="ph-sd-row"><span class="ph-sd-label">Epics</span><span class="ph-sd-val">${conf.epics_open || 0} open${conf.epics_closed ? `, ${conf.epics_closed} closed` : ''}</span></div>`);
            if (conf.risks) rows.push(`<div class="ph-sd-row ph-sd-row--red"><span class="ph-sd-label">Risks</span><span class="ph-sd-val">${conf.risks}</span></div>`);
            if (conf.bugs) rows.push(`<div class="ph-sd-row ph-sd-row--red"><span class="ph-sd-label">Bugs</span><span class="ph-sd-val">${conf.bugs}</span></div>`);
            drawer.innerHTML = rows.join('');
        }

        function setHeroChips(chips) {
            const el = document.getElementById('hero-chips');
            if (chips.length > 0) {
                el.innerHTML = chips.map(c => `<span class="header-chip${c.muted?' header-chip-muted':''}">${c.text}</span>`).join('');
                el.style.display = '';
            }
        }

        // ===== WORK PROJECT =====
        async function loadWorkProject(name) {
            const slug = getWorkSlug(name);
            currentWorkSlug = slug;
            try {
                const resp = await fetch(`${API_BASE}/work-projects/${slug}`);
                if (!resp.ok) return false;
                workProjectData = await resp.json();
                renderWorkView(workProjectData);
                return true;
            } catch (e) { console.error(e); return false; }
        }

        // ===== TAB SYSTEM =====
        let _workData = null;
        let _reportCard = null;

        function initTabs() {
            document.querySelectorAll('.sp-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
                tab.addEventListener('keydown', (e) => {
                    const tabs = [...document.querySelectorAll('.sp-tab')];
                    const idx = tabs.indexOf(tab);
                    if (e.key === 'ArrowRight') { e.preventDefault(); tabs[(idx + 1) % tabs.length].focus(); tabs[(idx + 1) % tabs.length].click(); }
                    if (e.key === 'ArrowLeft') { e.preventDefault(); tabs[(idx - 1 + tabs.length) % tabs.length].focus(); tabs[(idx - 1 + tabs.length) % tabs.length].click(); }
                });
            });
            // Restore last tab from hash or sessionStorage
            const hash = window.location.hash.replace('#', '');
            const saved = sessionStorage.getItem(`sp-tab-${currentWorkSlug}`);
            if (hash && document.getElementById(`tab-${hash}`)) switchTab(hash);
            else if (saved && document.getElementById(`tab-${saved}`)) switchTab(saved);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.sp-tab').forEach(t => { t.classList.remove('sp-tab--active'); t.setAttribute('aria-selected', 'false'); });
            document.querySelectorAll('.sp-panel').forEach(p => p.classList.add('sp-panel--hidden'));
            const btn = document.getElementById(`tab-btn-${tabId}`);
            const panel = document.getElementById(`tab-${tabId}`);
            if (btn) { btn.classList.add('sp-tab--active'); btn.setAttribute('aria-selected', 'true'); }
            if (panel) panel.classList.remove('sp-panel--hidden');
            window.location.hash = tabId;
            if (currentWorkSlug) sessionStorage.setItem(`sp-tab-${currentWorkSlug}`, tabId);
        }

        // ===== WORK PROJECT RENDERING =====
        function renderWorkView(data) {
            document.getElementById('work-project-view').style.display = 'block';
            document.getElementById('regular-project-view').style.display = 'none';
            document.getElementById('mba-project-view').style.display = 'none';
            _workData = data;

            // Tab badges
            const sCount = data.sections ? data.sections.length : 0;
            const mCount = data.meeting_notes ? data.meeting_notes.length : 0;
            const mBadge = document.getElementById('tab-meetings-badge');
            const dBadge = document.getElementById('tab-docs-badge');
            if (mCount > 0) mBadge.textContent = mCount;
            if (sCount > 0) dBadge.textContent = sCount;

            // Render Docs tab content (static data, always ready)
            renderDocsTab(data);

            // Init tabs
            initTabs();

            // Load report card (async enrichment)
            if (currentWorkSlug) loadReportCard(currentWorkSlug);
        }

        async function loadReportCard(slug) {
            try {
                const rc = await fetch(`${API_BASE}/work-projects/${slug}/report-card`).then(r => r.ok ? r.json() : null);
                if (!rc) return;
                _reportCard = rc;

                // Hero enrichments
                setHeroHealth(rc.health, rc.health_reason);
                setHeroSprint(rc.confluence);

                // Enrich meetings badge
                const weekMeetCount = (rc.meetings_this_week || []).length;
                if (weekMeetCount > 0) {
                    const mBadge = document.getElementById('tab-meetings-badge');
                    if (!mBadge.textContent) mBadge.textContent = weekMeetCount;
                }

                renderOverviewTab(rc);
                renderMeetingsTab(rc);
            } catch (e) { console.error('Error loading report card:', e); }
        }

        // ===== OVERVIEW TAB (executive brief v2) =====
        function renderOverviewTab(rc) {
            const brief = rc.executive_brief || {};
            const has = (arr) => Array.isArray(arr) && arr.length > 0;

            // This week meetings bar
            const weekMeetings = rc.meetings_this_week || [];
            if (weekMeetings.length > 0) {
                document.getElementById('sp-week-bar').style.display = '';
                document.getElementById('sp-week-label').textContent = rc.week ? `This Week (${rc.week})` : 'This Week';
                document.getElementById('sp-week-list').innerHTML = weekMeetings.slice(0, 5).map(m =>
                    `<span class="sp-week-pill"><span class="sp-week-pill-date">${formatMeetingDate(m.date)}</span> ${escapeHtml(m.title)}</span>`
                ).join('');
            }

            // Updated timestamp
            if (brief.updated_at) {
                const ago = timeAgo(brief.updated_at);
                document.getElementById('eb-updated').textContent = `Updated ${ago}`;
            }

            // Status
            const statusEl = document.getElementById('eb-status-text');
            if (brief.status_summary) {
                statusEl.innerHTML = marked.parse(brief.status_summary);
            } else if (brief.executive_summary) {
                statusEl.innerHTML = marked.parse(brief.executive_summary);
            } else {
                statusEl.innerHTML = '<span class="sp-text-muted">No status available. Run /update-executive-briefs to populate.</span>';
            }

            // Important Dates
            if (has(brief.important_dates)) {
                document.getElementById('eb-dates-section').style.display = '';
                document.getElementById('eb-dates-list').innerHTML = brief.important_dates.map(d =>
                    `<div class="eb-date-item">
                        <span class="eb-date-badge">${escapeHtml(formatDateShort(d.date))}</span>
                        <span class="eb-date-label">${escapeHtml(d.label)}</span>
                        ${d.type ? `<span class="eb-date-type">${escapeHtml(d.type)}</span>` : ''}
                    </div>`
                ).join('');
            }

            // Last Meetings (horizontal tabs)
            if (has(brief.recent_meetings)) {
                document.getElementById('eb-meetings-section').style.display = '';
                window._ebMeetings = brief.recent_meetings.slice(0, 5);
                const tabsEl = document.getElementById('eb-meeting-tabs');
                tabsEl.innerHTML = window._ebMeetings.map((m, i) =>
                    `<button class="eb-meeting-tab${i === 0 ? ' eb-meeting-tab--active' : ''}" data-idx="${i}" onclick="selectMeetingTab(${i})">
                        <span class="eb-mt-date">${escapeHtml(formatDateShort(m.date))}</span>
                        <span class="eb-mt-title">${escapeHtml(m.title)}</span>
                    </button>`
                ).join('');
                selectMeetingTab(0);
            }

            // Decisions
            if (has(brief.decisions)) {
                document.getElementById('eb-decisions-section').style.display = '';
                document.getElementById('eb-decisions-list').innerHTML = brief.decisions.map(d =>
                    `<li class="eb-list-item eb-list-item--indigo">
                        <span class="eb-decision-date">${escapeHtml(formatDateShort(d.date))}</span>
                        ${escapeHtml(d.text)}
                        ${d.meeting_title ? `<span class="eb-decision-source">${escapeHtml(d.meeting_title)}</span>` : ''}
                    </li>`
                ).join('');
            }

            // To-Dos (LEMBRETES style with tags)
            if (has(brief.todos)) {
                document.getElementById('eb-todos-section').style.display = '';
                document.getElementById('eb-todos-list').innerHTML = brief.todos.map(t => {
                    const doneClass = t.is_done ? ' brief-item-completed' : '';
                    const accentClass = t.priority === 'high' ? ' brief-action-important' : t.priority === 'urgent' ? ' eb-todo-urgent' : ' brief-action-reminder';
                    const tags = (t.tags || []).map(tag =>
                        `<span class="brief-action-deadline">${escapeHtml(tag)}</span>`
                    ).join('');
                    const priorityTag = (!t.tags || t.tags.length === 0) && t.priority
                        ? `<span class="brief-action-deadline">${escapeHtml(t.priority.toUpperCase())}</span>` : '';
                    return `<div class="brief-action-item${accentClass}${doneClass}">
                        <span class="eb-todo-check${t.is_done ? ' eb-todo-check--done' : ''}">&#10003;</span>
                        <span class="brief-action-text">${escapeHtml(t.title)}</span>
                        ${tags}${priorityTag}
                    </div>`;
                }).join('');
            }

            // Upcoming Meetings
            if (has(brief.upcoming_meetings)) {
                document.getElementById('eb-upcoming-section').style.display = '';
                document.getElementById('eb-upcoming-list').innerHTML = brief.upcoming_meetings.map(m =>
                    `<div class="eb-upcoming-item">
                        <div class="eb-upcoming-header">
                            <span class="eb-upcoming-date">${escapeHtml(formatDateShort(m.date))}${m.time ? ' ' + escapeHtml(m.time) : ''}</span>
                            <span class="eb-upcoming-title">${escapeHtml(m.title)}</span>
                        </div>
                        ${m.prep_notes ? `<div class="eb-upcoming-prep">Remember: ${escapeHtml(m.prep_notes)}</div>` : ''}
                    </div>`
                ).join('');
            }

            // Key People
            if (has(brief.key_people)) {
                document.getElementById('eb-people-section').style.display = '';
                document.getElementById('eb-people-list').innerHTML = brief.key_people.map(p => {
                    const name = typeof p === 'string' ? p : p.name || '';
                    const role = typeof p === 'object' ? p.role : '';
                    const initials = name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                    return `<span class="eb-person"><span class="eb-person-avatar">${initials}</span>${escapeHtml(name)}${role ? `<span class="eb-person-role">${escapeHtml(role)}</span>` : ''}</span>`;
                }).join('');
            }
        }

        function timeAgo(dateStr) {
            const diff = Date.now() - new Date(dateStr).getTime();
            const mins = Math.floor(diff / 60000);
            if (mins < 60) return `${mins}m ago`;
            const hrs = Math.floor(mins / 60);
            if (hrs < 24) return `${hrs}h ago`;
            return `${Math.floor(hrs / 24)}d ago`;
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr + (dateStr.includes('T') ? '' : 'T00:00:00'));
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } catch { return dateStr; }
        }

        // ===== MEETING TAB SELECTION (for horizontal tabs) =====
        function selectMeetingTab(idx) {
            const meetings = window._ebMeetings || [];
            if (!meetings[idx]) return;
            document.querySelectorAll('.eb-meeting-tab').forEach(t => t.classList.remove('eb-meeting-tab--active'));
            const activeBtn = document.querySelector(`.eb-meeting-tab[data-idx="${idx}"]`);
            if (activeBtn) activeBtn.classList.add('eb-meeting-tab--active');
            renderMeetingDetail(meetings[idx]);
        }

        function renderMeetingDetail(m) {
            const el = document.getElementById('eb-meeting-detail');
            if (!el) return;
            const s = m.structured || {};
            const notionLink = m.notion_url ? `<a href="${m.notion_url}" target="_blank" class="eb-md-notion-link">Open in Notion</a>` : '';
            const peopleBadges = (s.key_people || m.people || []).map(p => {
                const name = typeof p === 'string' ? p : p.name || '';
                const role = typeof p === 'object' ? p.role || '' : '';
                const contribution = typeof p === 'object' ? p.contribution || '' : '';
                const initials = name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                const tooltip = [role, contribution].filter(Boolean).join(' ‚Äî ');
                return `<span class="eb-person eb-person--sm" title="${escapeHtml(tooltip)}"><span class="eb-person-avatar eb-person-avatar--sm">${initials}</span>${escapeHtml(name)}</span>`;
            }).join('');
            const objectivesList = (s.objectives || []).map(o => `<li>${escapeHtml(o)}</li>`).join('');
            const decisionsList = (s.decisions || []).map(d => {
                const text = typeof d === 'string' ? d : d.text || '';
                const rationale = typeof d === 'object' && d.rationale ? ` <span class="eb-md-rationale">${escapeHtml(d.rationale)}</span>` : '';
                return `<li>${escapeHtml(text)}${rationale}</li>`;
            }).join('');
            const contextHtml = s.context ? marked.parse(s.context) : '';
            const nextStepsList = (s.next_steps || []).map(ns => {
                const action = typeof ns === 'string' ? ns : ns.action || '';
                const owner = typeof ns === 'object' && ns.owner ? `<span class="brief-action-deadline">${escapeHtml(ns.owner)}</span>` : '';
                return `<div class="brief-action-item brief-action-reminder"><span class="brief-action-text">${escapeHtml(action)}</span>${owner}</div>`;
            }).join('');
            const summaryHtml = s.summary || m.brief || m.summary || '';
            const hasSections = peopleBadges || objectivesList || decisionsList || contextHtml || nextStepsList;

            el.innerHTML = `
                <h5 class="eb-md-title">${escapeHtml(m.title)}</h5>
                <div class="eb-md-meta">${escapeHtml(formatDateShort(m.date))} ${notionLink}</div>
                ${summaryHtml && !hasSections ? `<div class="eb-md-section"><div class="eb-md-content">${marked.parse(summaryHtml)}</div></div>` : ''}
                ${peopleBadges ? `<div class="eb-md-section"><div class="eb-md-label">KEY PEOPLE</div><div class="eb-md-people">${peopleBadges}</div></div>` : ''}
                ${objectivesList ? `<div class="eb-md-section"><div class="eb-md-label">OBJECTIVES</div><ul class="eb-md-list">${objectivesList}</ul></div>` : ''}
                ${decisionsList ? `<div class="eb-md-section"><div class="eb-md-label">DECISIONS</div><ul class="eb-md-list eb-md-list--indigo">${decisionsList}</ul></div>` : ''}
                ${contextHtml ? `<div class="eb-md-section"><div class="eb-md-label">CONTEXT</div><div class="eb-md-content">${contextHtml}</div></div>` : ''}
                ${nextStepsList ? `<div class="eb-md-section"><div class="eb-md-label">NEXT STEPS</div>${nextStepsList}</div>` : ''}
                ${!hasSections && !summaryHtml ? '<div class="eb-md-empty">Run /update-executive-briefs to parse structured meeting data.</div>' : ''}
            `;
        }

        // ===== MEETINGS TAB =====
        function renderMeetingsTab(rc) {
            const timeline = document.getElementById('sp-timeline');
            const weekMeetings = rc.meetings_this_week || [];
            const allMeetings = _workData ? (_workData.meeting_notes || []) : [];
            const brief = rc.executive_brief || {};
            const todayStr = new Date().toISOString().split('T')[0];

            // Key Insights from executive brief
            const recentMeetingsInsights = (brief.recent_meetings || []).filter(m => m.insight);
            if (recentMeetingsInsights.length > 0) {
                const insightsEl = document.getElementById('mt-insights');
                insightsEl.style.display = '';
                document.getElementById('mt-insights-list').innerHTML = recentMeetingsInsights.map(m =>
                    `<div class="mt-insight-item">
                        <span class="mt-insight-topic">${escapeHtml(m.title)}</span>
                        <span class="mt-insight-text">${escapeHtml(m.insight)}</span>
                    </div>`
                ).join('');
            }

            // Combine and deduplicate by title
            const seen = new Set();
            const combined = [];
            for (const m of weekMeetings) {
                const key = (m.title || '').toLowerCase();
                if (!seen.has(key)) { seen.add(key); combined.push({ title: m.title, date: m.date, summary: m.summary, source: 'week' }); }
            }
            for (const m of allMeetings) {
                const key = (m.title || '').toLowerCase();
                if (!seen.has(key)) { seen.add(key); combined.push({ title: m.title, date: m.date || extractDateFromFilename(m.file), preview: m.preview, file: m.file, source: 'notes' }); }
            }

            // Separate upcoming vs past
            const upcoming = combined.filter(m => m.date && m.date > todayStr);
            const past = combined.filter(m => !m.date || m.date <= todayStr);

            // Render upcoming meeting prep cards
            if (upcoming.length > 0) {
                const upEl = document.getElementById('mt-upcoming');
                upEl.style.display = '';
                upEl.innerHTML = upcoming.map(m => {
                    // Build prep context from brief data
                    const prepParts = [];

                    // Exec summary snippet
                    if (brief.executive_summary) {
                        const snippet = brief.executive_summary.replace(/\*\*/g, '').substring(0, 200);
                        prepParts.push(`<div class="mt-prep-context">${escapeHtml(snippet)}${brief.executive_summary.length > 200 ? '...' : ''}</div>`);
                    }

                    // Key people
                    if (brief.key_people && brief.key_people.length > 0) {
                        const peopleHtml = brief.key_people.slice(0, 6).map(p => {
                            const ini = p.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                            return `<span class="eb-person"><span class="eb-person-avatar" style="width:22px;height:22px;font-size:0.55rem;">${ini}</span>${escapeHtml(p.name)}${p.role ? `<span class="eb-person-role">${escapeHtml(p.role)}</span>` : ''}</span>`;
                        }).join('');
                        prepParts.push(`<div class="mt-prep-section"><span class="mt-prep-label">Key People</span><div class="mt-prep-people">${peopleHtml}</div></div>`);
                    }

                    // Open action items
                    if (brief.action_items && brief.action_items.length > 0) {
                        const actionsHtml = brief.action_items.slice(0, 4).map(a =>
                            `<span class="mt-prep-action">${escapeHtml(a)}</span>`
                        ).join('');
                        prepParts.push(`<div class="mt-prep-section"><span class="mt-prep-label">Open Action Items</span><div class="mt-prep-actions">${actionsHtml}</div></div>`);
                    }

                    // Relevant risks
                    if (brief.risks_blockers && brief.risks_blockers.length > 0) {
                        const risksHtml = brief.risks_blockers.slice(0, 3).map(r =>
                            `<span class="mt-prep-risk">${escapeHtml(r)}</span>`
                        ).join('');
                        prepParts.push(`<div class="mt-prep-section"><span class="mt-prep-label">Watch Out</span><div class="mt-prep-risks">${risksHtml}</div></div>`);
                    }

                    // Related docs count
                    const docCount = _workData ? (_workData.sections || []).length : 0;
                    if (docCount > 0) {
                        prepParts.push(`<div class="mt-prep-docs"><a href="#" onclick="switchTab('docs');return false;">üìÑ ${docCount} docs available for reference</a></div>`);
                    }

                    return `<div class="mt-prep-card">
                        <div class="mt-prep-header">
                            <div class="mt-prep-badge">UPCOMING</div>
                            <span class="mt-prep-date">${formatMeetingDate(m.date)}</span>
                            <span class="mt-prep-title">${escapeHtml(m.title)}</span>
                        </div>
                        <details class="mt-prep-details">
                            <summary class="mt-prep-toggle">Meeting Prep</summary>
                            <div class="mt-prep-body">${prepParts.join('')}</div>
                        </details>
                    </div>`;
                }).join('');
            }

            if (past.length === 0 && upcoming.length === 0) {
                timeline.innerHTML = '<div class="sp-empty-state">No meetings recorded yet</div>';
                return;
            }

            if (past.length === 0) {
                timeline.innerHTML = '';
                return;
            }

            // Past meetings: horizontal tabs + detail panel
            window._mtMeetings = past;
            const tabsHtml = past.map((m, i) =>
                `<button class="eb-meeting-tab${i === 0 ? ' eb-meeting-tab--active' : ''}" data-mt-idx="${i}" onclick="selectMtTab(${i})">
                    <span class="eb-mt-date">${formatMeetingDate(m.date)}</span>
                    <span class="eb-mt-title">${escapeHtml(m.title)}</span>
                </button>`
            ).join('');
            timeline.innerHTML = `
                <div class="eb-meeting-tabs">${tabsHtml}</div>
                <div class="eb-meeting-detail" id="mt-detail-panel"></div>
            `;
            if (past.length > 0) selectMtTab(0);
        }

        function selectMtTab(idx) {
            const meetings = window._mtMeetings || [];
            if (!meetings[idx]) return;
            document.querySelectorAll('[data-mt-idx]').forEach(t => t.classList.remove('eb-meeting-tab--active'));
            const btn = document.querySelector(`[data-mt-idx="${idx}"]`);
            if (btn) btn.classList.add('eb-meeting-tab--active');
            const m = meetings[idx];
            const el = document.getElementById('mt-detail-panel');
            if (!el) return;
            const s = m.structured || {};
            const notionUrl = m.notion_url || '';
            const notionLink = notionUrl ? `<a href="${notionUrl}" target="_blank" class="eb-md-notion-link">Open in Notion</a>` : '';
            const fileLink = m.file ? `<a href="#" onclick="openWorkFile('${m.file}');return false;" class="eb-md-notion-link">Open File</a>` : '';
            const peopleBadges = (s.key_people || []).map(p => {
                const name = typeof p === 'string' ? p : p.name || '';
                const initials = name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                const role = typeof p === 'object' ? p.role || '' : '';
                return `<span class="eb-person eb-person--sm" title="${escapeHtml(role)}"><span class="eb-person-avatar eb-person-avatar--sm">${initials}</span>${escapeHtml(name)}</span>`;
            }).join('');
            const objectivesList = (s.objectives || []).map(o => `<li>${escapeHtml(o)}</li>`).join('');
            const decisionsList = (s.decisions || []).map(d => {
                const text = typeof d === 'string' ? d : d.text || '';
                return `<li>${escapeHtml(text)}</li>`;
            }).join('');
            const contextHtml = s.context ? marked.parse(s.context) : '';
            const nextStepsList = (s.next_steps || []).map(ns => {
                const action = typeof ns === 'string' ? ns : ns.action || '';
                const owner = typeof ns === 'object' && ns.owner ? `<span class="brief-action-deadline">${escapeHtml(ns.owner)}</span>` : '';
                return `<div class="brief-action-item brief-action-reminder"><span class="brief-action-text">${escapeHtml(action)}</span>${owner}</div>`;
            }).join('');
            const hasSections = peopleBadges || objectivesList || decisionsList || contextHtml || nextStepsList;
            const summaryText = s.summary || m.summary || m.preview || '';
            el.innerHTML = `
                <h5 class="eb-md-title">${escapeHtml(m.title)}</h5>
                <div class="eb-md-meta">${escapeHtml(formatMeetingDate(m.date))} ${notionLink || fileLink}</div>
                ${summaryText && !hasSections ? `<div class="eb-md-section"><div class="eb-md-content">${marked.parse(summaryText)}</div></div>` : ''}
                ${peopleBadges ? `<div class="eb-md-section"><div class="eb-md-label">KEY PEOPLE</div><div class="eb-md-people">${peopleBadges}</div></div>` : ''}
                ${objectivesList ? `<div class="eb-md-section"><div class="eb-md-label">OBJECTIVES</div><ul class="eb-md-list">${objectivesList}</ul></div>` : ''}
                ${decisionsList ? `<div class="eb-md-section"><div class="eb-md-label">DECISIONS</div><ul class="eb-md-list eb-md-list--indigo">${decisionsList}</ul></div>` : ''}
                ${contextHtml ? `<div class="eb-md-section"><div class="eb-md-label">CONTEXT</div><div class="eb-md-content">${contextHtml}</div></div>` : ''}
                ${nextStepsList ? `<div class="eb-md-section"><div class="eb-md-label">NEXT STEPS</div>${nextStepsList}</div>` : ''}
                ${!hasSections && !summaryText ? '<div class="eb-md-empty">No structured content yet.</div>' : ''}
            `;
        }

        // ===== DOCS & KNOWLEDGE TAB =====
        function renderDocsTab(data) {
            // Project Identity
            const ov = data.overview || {};
            const defText = ov.definition || '', ctxText = ov.context || '', stText = ov.current_status || '';
            const hasIdentity = defText || ctxText || stText;
            if (hasIdentity) {
                document.getElementById('sp-identity').style.display = '';
                if (defText) { document.getElementById('sp-id-definition').style.display = ''; document.getElementById('sp-id-def-text').innerHTML = marked.parse(defText); }
                if (ctxText) { document.getElementById('sp-id-context').style.display = ''; document.getElementById('sp-id-ctx-text').innerHTML = marked.parse(ctxText); }
                if (stText) { document.getElementById('sp-id-status').style.display = ''; document.getElementById('sp-id-st-text').innerHTML = marked.parse(stText); }
            }

            // Documentation list
            const sections = data.sections || [];
            const docsCount = document.getElementById('dl-docs-count');
            const docsList = document.getElementById('dl-docs-list');
            const icons = { context:'üéØ', definition:'üìã', history:'üìú', architecture:'üèóÔ∏è', people:'üë•', timeline:'üìÖ', status:'üìç', roadmap:'üó∫Ô∏è', readme:'üìñ' };
            if (sections.length === 0) {
                docsList.innerHTML = '<div class="sp-empty-state">No documentation sections</div>';
                docsCount.textContent = '';
            } else {
                docsCount.textContent = sections.length;
                docsList.innerHTML = sections.map(s => `
                    <div class="dl-item" onclick="openWorkFile('${s.file}')">
                        <span class="dl-icon">${icons[s.key] || 'üìÑ'}</span>
                        <div class="dl-item-body">
                            <div class="dl-item-name">${escapeHtml(s.name)}</div>
                            ${s.summary ? `<div class="dl-item-summary">${escapeHtml(s.summary)}</div>` : ''}
                        </div>
                        <span class="dl-arrow">‚Ä∫</span>
                    </div>
                `).join('');
            }

            // Cases
            const cases = data.cases || [];
            if (cases.length > 0) {
                document.getElementById('dl-cases-section').style.display = '';
                document.getElementById('dl-cases-list').innerHTML = cases.map(c => `
                    <div class="dl-item" onclick="openWorkFile('${c.file}')">
                        <span class="dl-icon">üìã</span>
                        <div class="dl-item-body">
                            <div class="dl-item-name">${escapeHtml(c.title)}</div>
                            ${c.summary ? `<div class="dl-item-summary">${escapeHtml(c.summary)}</div>` : ''}
                        </div>
                        <span class="dl-arrow">‚Ä∫</span>
                    </div>
                `).join('');
            }
        }

        async function openWorkFile(filePath) {
            if (!currentWorkSlug) return;
            try {
                const resp = await fetch(`${API_BASE}/work-projects/${currentWorkSlug}/file/${filePath}`);
                if (!resp.ok) throw new Error('Not found');
                const d = await resp.json();
                showWorkPreview(d.title, d.content);
            } catch (e) { console.error(e); alert('Erro ao carregar arquivo'); }
        }

        function showWorkPreview(title, content) {
            currentPreviewTitle = title;
            currentPreviewContent = content;
            document.getElementById('work-preview-title').textContent = title;
            document.getElementById('work-doc-preview').innerHTML = marked.parse(content);
            document.getElementById('work-doc-preview-section').style.display = 'block';
            document.getElementById('work-doc-preview-section').scrollIntoView({ behavior: 'smooth' });
        }

        // ===== MBA PROJECT VIEW =====
        async function renderMbaView(project) {
            document.getElementById('mba-project-view').style.display = 'block';
            document.getElementById('work-project-view').style.display = 'none';
            document.getElementById('regular-project-view').style.display = 'none';

            // Also load files section (in regular view), but we show it conditionally
            loadProjectFiles();

            try {
                const stats = await fetch(`${API_BASE}/mba/stats`).then(r => r.ok ? r.json() : null);
                if (!stats) {
                    document.getElementById('mba-deadlines-list').innerHTML = '<div class="empty-section">Dados do MBA nao disponiveis. Sincronize o Adalove.</div>';
                    document.getElementById('mba-activities-list').innerHTML = '<div class="empty-section">Sem dados</div>';
                    return;
                }

                // Hero chips for MBA
                const chips = [];
                if (stats.pendentes > 0) chips.push({ text: `üìã ${stats.pendentes} pendentes` });
                if (stats.em_andamento > 0) chips.push({ text: `üîÑ ${stats.em_andamento} em andamento` });
                if (stats.concluidas > 0) chips.push({ text: `‚úÖ ${stats.concluidas} concluidas`, muted: true });
                setHeroChips(chips);

                // Deadlines
                const dlContainer = document.getElementById('mba-deadlines-list');
                if (stats.proximos_prazos && stats.proximos_prazos.length > 0) {
                    dlContainer.innerHTML = stats.proximos_prazos.map(d => {
                        const isOverdue = d.due_date && new Date(d.due_date) < new Date();
                        return `<div class="task-item-project ${isOverdue ? 'status-doing' : ''}">
                            <div class="task-info">
                                <div class="task-title">${escapeHtml(d.title)}</div>
                                <div class="task-meta">${d.due_date || ''} ${d.turma ? '‚Ä¢ ' + escapeHtml(d.turma) : ''}</div>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    dlContainer.innerHTML = '<div class="empty-section">Nenhum prazo proximo</div>';
                }

                // Pending count
                document.getElementById('mba-pending-count').textContent = stats.pendentes > 0 ? `${stats.pendentes} pendentes` : '';

                // Activities list (from the full data)
                const fullData = await fetch(`${API_BASE}/mba/data`).then(r => r.ok ? r.json() : null).catch(() => null);
                const actContainer = document.getElementById('mba-activities-list');
                if (fullData) {
                    const pending = [];
                    for (const turma of (fullData.turmas || [])) {
                        for (const semana of (turma.semanas || [])) {
                            for (const a of (semana.atividades?.a_fazer || [])) {
                                pending.push({ ...a, turma: turma.nome, semana: semana.nome });
                            }
                        }
                    }
                    if (pending.length > 0) {
                        actContainer.innerHTML = pending.slice(0, 10).map(a => `
                            <div class="task-item-project">
                                <div class="task-info">
                                    <div class="task-title">${escapeHtml(a.titulo || a.title || 'Atividade')}</div>
                                    <div class="task-meta">${a.prazo ? a.prazo + ' ‚Ä¢ ' : ''}${escapeHtml(a.turma || '')} ${a.semana ? '‚Ä¢ ' + escapeHtml(a.semana) : ''}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        actContainer.innerHTML = '<div class="empty-section">Nenhuma atividade pendente</div>';
                    }
                } else {
                    actContainer.innerHTML = '<div class="empty-section">Dados completos nao disponiveis</div>';
                }
            } catch (e) {
                console.error('Error loading MBA data:', e);
                document.getElementById('mba-deadlines-list').innerHTML = '<div class="empty-section">Erro ao carregar dados</div>';
            }
        }

        // ===== REGULAR PROJECT VIEW =====
        function renderRegularProject(project) {
            document.getElementById('work-project-view').style.display = 'none';
            document.getElementById('mba-project-view').style.display = 'none';
            document.getElementById('regular-project-view').style.display = 'grid';

            const { tasks, notes, docs, stats } = projectData;
            const hasAnyStats = stats.tasks_todo + stats.tasks_doing + stats.tasks_done + stats.total_notes + stats.total_docs > 0;

            // Only show progress and stats if there's actual data
            if (hasAnyStats) {
                document.getElementById('project-stats').style.display = '';
                document.getElementById('stat-tasks-todo').textContent = stats.tasks_todo;
                document.getElementById('stat-tasks-doing').textContent = stats.tasks_doing;
                document.getElementById('stat-tasks-done').textContent = stats.tasks_done;
                document.getElementById('stat-notes').textContent = stats.total_notes;
                document.getElementById('stat-docs').textContent = stats.total_docs;
            }

            // Show progress bar only if progress > 0
            if (project.progress > 0) {
                document.getElementById('progress-section').style.display = '';
                document.getElementById('progress-fill').style.width = project.progress + '%';
                document.getElementById('progress-text').textContent = project.progress + '%';
            }

            renderTasks(tasks);
            renderDocs(docs);
            renderNotes(notes);
            loadProjectFiles();
        }

        // ===== REGULAR VIEW RENDERERS =====
        function renderTasks(tasks) {
            const container = document.getElementById('tasks-list');
            if (tasks.length === 0) { container.innerHTML = '<div class="empty-section">Nenhuma tarefa ainda</div>'; return; }
            container.innerHTML = tasks.map(t => `
                <div class="task-item-project status-${t.status}">
                    <div class="task-checkbox ${t.status==='done'?'checked':''}" onclick="toggleTask(${t.id},'${t.status}')"></div>
                    <div class="task-info">
                        <div class="task-title">${escapeHtml(t.title)}</div>
                        <div class="task-meta">${t.priority==='high'?'‚ö° Alta':t.priority==='low'?'‚Üì Baixa':''}${t.due_date?' ‚Ä¢ '+t.due_date:''}</div>
                    </div>
                    <button onclick="deleteTask(${t.id})" class="btn-delete-subtle">üóë</button>
                </div>
            `).join('');
        }

        function renderDocs(docs) {
            const container = document.getElementById('docs-list');
            if (docs.length === 0) { container.innerHTML = '<div class="empty-section">Nenhum documento ainda</div>'; return; }
            const icons = { link:'üîó', doc:'üìÑ', notion:'üìù', figma:'üé®', github:'üíª', jira:'üìã', pdf:'üìï', sheet:'üìä', slides:'üìΩÔ∏è' };
            container.innerHTML = docs.map(d => `
                <div class="doc-item">
                    <span class="doc-icon">${icons[d.doc_type]||'üìÑ'}</span>
                    <div class="doc-info">
                        <div class="doc-title">${d.url?`<a href="${d.url}" target="_blank">${escapeHtml(d.title)}</a>`:escapeHtml(d.title)}</div>
                        ${d.description?`<div class="doc-desc">${escapeHtml(d.description)}</div>`:''}
                    </div>
                    <button onclick="deleteDoc(${d.id})" class="btn-delete-subtle">üóë</button>
                </div>
            `).join('');
        }

        function renderNotes(notes) {
            const container = document.getElementById('notes-list');
            if (notes.length === 0) { container.innerHTML = '<div class="empty-section">Nenhuma nota ainda</div>'; return; }
            container.innerHTML = notes.map(n => `
                <div class="note-item">
                    <div class="note-header">
                        <div class="note-title">${escapeHtml(n.title)}</div>
                        <div class="note-date">${n.meeting_date||n.created_at?.split('T')[0]||''}</div>
                    </div>
                    ${n.content?`<div class="note-content">${escapeHtml(n.content).substring(0,200)}${n.content.length>200?'...':''}</div>`:''}
                </div>
            `).join('');
        }

        // ===== PROJECT FILES =====
        async function loadProjectFiles() {
            try {
                const resp = await fetch(`${API_BASE}/projects/${projectId}/files`);
                const data = await resp.json();
                renderFiles(data);
            } catch (e) {
                console.error('Error loading files:', e);
                const el = document.getElementById('files-list');
                if (el) el.innerHTML = '<div class="empty-section">Erro ao carregar arquivos</div>';
            }
        }

        function renderFiles(data) {
            const section = document.getElementById('files-section');
            const container = document.getElementById('files-list');
            const statusEl = document.getElementById('files-status');
            if (!section || !container || !statusEl) return;

            const files = data.exists ? (data.files || []).filter(f => f.name !== 'manifest.json') : [];

            // Hide entire section if no real files
            if (files.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = '';
            statusEl.textContent = `${files.length} arquivo${files.length > 1 ? 's' : ''}`;
            const icons = { epic:'üìú', draft:'‚úèÔ∏è', doc:'üìÑ', note:'üìù', file:'üìÅ' };
            const labels = { epic:'Epico Principal', draft:'Rascunho', doc:'Documento', note:'Nota', file:'Arquivo' };

            container.innerHTML = files.map(file => {
                const fd = extractDateFromFilename(file.name);
                const dateDisplay = fd ? formatMeetingDate(fd) : 'Atualizado ' + formatTimeAgo(new Date(file.modified * 1000));
                return `<div class="file-item type-${file.type}" onclick="openFile('${data.slug}/${file.path}')">
                    <span class="file-icon">${icons[file.type]||'üìÑ'}</span>
                    <div class="file-info">
                        <div class="file-name">${file.name.replace('.md','').replace(/^\d{4}-\d{2}-\d{2}-/,'')}</div>
                        <div class="file-meta">${labels[file.type]||'Arquivo'} ‚Ä¢ ${dateDisplay}</div>
                    </div>
                </div>`;
            }).join('');
        }

        async function openFile(filePath) {
            try {
                const resp = await fetch(`${API_BASE}/projects/files/${filePath}`);
                const data = await resp.json();
                if (data.content) showPreview(filePath.split('/').pop().replace('.md',''), data.content);
            } catch (e) { console.error(e); alert('Erro ao carregar arquivo'); }
        }

        function showPreview(title, content) {
            currentPreviewTitle = title;
            currentPreviewContent = content;
            const titleEl = document.getElementById('preview-title');
            if (titleEl) titleEl.textContent = 'üìÑ ' + title;
            const previewEl = document.getElementById('doc-preview');
            if (previewEl) previewEl.innerHTML = marked.parse(content);
            const section = document.getElementById('doc-preview-section');
            if (section) { section.style.display = 'block'; section.scrollIntoView({ behavior: 'smooth' }); }
        }

        function closePreview() {
            const s1 = document.getElementById('doc-preview-section');
            const s2 = document.getElementById('work-doc-preview-section');
            if (s1) s1.style.display = 'none';
            if (s2) s2.style.display = 'none';
        }

        function openFullscreen() {
            document.getElementById('fullscreen-title').textContent = currentPreviewTitle;
            document.getElementById('fullscreen-content').innerHTML = marked.parse(currentPreviewContent);
            document.getElementById('fullscreen-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFullscreen() {
            document.getElementById('fullscreen-overlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ===== FORM ACTIONS =====
        function toggleAddTask() { document.getElementById('add-task-form').classList.toggle('active'); }
        function toggleAddDoc() { document.getElementById('add-doc-form').classList.toggle('active'); }
        function toggleAddNote() { document.getElementById('add-note-form').classList.toggle('active'); }

        async function addTask() {
            const title = document.getElementById('new-task-title').value.trim();
            if (!title) return;
            await fetch(`${API_BASE}/tasks`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title, priority: document.getElementById('new-task-priority').value, project_id: parseInt(projectId) }) });
            document.getElementById('new-task-title').value = '';
            toggleAddTask();
            loadProjectWithWorkCheck();
        }

        async function toggleTask(taskId, currentStatus) {
            await fetch(`${API_BASE}/tasks/${taskId}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ status: currentStatus === 'done' ? 'todo' : 'done' }) });
            loadProjectWithWorkCheck();
        }

        async function deleteTask(taskId) {
            if (!confirm('Deletar tarefa?')) return;
            await fetch(`${API_BASE}/tasks/${taskId}`, { method: 'DELETE' });
            loadProjectWithWorkCheck();
        }

        async function addDoc() {
            const title = document.getElementById('new-doc-title').value.trim();
            if (!title) return;
            const url = document.getElementById('new-doc-url').value.trim();
            const docType = document.getElementById('new-doc-type').value;
            const description = document.getElementById('new-doc-description').value.trim();
            let apiUrl = `${API_BASE}/projects/${projectId}/docs?title=${encodeURIComponent(title)}&doc_type=${docType}`;
            if (url) apiUrl += `&url=${encodeURIComponent(url)}`;
            if (description) apiUrl += `&description=${encodeURIComponent(description)}`;
            await fetch(apiUrl, { method: 'POST' });
            document.getElementById('new-doc-title').value = '';
            document.getElementById('new-doc-url').value = '';
            document.getElementById('new-doc-description').value = '';
            toggleAddDoc();
            loadProjectWithWorkCheck();
        }

        async function deleteDoc(docId) {
            if (!confirm('Remover documento?')) return;
            await fetch(`${API_BASE}/projects/${projectId}/docs/${docId}`, { method: 'DELETE' });
            loadProjectWithWorkCheck();
        }

        async function addNote() {
            const title = document.getElementById('new-note-title').value.trim();
            if (!title) return;
            await fetch(`${API_BASE}/notes`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title, content: document.getElementById('new-note-content').value, project_id: parseInt(projectId) }) });
            document.getElementById('new-note-title').value = '';
            document.getElementById('new-note-content').value = '';
            toggleAddNote();
            loadProjectWithWorkCheck();
        }

        // ===== COLLAPSIBLE SECTIONS =====
        function toggleCollapsible(toggleEl) {
            const section = toggleEl.closest('.collapsible-section');
            const body = section.querySelector('.collapsible-body');
            const indicator = section.querySelector('.collapse-indicator');
            const isOpen = body.classList.contains('open');
            if (isOpen) {
                body.classList.remove('open');
                indicator.classList.remove('open');
                toggleEl.setAttribute('aria-expanded', 'false');
            } else {
                body.classList.add('open');
                indicator.classList.add('open');
                toggleEl.setAttribute('aria-expanded', 'true');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.collapsible-toggle').forEach(toggle => {
                const body = toggle.nextElementSibling;
                const isOpen = body && body.classList.contains('open');
                toggle.setAttribute('role', 'button');
                toggle.setAttribute('tabindex', '0');
                toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                if (body && body.id) toggle.setAttribute('aria-controls', body.id);
                toggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCollapsible(toggle); }
                });
            });
        });

        // Close sprint drawer on click outside
        document.addEventListener('click', (e) => {
            const wrap = document.getElementById('ph-sprint-wrap');
            const drawer = document.getElementById('ph-sprint-drawer');
            if (wrap && drawer && !wrap.contains(e.target)) {
                drawer.classList.remove('ph-sprint-drawer--open');
                document.getElementById('ph-sprint-btn').setAttribute('aria-expanded', 'false');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('fullscreen-overlay').classList.contains('active')) closeFullscreen();
                else closePreview();
            }
            if ((e.key === 'f' || e.key === 'F') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                const docSection = document.getElementById('doc-preview-section');
                const workSection = document.getElementById('work-doc-preview-section');
                if ((docSection && docSection.style.display !== 'none') || (workSection && workSection.style.display !== 'none')) {
                    if (!document.getElementById('fullscreen-overlay').classList.contains('active')) openFullscreen();
                }
            }
            // Number keys 1-3 for tab switching
            if (!e.ctrlKey && !e.metaKey && !e.altKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                if (e.key === '1') switchTab('overview');
                if (e.key === '2') switchTab('meetings');
                if (e.key === '3') switchTab('docs');
            }
        });

        // ===== START =====
        loadProjectWithWorkCheck();
    </script>
    <script src="js/mobile-nav.js?v=7"></script>
</body>
</html>
