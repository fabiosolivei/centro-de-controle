<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d1117">
    <meta name="description" content="Centro de Controle - Dashboard do F√°bio">
    <title>Centro de Controle</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Auth Check -->
    <script>
        const AUTH_HASH = 'f379eaffb6d3420d190c693e60b4e0c50f018cca3ec9c9bea2ca3ee069ae1f4d';
        if (sessionStorage.getItem('auth_token') !== AUTH_HASH) {
            window.location.href = 'login.html';
        }
    </script>
    <!-- GPM Dashboard Styles moved to style.css -->
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <h1 class="logo">Centro de Controle</h1>
            <nav class="header-nav">
                <a href="index.html" class="nav-link active" aria-label="Dashboard">Dashboard</a>
                <a href="portfolio.html" class="nav-link" aria-label="Portfolio">Portfolio</a>
                <a href="mba.html" class="nav-link" aria-label="MBA">MBA</a>
                <a href="work.html" class="nav-link" aria-label="Work Status">Work</a>
                <a href="files.html" class="nav-link" aria-label="Arquivos">Arquivos</a>
            </nav>
            <div class="header-actions">
                <button class="btn-icon" onclick="openCommandPalette()" title="Buscar (Ctrl+K)" aria-label="Buscar">
                    <span>üîç</span>
                </button>
                <div class="sync-dropdown-wrapper">
                    <button class="btn-icon" onclick="toggleSyncMenu()" title="Sincronizar" aria-label="Sincronizar dados" id="sync-btn">
                        <span>üîÑ</span>
                    </button>
                    <div class="sync-dropdown" id="sync-dropdown">
                        <div class="sync-dropdown-item" onclick="quickReload()">
                            <span>‚ö°</span> Atualizar dados
                            <small>Recarrega do servidor</small>
                        </div>
                        <div class="sync-dropdown-item" onclick="fullSync()">
                            <span>üîÑ</span> Sincronizar tudo
                            <small>Confluence + fontes externas</small>
                        </div>
                        <div class="sync-dropdown-item" onclick="syncNotion()">
                            <span>üìì</span> Sincronizar Notion
                            <small>Meeting notes e paginas</small>
                        </div>
                        <div class="sync-dropdown-divider"></div>
                        <div class="sync-dropdown-status" id="sync-status-summary">
                            Carregando status...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main-content dashboard-page">
        <!-- HERO BAR (compact) -->
        <div class="hero-bar">
            <div class="hero-bar-left">
                <h1 id="greeting-message" class="hero-title">Bom dia, Fabio</h1>
                <p id="greeting-summary" class="hero-summary">Carregando seu resumo...</p>
            </div>
            <div class="hero-bar-right">
                <div class="summary-chips" id="summary-chips">
                    <!-- Populated by JS -->
                </div>
                <div class="hero-actions">
                    <button class="quick-action" onclick="openTaskModal()" aria-label="Nova Tarefa">
                        <span>‚ûï</span> Tarefa
                    </button>
                    <button class="quick-action" onclick="openNoteModal()" aria-label="Nova Nota">
                        <span>üìù</span> Nota
                    </button>
                    <button class="quick-action" onclick="openReminderModal()" aria-label="Novo Lembrete">
                        <span>üîî</span> Lembrete
                    </button>
                </div>
            </div>
        </div>
        
        <!-- MAIN DASHBOARD GRID -->
        <div class="dashboard-grid">
            <!-- LEFT COLUMN: Today + Tasks -->
            <div class="today-column">
                <!-- Agenda -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üìÖ Agenda de Hoje</h2>
                        <span class="section-action" onclick="refreshCalendar()">Atualizar</span>
                    </div>
                    <div id="agenda-list">
                        <div class="empty-state-styled loading">
                            <span class="empty-icon">üìÖ</span>
                            <span>Carregando agenda...</span>
                        </div>
                    </div>
                </section>
                
                <!-- Tasks Summary -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üìã Tarefas</h2>
                        <a class="section-action" href="#" onclick="showKanban()">Ver Kanban</a>
                    </div>
                    <div class="kanban-mini">
                        <div class="kanban-mini-col todo">
                            <div class="kanban-mini-count" id="count-todo">0</div>
                            <div class="kanban-mini-label">A Fazer</div>
                        </div>
                        <div class="kanban-mini-col doing">
                            <div class="kanban-mini-count" id="count-doing">0</div>
                            <div class="kanban-mini-label">Fazendo</div>
                        </div>
                        <div class="kanban-mini-col done">
                            <div class="kanban-mini-count" id="count-done">0</div>
                            <div class="kanban-mini-label">Feito</div>
                        </div>
                    </div>
                    <div id="urgent-tasks" style="margin-top: var(--spacing-md);">
                        <!-- Urgent tasks shown here -->
                    </div>
                </section>
                
                <!-- MBA Quick View -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üéì MBA Inteli</h2>
                        <a class="section-action" href="mba.html">Ver tudo</a>
                    </div>
                    <div class="kanban-mini">
                        <div class="kanban-mini-col todo">
                            <div class="kanban-mini-count" id="mba-pendentes">-</div>
                            <div class="kanban-mini-label">Pendentes</div>
                        </div>
                        <div class="kanban-mini-col doing">
                            <div class="kanban-mini-count" id="mba-andamento">-</div>
                            <div class="kanban-mini-label">Em Andamento</div>
                        </div>
                        <div class="kanban-mini-col done">
                            <div class="kanban-mini-count" id="mba-concluidas">-</div>
                            <div class="kanban-mini-label">Conclu√≠das</div>
                        </div>
                    </div>
                    <div id="mba-deadlines" style="margin-top: var(--spacing-md);">
                        <!-- MBA deadlines shown here -->
                    </div>
                </section>
            </div>
            
            <!-- RIGHT COLUMN: Portfolio + Updates -->
            <div class="today-column">
                <!-- Work Portfolio -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üíº Projetos Trabalho</h2>
                        <a class="section-action" href="portfolio.html">Ver portfolio</a>
                    </div>
                    <div class="portfolio-grid" id="portfolio-grid">
                        <div class="empty-state-styled loading">
                            <span class="empty-icon">üíº</span>
                            <span>Carregando projetos...</span>
                        </div>
                    </div>
                </section>
                
                <!-- Work Status (Confluence) -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üìä Work Status</h2>
                        <a class="section-action" href="work.html">Ver tudo</a>
                    </div>
                    <div class="kanban-mini" id="work-status-mini">
                        <div class="kanban-mini-col todo">
                            <div class="kanban-mini-count" id="work-initiatives">-</div>
                            <div class="kanban-mini-label">Initiatives</div>
                        </div>
                        <div class="kanban-mini-col doing">
                            <div class="kanban-mini-count" id="work-epics">-</div>
                            <div class="kanban-mini-label">Epics</div>
                        </div>
                        <div class="kanban-mini-col done">
                            <div class="kanban-mini-count" id="work-sprints">-</div>
                            <div class="kanban-mini-label">Sprints</div>
                        </div>
                    </div>
                    <div id="work-alerts" style="margin-top: var(--spacing-md);">
                        <!-- Work alerts (risks/bugs) shown here -->
                    </div>
                </section>
                
                <!-- Recent Updates -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üîî Updates Recentes</h2>
                        <span class="section-action" onclick="refreshUpdates()">Atualizar</span>
                    </div>
                    <div class="updates-list" id="updates-list">
                        <div class="empty-state-styled loading">
                            <span class="empty-icon">üîî</span>
                            <span>Carregando updates...</span>
                        </div>
                    </div>
                </section>
                
                <!-- Reminders -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">‚è∞ Lembretes</h2>
                        <span class="section-action" onclick="openReminderModal()">+ Novo</span>
                    </div>
                    <div id="reminders-list">
                        <div class="empty-state-styled">
                            <span class="empty-icon">‚úÖ</span>
                            <span>Nenhum lembrete ativo</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- COMMAND PALETTE -->
    <div class="command-palette" id="command-palette">
        <div class="command-input-wrapper">
            <input type="text" class="command-input" id="command-input" 
                   placeholder="Buscar projetos, tarefas, notas... (Esc para fechar)"
                   oninput="handleCommandInput(this.value)">
            <div class="command-results" id="command-results"></div>
        </div>
    </div>

    <!-- KEYBOARD HINT -->
    <!-- Keyboard hints removed - discoverable via Ctrl+K -->

    <!-- TASK MODAL -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="task-modal-title">Nova Tarefa</h3>
                <button class="btn-close" onclick="closeTaskModal()">‚úï</button>
            </div>
            <form id="task-form" onsubmit="saveTask(event)">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label for="task-title">T√≠tulo *</label>
                    <input type="text" id="task-title" required placeholder="O que precisa fazer?">
                </div>
                <div class="form-group">
                    <label for="task-description">Descri√ß√£o</label>
                    <textarea id="task-description" rows="3" placeholder="Detalhes (opcional)"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="task-priority">Prioridade</label>
                        <select id="task-priority">
                            <option value="low">Baixa</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">Alta</option>
                            <option value="urgent">Urgente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-status">Status</label>
                        <select id="task-status">
                            <option value="todo">A Fazer</option>
                            <option value="doing">Fazendo</option>
                            <option value="done">Feito</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="task-project">Projeto</label>
                    <select id="task-project">
                        <option value="">Sem projeto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="task-due-date">Data limite</label>
                    <input type="date" id="task-due-date">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeTaskModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- REMINDER MODAL -->
    <div class="modal" id="reminder-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Novo Lembrete</h3>
                <button class="btn-close" onclick="closeReminderModal()">‚úï</button>
            </div>
            <form id="reminder-form" onsubmit="saveReminder(event)">
                <div class="form-group">
                    <label for="reminder-title">T√≠tulo *</label>
                    <input type="text" id="reminder-title" required placeholder="Do que precisa lembrar?">
                </div>
                <div class="form-group">
                    <label for="reminder-datetime">Data e Hora *</label>
                    <input type="datetime-local" id="reminder-datetime" required>
                </div>
                <div class="form-group">
                    <label for="reminder-priority">Prioridade</label>
                    <select id="reminder-priority">
                        <option value="low">Baixa</option>
                        <option value="normal" selected>Normal</option>
                        <option value="high">Alta</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeReminderModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NOTE MODAL -->
    <div class="modal" id="note-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="note-modal-title">Nova Nota</h3>
                <button class="btn-close" onclick="closeNoteModal()">‚úï</button>
            </div>
            <form id="note-form" onsubmit="saveNote(event)">
                <input type="hidden" id="note-id">
                <div class="form-group">
                    <label for="note-title">T√≠tulo *</label>
                    <input type="text" id="note-title" required placeholder="T√≠tulo da reuni√£o/nota">
                </div>
                <div class="form-group">
                    <label for="note-date">Data da Reuni√£o</label>
                    <input type="date" id="note-date">
                </div>
                <div class="form-group">
                    <label for="note-content">Conte√∫do</label>
                    <textarea id="note-content" rows="6" placeholder="Anota√ß√µes da reuni√£o..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeNoteModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- KANBAN MODAL -->
    <div class="modal" id="kanban-modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header">
                <h3>Kanban - Todas as Tarefas</h3>
                <button class="btn-close" onclick="closeKanbanModal()">‚úï</button>
            </div>
            <div class="kanban-board" id="kanban-board-full" style="padding: 20px;">
                <!-- Full kanban board here -->
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="js/api.js"></script>
    <script>
        // ===========================================
        // GPM DASHBOARD - MAIN SCRIPT
        // ===========================================
        
        // API_BASE is already defined in api.js
        
        // State
        let tasks = [];
        let projects = [];
        let reminders = [];
        let workProjects = [];
        
        // ===========================================
        // INITIALIZATION
        // ===========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            updateGreeting();
            loadAllData();
            setupKeyboardShortcuts();
        });
        
        function updateGreeting() {
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Bom dia' : hour < 18 ? 'Boa tarde' : 'Boa noite';
            document.getElementById('greeting-message').textContent = `${greeting}, Fabio`;
        }
        
        async function loadAllData() {
            try {
                await Promise.all([
                    loadTasks(),
                    loadProjects(),
                    loadReminders(),
                    loadWorkProjects(),
                    loadCalendarEvents(),
                    loadMBAStats(),
                    loadWorkStatus()
                ]);
                updateSummary();
                loadUpdates();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // ===========================================
        // TASKS
        // ===========================================
        
        async function loadTasks() {
            try {
                tasks = await apiRequest('/tasks');
                if (!Array.isArray(tasks)) tasks = [];
                renderTaskCounts();
                renderUrgentTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
                tasks = [];
            }
        }
        
        function renderTaskCounts() {
            const todo = tasks.filter(t => t.status === 'todo').length;
            const doing = tasks.filter(t => t.status === 'doing').length;
            const done = tasks.filter(t => t.status === 'done').length;
            
            document.getElementById('count-todo').textContent = todo;
            document.getElementById('count-doing').textContent = doing;
            document.getElementById('count-done').textContent = done;
        }
        
        function renderUrgentTasks() {
            const urgent = tasks.filter(t => 
                (t.priority === 'urgent' || t.priority === 'high') && 
                t.status !== 'done'
            );
            
            const container = document.getElementById('urgent-tasks');
            
            if (urgent.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 0.75rem; color: #ef4444; margin-bottom: 8px; font-weight: 600;">
                        üî• ${urgent.length} tarefa${urgent.length > 1 ? 's' : ''} urgente${urgent.length > 1 ? 's' : ''}
                    </div>
                    ${urgent.slice(0, 3).map(t => `
                        <div style="padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-bottom: 4px; font-size: 0.875rem;">
                            ${escapeHtml(t.title)}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // ===========================================
        // PROJECTS
        // ===========================================
        
        async function loadProjects() {
            try {
                projects = await apiRequest('/projects');
                if (!Array.isArray(projects)) projects = [];
            } catch (error) {
                console.error('Error loading projects:', error);
                projects = [];
            }
        }
        
        async function loadWorkProjects() {
            try {
                const data = await apiRequest('/work-projects');
                workProjects = data.projects || [];
                renderPortfolio();
            } catch (error) {
                console.error('Error loading work projects:', error);
                workProjects = [];
                renderPortfolio();
            }
        }
        
        function renderPortfolio() {
            const container = document.getElementById('portfolio-grid');
            
            // Get work projects from database
            const workDbProjects = projects.filter(p => p.category === 'trabalho');
            
            if (workDbProjects.length === 0) {
                container.innerHTML = '<div class="empty-state-styled"><span class="empty-icon">üíº</span><span>Nenhum projeto de trabalho</span></div>';
                return;
            }
            
            container.innerHTML = workDbProjects.map(project => `
                <div class="portfolio-card ${project.priority === 'high' ? 'high-priority' : ''}" 
                     onclick="window.location.href='project.html?id=${project.id}'">
                    <div class="portfolio-info">
                        <div class="portfolio-name">${escapeHtml(project.name)}</div>
                        <div class="portfolio-status">
                            ${project.status === 'active' ? 'üü¢ Ativo' : project.status === 'paused' ? 'üü° Pausado' : '‚úÖ Conclu√≠do'}
                        </div>
                    </div>
                    <div class="portfolio-progress">
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini" style="width: ${project.progress || 0}%"></div>
                        </div>
                        <span class="progress-text">${project.progress || 0}%</span>
                    </div>
                </div>
            `).join('');
        }
        
        // ===========================================
        // CALENDAR
        // ===========================================
        
        async function loadCalendarEvents() {
            try {
                const events = await apiRequest('/calendar/today');
                renderAgenda(events);
            } catch (error) {
                console.error('Error loading calendar:', error);
                document.getElementById('agenda-list').innerHTML = 
                    '<div class="empty-state-styled error"><span class="empty-icon">‚ö†Ô∏è</span><span>N√£o foi poss√≠vel carregar a agenda</span></div>';
            }
        }
        
        function renderAgenda(events) {
            const container = document.getElementById('agenda-list');
            
            if (!Array.isArray(events) || events.length === 0) {
                container.innerHTML = '<div class="empty-state-styled"><span class="empty-icon">‚úÖ</span><span>Nenhum evento restante hoje</span></div>';
                return;
            }
            
            container.innerHTML = events.slice(0, 5).map(event => `
                <div class="agenda-item">
                    <span class="agenda-time">${event.time || '--:--'}</span>
                    <span class="agenda-title">${escapeHtml(event.summary || event.title)}</span>
                </div>
            `).join('');
        }
        
        function refreshCalendar() {
            loadCalendarEvents();
        }
        
        // ===========================================
        // MBA
        // ===========================================
        
        async function loadMBAStats() {
            try {
                const stats = await apiRequest('/mba/stats');
                
                document.getElementById('mba-pendentes').textContent = stats.pendentes || 0;
                document.getElementById('mba-andamento').textContent = stats.em_andamento || 0;
                document.getElementById('mba-concluidas').textContent = stats.concluidas || 0;
                
                // Show upcoming deadlines
                if (stats.proximos_prazos && stats.proximos_prazos.length > 0) {
                    const deadlinesHtml = stats.proximos_prazos.slice(0, 2).map(d => `
                        <div style="padding: 8px; background: rgba(234, 179, 8, 0.1); border-radius: 6px; margin-bottom: 4px; font-size: 0.875rem;">
                            üìÖ ${escapeHtml(d.title)} - ${d.due_date}
                        </div>
                    `).join('');
                    document.getElementById('mba-deadlines').innerHTML = deadlinesHtml;
                }
            } catch (error) {
                console.error('Error loading MBA stats:', error);
            }
        }
        
        // ===========================================
        // WORK STATUS (CONFLUENCE)
        // ===========================================
        
        async function loadWorkStatus() {
            try {
                const summary = await apiRequest('/confluence/summary');
                
                // Update counts
                document.getElementById('work-initiatives').textContent = summary.initiatives || 0;
                document.getElementById('work-epics').textContent = summary.epics || 0;
                document.getElementById('work-sprints').textContent = summary.sprints || 0;
                
                // Show alerts for risks and bugs
                const alertsContainer = document.getElementById('work-alerts');
                let alertsHtml = '';
                
                if (summary.risks > 0) {
                    alertsHtml += `
                        <div style="padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-bottom: 4px; font-size: 0.875rem; display: flex; align-items: center; gap: 8px;">
                            <span>‚ö†Ô∏è</span>
                            <span style="color: #f87171; font-weight: 600;">${summary.risks}</span>
                            <span>riscos ativos</span>
                        </div>
                    `;
                }
                
                if (summary.bugs > 0) {
                    alertsHtml += `
                        <div style="padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; margin-bottom: 4px; font-size: 0.875rem; display: flex; align-items: center; gap: 8px;">
                            <span>üêõ</span>
                            <span style="color: #fbbf24; font-weight: 600;">${summary.bugs}</span>
                            <span>bugs ativos</span>
                        </div>
                    `;
                }
                
                if (summary.current_sprint) {
                    alertsHtml += `
                        <div style="padding: 8px; background: rgba(99, 102, 241, 0.1); border-radius: 6px; font-size: 0.875rem;">
                            üèÉ <strong>${escapeHtml(summary.current_sprint)}</strong>
                        </div>
                    `;
                }
                
                alertsContainer.innerHTML = alertsHtml || '<p style="color: var(--text-muted); font-size: 0.875rem;">Tudo em dia!</p>';
                
            } catch (error) {
                console.log('Work status not available - Confluence sync needed');
                document.getElementById('work-initiatives').textContent = '-';
                document.getElementById('work-epics').textContent = '-';
                document.getElementById('work-sprints').textContent = '-';
                document.getElementById('work-alerts').innerHTML = 
                    '<div class="sync-badge not-synced"><span>üîó</span> N√£o sincronizado</div>';
            }
        }
        
        // ===========================================
        // REMINDERS
        // ===========================================
        
        async function loadReminders() {
            try {
                reminders = await apiRequest('/reminders');
                if (!Array.isArray(reminders)) reminders = [];
                renderReminders();
            } catch (error) {
                console.error('Error loading reminders:', error);
                reminders = [];
            }
        }
        
        function renderReminders() {
            const container = document.getElementById('reminders-list');
            const activeReminders = reminders.filter(r => !r.is_completed);
            
            if (activeReminders.length === 0) {
                container.innerHTML = '<div class="empty-state-styled"><span class="empty-icon">‚úÖ</span><span>Nenhum lembrete ativo</span></div>';
                return;
            }
            
            container.innerHTML = activeReminders.slice(0, 5).map(reminder => {
                const dueDate = new Date(reminder.due_datetime);
                const isOverdue = dueDate < new Date();
                
                return `
                    <div class="update-item" style="${isOverdue ? 'border-left: 3px solid #ef4444;' : ''}">
                        <div class="update-icon">${isOverdue ? '‚ö†Ô∏è' : 'üîî'}</div>
                        <div class="update-content">
                            <div class="update-title">${escapeHtml(reminder.title)}</div>
                            <div class="update-meta">${formatDateTime(reminder.due_datetime)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ===========================================
        // UPDATES
        // ===========================================
        
        async function loadUpdates() {
            try {
                const data = await apiRequest('/updates/recent?limit=10');
                renderUpdates(data.updates || []);
            } catch (error) {
                console.log('Updates API not available, using simulated data');
                renderSimulatedUpdates();
            }
        }
        
        function renderUpdates(updates) {
            const container = document.getElementById('updates-list');
            
            if (!updates || updates.length === 0) {
                renderSimulatedUpdates();
                return;
            }
            
            const shown = updates.slice(0, 5);
            const hasMore = updates.length > 5;
            container.innerHTML = shown.map(update => `
                <div class="update-item ${getUpdateTypeClass(update.entity_type || update.type)}">
                    <div class="update-icon">${update.icon || getUpdateIcon(update.entity_type || update.type)}</div>
                    <div class="update-content">
                        <div class="update-title">${escapeHtml(update.message || update.title)}</div>
                        <div class="update-meta">${update.entity_type || ''} ‚Ä¢ ${formatTimeAgo(new Date(update.timestamp))}</div>
                    </div>
                </div>
            `).join('') + (hasMore ? `<div class="update-more"><span class="section-action" onclick="loadUpdates()">Ver mais ${updates.length - 5} updates</span></div>` : '');
        }
        
        function renderSimulatedUpdates() {
            const container = document.getElementById('updates-list');
            
            // Create updates from recent activity
            const updates = [];
            
            // Recent tasks
            tasks.filter(t => t.status === 'done').slice(0, 2).forEach(t => {
                updates.push({
                    type: 'task_done',
                    title: `Tarefa conclu√≠da: ${t.title}`,
                    meta: formatTimeAgo(new Date(t.updated_at || t.created_at))
                });
            });
            
            // Work projects
            projects.filter(p => p.category === 'trabalho').slice(0, 3).forEach(p => {
                updates.push({
                    type: 'project',
                    title: `${p.name}`,
                    meta: `${p.progress || 0}% conclu√≠do`
                });
            });
            
            if (updates.length === 0) {
                container.innerHTML = '<div class="empty-state-styled"><span class="empty-icon">üîî</span><span>Sem updates recentes</span></div>';
                return;
            }
            
            container.innerHTML = updates.slice(0, 5).map(update => `
                <div class="update-item ${getUpdateTypeClass(update.entity_type || update.type)}">
                    <div class="update-icon">${getUpdateIcon(update.entity_type || update.type)}</div>
                    <div class="update-content">
                        <div class="update-title">${escapeHtml(update.title)}</div>
                        <div class="update-meta">${update.meta}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function getUpdateIcon(type) {
            const icons = {
                'meeting': 'üìÖ',
                'task_done': '‚úÖ',
                'task_created': 'üìã',
                'project': 'üíº',
                'note': 'üìù',
                'deadline': '‚è∞'
            };
            return icons[type] || 'üîî';
        }
        
        function getUpdateTypeClass(type) {
            const classes = {
                'meeting': 'update-type-meeting',
                'meeting_note': 'update-type-meeting',
                'task_done': 'update-type-task',
                'task_created': 'update-type-task',
                'project': 'update-type-project',
                'note': 'update-type-note',
                'deadline': 'update-type-deadline'
            };
            return classes[type] || '';
        }
        
        function refreshUpdates() {
            loadUpdates();
        }
        
        // ===========================================
        // SUMMARY
        // ===========================================
        
        function updateSummary() {
            const todoCount = tasks.filter(t => t.status === 'todo').length;
            const urgentCount = tasks.filter(t => t.priority === 'urgent' && t.status !== 'done').length;
            const doingCount = tasks.filter(t => t.status === 'doing').length;
            
            // Update greeting summary
            const summaryParts = [];
            if (todoCount > 0) summaryParts.push(`${todoCount} tarefa${todoCount > 1 ? 's' : ''} a fazer`);
            if (doingCount > 0) summaryParts.push(`${doingCount} em andamento`);
            
            document.getElementById('greeting-summary').textContent = 
                summaryParts.length > 0 ? `Voc√™ tem ${summaryParts.join(', ')}.` : 'Tudo em dia!';
            
            // Update chips
            const chipsContainer = document.getElementById('summary-chips');
            let chipsHtml = '';
            
            if (todoCount > 0) {
                chipsHtml += `
                    <div class="summary-chip">
                        <span>üìã</span>
                        <span class="chip-number">${todoCount}</span>
                        <span>tarefas</span>
                    </div>
                `;
            }
            
            if (urgentCount > 0) {
                chipsHtml += `
                    <div class="summary-chip urgent">
                        <span>üî•</span>
                        <span class="chip-number">${urgentCount}</span>
                        <span>urgente${urgentCount > 1 ? 's' : ''}</span>
                    </div>
                `;
            }
            
            const workProjectCount = projects.filter(p => p.category === 'trabalho' && p.status === 'active').length;
            if (workProjectCount > 0) {
                chipsHtml += `
                    <div class="summary-chip">
                        <span>üíº</span>
                        <span class="chip-number">${workProjectCount}</span>
                        <span>projetos ativos</span>
                    </div>
                `;
            }
            
            chipsContainer.innerHTML = chipsHtml || '<span style="color: var(--text-muted);">Tudo organizado!</span>';
        }
        
        // ===========================================
        // MODALS
        // ===========================================
        
        function openTaskModal(taskId = null) {
            document.getElementById('task-modal').classList.add('active');
            document.getElementById('task-modal-title').textContent = taskId ? 'Editar Tarefa' : 'Nova Tarefa';
            document.getElementById('task-id').value = taskId || '';
            
            if (!taskId) {
                document.getElementById('task-form').reset();
            }
            
            // Populate project select
            const projectSelect = document.getElementById('task-project');
            projectSelect.innerHTML = '<option value="">Sem projeto</option>' +
                projects.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
            
            document.getElementById('task-title').focus();
        }
        
        function closeTaskModal() {
            document.getElementById('task-modal').classList.remove('active');
        }
        
        function openReminderModal() {
            document.getElementById('reminder-modal').classList.add('active');
            document.getElementById('reminder-form').reset();
            
            // Set default datetime to now + 1 hour
            const now = new Date();
            now.setHours(now.getHours() + 1);
            now.setMinutes(0);
            document.getElementById('reminder-datetime').value = now.toISOString().slice(0, 16);
            
            document.getElementById('reminder-title').focus();
        }
        
        function closeReminderModal() {
            document.getElementById('reminder-modal').classList.remove('active');
        }
        
        function openNoteModal() {
            document.getElementById('note-modal').classList.add('active');
            document.getElementById('note-form').reset();
            document.getElementById('note-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('note-title').focus();
        }
        
        function closeNoteModal() {
            document.getElementById('note-modal').classList.remove('active');
        }
        
        function showKanban() {
            document.getElementById('kanban-modal').classList.add('active');
            renderFullKanban();
        }
        
        function closeKanbanModal() {
            document.getElementById('kanban-modal').classList.remove('active');
        }
        
        function renderFullKanban() {
            const container = document.getElementById('kanban-board-full');
            const todoTasks = tasks.filter(t => t.status === 'todo');
            const doingTasks = tasks.filter(t => t.status === 'doing');
            const doneTasks = tasks.filter(t => t.status === 'done');
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div>
                        <h4 style="color: #ef4444; margin-bottom: 12px;">üî¥ A Fazer (${todoTasks.length})</h4>
                        ${renderTaskList(todoTasks)}
                    </div>
                    <div>
                        <h4 style="color: #eab308; margin-bottom: 12px;">üü° Fazendo (${doingTasks.length})</h4>
                        ${renderTaskList(doingTasks)}
                    </div>
                    <div>
                        <h4 style="color: #22c55e; margin-bottom: 12px;">üü¢ Feito (${doneTasks.length})</h4>
                        ${renderTaskList(doneTasks)}
                    </div>
                </div>
            `;
        }
        
        function renderTaskList(taskList) {
            if (taskList.length === 0) {
                return '<div class="empty-state-styled"><span class="empty-icon">‚úÖ</span><span>Nenhuma tarefa</span></div>';
            }
            
            return taskList.map(t => `
                <div style="background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer;"
                     onclick="openTaskModal(${t.id})">
                    <div style="font-weight: 500;">${escapeHtml(t.title)}</div>
                    ${t.priority === 'urgent' || t.priority === 'high' ? 
                        '<div style="font-size: 0.75rem; color: #ef4444; margin-top: 4px;">üî• Alta prioridade</div>' : ''}
                </div>
            `).join('');
        }
        
        // ===========================================
        // SAVE HANDLERS
        // ===========================================
        
        async function saveTask(event) {
            event.preventDefault();
            
            const taskId = document.getElementById('task-id').value;
            const data = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                priority: document.getElementById('task-priority').value,
                status: document.getElementById('task-status').value,
                project_id: document.getElementById('task-project').value || null,
                due_date: document.getElementById('task-due-date').value || null
            };
            
            try {
                if (taskId) {
                    await apiRequest(`/tasks/${taskId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                } else {
                    await apiRequest('/tasks', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }
                
                closeTaskModal();
                showNotification(taskId ? 'Tarefa atualizada!' : 'Tarefa criada!');
                loadTasks();
                updateSummary();
            } catch (error) {
                console.error('Error saving task:', error);
                showNotification('Erro ao salvar tarefa');
            }
        }
        
        async function saveReminder(event) {
            event.preventDefault();
            
            const data = {
                title: document.getElementById('reminder-title').value,
                due_datetime: document.getElementById('reminder-datetime').value,
                priority: document.getElementById('reminder-priority').value
            };
            
            try {
                await apiRequest('/reminders', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                closeReminderModal();
                showNotification('Lembrete criado!');
                loadReminders();
            } catch (error) {
                console.error('Error saving reminder:', error);
                showNotification('Erro ao salvar lembrete');
            }
        }
        
        async function saveNote(event) {
            event.preventDefault();
            
            const data = {
                title: document.getElementById('note-title').value,
                content: document.getElementById('note-content').value,
                meeting_date: document.getElementById('note-date').value
            };
            
            try {
                await apiRequest('/notes', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                closeNoteModal();
                showNotification('Nota salva!');
            } catch (error) {
                console.error('Error saving note:', error);
                showNotification('Erro ao salvar nota');
            }
        }
        
        // ===========================================
        // COMMAND PALETTE
        // ===========================================
        
        function openCommandPalette() {
            document.getElementById('command-palette').classList.add('active');
            document.getElementById('command-input').value = '';
            document.getElementById('command-input').focus();
            document.getElementById('command-results').innerHTML = '';
            commandSelectedIndex = 0; // Reset selection
        }
        
        function closeCommandPalette() {
            document.getElementById('command-palette').classList.remove('active');
        }
        
        function handleCommandInput(query) {
            if (!query.trim()) {
                document.getElementById('command-results').innerHTML = '';
                return;
            }
            
            const results = [];
            const q = query.toLowerCase();
            
            // Search tasks
            tasks.filter(t => t.title.toLowerCase().includes(q)).slice(0, 3).forEach(t => {
                results.push({
                    icon: 'üìã',
                    text: t.title,
                    hint: `Tarefa - ${t.status}`,
                    action: () => openTaskModal(t.id)
                });
            });
            
            // Search projects
            projects.filter(p => p.name.toLowerCase().includes(q)).slice(0, 3).forEach(p => {
                results.push({
                    icon: 'üöÄ',
                    text: p.name,
                    hint: 'Projeto',
                    action: () => window.location.href = `project.html?id=${p.id}`
                });
            });
            
            // Quick actions
            if ('nova tarefa'.includes(q) || 'new task'.includes(q)) {
                results.push({
                    icon: '‚ûï',
                    text: 'Nova Tarefa',
                    hint: 'Criar nova tarefa',
                    action: () => { closeCommandPalette(); openTaskModal(); }
                });
            }
            
            if ('nota'.includes(q) || 'reuni√£o'.includes(q)) {
                results.push({
                    icon: 'üìù',
                    text: 'Nova Nota',
                    hint: 'Criar nota de reuni√£o',
                    action: () => { closeCommandPalette(); openNoteModal(); }
                });
            }
            
            renderCommandResults(results);
        }
        
        function renderCommandResults(results) {
            const container = document.getElementById('command-results');
            commandSelectedIndex = 0; // Reset selection on new results
            
            if (results.length === 0) {
                container.innerHTML = '<div class="command-result"><span style="color: var(--text-muted);">Nenhum resultado</span></div>';
                return;
            }
            
            container.innerHTML = results.map((r, i) => `
                <div class="command-result ${i === 0 ? 'selected' : ''}" onclick="executeCommandResult(${i})">
                    <span class="command-result-icon">${r.icon}</span>
                    <span class="command-result-text">${escapeHtml(r.text)}</span>
                    <span class="command-result-hint">${r.hint}</span>
                </div>
            `).join('');
            
            // Store results for execution
            window.commandResults = results;
        }
        
        function executeCommandResult(index) {
            if (window.commandResults && window.commandResults[index]) {
                window.commandResults[index].action();
                closeCommandPalette();
            }
        }
        
        // ===========================================
        // KEYBOARD SHORTCUTS
        // ===========================================
        
        function setupKeyboardShortcuts() {
            // Track selected task for keyboard navigation
            let selectedTaskIndex = -1;
            
            document.addEventListener('keydown', (e) => {
                // Ignore when typing in inputs
                const isTyping = ['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName);
                const isPaletteOpen = document.getElementById('command-palette').classList.contains('active');
                
                // Command palette (Ctrl + K) - works always
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    if (isPaletteOpen) {
                        closeCommandPalette();
                    } else {
                        openCommandPalette();
                    }
                    return;
                }
                
                // New task (Ctrl + N)
                if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                    e.preventDefault();
                    openTaskModal();
                    return;
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    closeCommandPalette();
                    closeTaskModal();
                    closeReminderModal();
                    closeNoteModal();
                    closeKanbanModal();
                    return;
                }
                
                // Enter to execute selected command result
                if (e.key === 'Enter' && isPaletteOpen) {
                    e.preventDefault();
                    executeCommandResult(commandSelectedIndex);
                    return;
                }
                
                // Skip other shortcuts if typing
                if (isTyping) return;
                
                // === Linear-inspired shortcuts (single key when not typing) ===
                
                // C = Create task
                if (e.key === 'c' || e.key === 'C') {
                    e.preventDefault();
                    openTaskModal();
                    return;
                }
                
                // N = New note
                if (e.key === 'n') {
                    e.preventDefault();
                    openNoteModal();
                    return;
                }
                
                // R = New reminder
                if (e.key === 'r' || e.key === 'R') {
                    e.preventDefault();
                    openReminderModal();
                    return;
                }
                
                // B = Show board/kanban
                if (e.key === 'b' || e.key === 'B') {
                    e.preventDefault();
                    showKanban();
                    return;
                }
                
                // P = Portfolio
                if (e.key === 'p' || e.key === 'P') {
                    e.preventDefault();
                    window.location.href = 'portfolio.html';
                    return;
                }
                
                // M = MBA
                if (e.key === 'm' || e.key === 'M') {
                    e.preventDefault();
                    window.location.href = 'mba.html';
                    return;
                }
                
                // S = Sync
                if (e.key === 's' || e.key === 'S') {
                    e.preventDefault();
                    syncAllData();
                    return;
                }
                
                // ? = Show shortcuts help
                if (e.key === '?') {
                    e.preventDefault();
                    showShortcutsHelp();
                    return;
                }
                
                // 1-3 = Quick filter tasks by status
                if (e.key === '1') {
                    e.preventDefault();
                    filterTasksQuick('todo');
                    return;
                }
                if (e.key === '2') {
                    e.preventDefault();
                    filterTasksQuick('doing');
                    return;
                }
                if (e.key === '3') {
                    e.preventDefault();
                    filterTasksQuick('done');
                    return;
                }
                
                // Arrow navigation in command palette
                if (isPaletteOpen) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        navigateCommandResults(1);
                    }
                    if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        navigateCommandResults(-1);
                    }
                }
            });
        }
        
        // Shortcuts help modal
        function showShortcutsHelp() {
            const shortcuts = [
                { key: 'Ctrl + K', desc: 'Command palette' },
                { key: 'Ctrl + N', desc: 'Nova tarefa' },
                { key: 'C', desc: 'Criar tarefa' },
                { key: 'N', desc: 'Nova nota' },
                { key: 'R', desc: 'Novo lembrete' },
                { key: 'B', desc: 'Ver Kanban board' },
                { key: 'P', desc: 'Portfolio' },
                { key: 'M', desc: 'MBA' },
                { key: 'S', desc: 'Sincronizar dados' },
                { key: '1/2/3', desc: 'Filtrar tarefas (todo/doing/done)' },
                { key: 'Esc', desc: 'Fechar modais' },
                { key: '?', desc: 'Esta ajuda' }
            ];
            
            const html = `
                <div class="shortcuts-modal" onclick="this.remove()">
                    <div class="shortcuts-content" onclick="event.stopPropagation()">
                        <h2>‚å®Ô∏è Atalhos de Teclado</h2>
                        <div class="shortcuts-list">
                            ${shortcuts.map(s => `
                                <div class="shortcut-item">
                                    <kbd>${s.key}</kbd>
                                    <span>${s.desc}</span>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()">Fechar</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function filterTasksQuick(status) {
            // Highlight the status section in mini-kanban
            const statusMap = { 'todo': 'A Fazer', 'doing': 'Fazendo', 'done': 'Feito' };
            showNotification(`Filtro: ${statusMap[status]}`);
            // Could expand to actual filtering logic
        }
        
        function syncAllData() {
            fullSync();
        }
        
        function showNotification(message) {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        
        let commandSelectedIndex = 0;
        
        function navigateCommandResults(direction) {
            const results = document.querySelectorAll('.command-result');
            if (results.length === 0) return;
            
            // Remove previous selection
            results[commandSelectedIndex]?.classList.remove('selected');
            
            // Update index
            commandSelectedIndex += direction;
            if (commandSelectedIndex < 0) commandSelectedIndex = results.length - 1;
            if (commandSelectedIndex >= results.length) commandSelectedIndex = 0;
            
            // Add selection
            results[commandSelectedIndex]?.classList.add('selected');
            results[commandSelectedIndex]?.scrollIntoView({ block: 'nearest' });
        }
        
        // ===========================================
        // UTILITIES
        // ===========================================
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'agora';
            if (diff < 3600) return `h√° ${Math.floor(diff / 60)} min`;
            if (diff < 86400) return `h√° ${Math.floor(diff / 3600)}h`;
            if (diff < 604800) return `h√° ${Math.floor(diff / 86400)} dias`;
            return date.toLocaleDateString('pt-BR');
        }
        
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // ===========================================
        // SYNC SYSTEM
        // ===========================================
        
        function toggleSyncMenu() {
            const dropdown = document.getElementById('sync-dropdown');
            const isOpen = dropdown.classList.contains('open');
            dropdown.classList.toggle('open');
            if (!isOpen) loadSyncStatus();
        }
        
        // Close sync menu when clicking outside
        document.addEventListener('click', (e) => {
            const wrapper = document.querySelector('.sync-dropdown-wrapper');
            if (wrapper && !wrapper.contains(e.target)) {
                document.getElementById('sync-dropdown')?.classList.remove('open');
            }
        });
        
        async function quickReload() {
            document.getElementById('sync-dropdown')?.classList.remove('open');
            showNotification('Atualizando dados...');
            APICache.data.clear();
            await loadAllData();
            showNotification('Dados atualizados!');
        }
        
        async function fullSync() {
            document.getElementById('sync-dropdown')?.classList.remove('open');
            const syncBtn = document.getElementById('sync-btn');
            syncBtn?.classList.add('syncing');
            showNotification('Sincronizando fontes externas...');
            
            try {
                const result = await apiRequest('/sync/all', { method: 'POST' });
                
                const messages = [];
                if (result.confluence?.status === 'ok') messages.push('Confluence OK');
                if (result.confluence?.status === 'error') messages.push('Confluence: erro');
                
                APICache.data.clear();
                await loadAllData();
                
                showNotification(messages.length > 0 ? messages.join(' | ') : 'Sincronizado!');
            } catch (error) {
                console.error('Full sync error:', error);
                showNotification('Erro na sincroniza√ß√£o');
                // Still reload local data
                APICache.data.clear();
                await loadAllData();
            } finally {
                syncBtn?.classList.remove('syncing');
            }
        }
        
        async function syncData() {
            await quickReload();
        }
        
        async function loadSyncStatus() {
            const container = document.getElementById('sync-status-summary');
            if (!container) return;
            
            try {
                const status = await apiRequest('/sync/status');
                
                const items = [];
                
                // Confluence
                if (status.confluence?.last_sync) {
                    items.push(`<div class="sync-status-row"><span>Confluence</span><span>${formatTimeAgo(new Date(status.confluence.last_sync))}</span></div>`);
                } else {
                    items.push(`<div class="sync-status-row not-synced"><span>Confluence</span><span>nunca</span></div>`);
                }
                
                // Calendar
                if (status.calendar?.last_sync) {
                    items.push(`<div class="sync-status-row"><span>Calendario</span><span>${formatTimeAgo(new Date(status.calendar.last_sync))}</span></div>`);
                }
                
                // MBA
                if (status.mba?.last_sync) {
                    items.push(`<div class="sync-status-row"><span>MBA</span><span>${formatTimeAgo(new Date(status.mba.last_sync))}</span></div>`);
                } else {
                    items.push(`<div class="sync-status-row not-synced"><span>MBA</span><span>nunca</span></div>`);
                }
                
                // Notion - check separately
                try {
                    const notionStatus = await apiRequest('/notion/sync/status');
                    if (notionStatus.configured) {
                        items.push(`<div class="sync-status-row"><span>Notion</span><span>pronto</span></div>`);
                    } else {
                        items.push(`<div class="sync-status-row not-synced"><span>Notion</span><span>via MCP</span></div>`);
                    }
                } catch (e) {
                    items.push(`<div class="sync-status-row not-synced"><span>Notion</span><span>‚Äî</span></div>`);
                }
                
                container.innerHTML = items.join('');
            } catch (error) {
                container.innerHTML = '<div class="sync-status-row not-synced"><span>Status indisponivel</span></div>';
            }
        }
        
        async function syncNotion() {
            document.getElementById('sync-dropdown')?.classList.remove('open');
            const syncBtn = document.getElementById('sync-btn');
            syncBtn?.classList.add('syncing');
            showNotification('Sincronizando Notion...');
            
            try {
                const result = await apiRequest('/notion/sync', { method: 'POST' });
                
                if (result.status === 'ok') {
                    showNotification(`Notion: ${result.pages_found} paginas sincronizadas`);
                } else if (result.status === 'not_configured') {
                    showNotification('Notion: use Atlas MCP para sincronizar');
                } else {
                    showNotification('Notion: erro na sincronizacao');
                }
                
                APICache.data.clear();
                await loadAllData();
            } catch (error) {
                console.error('Notion sync error:', error);
                showNotification('Erro ao sincronizar Notion');
            } finally {
                syncBtn?.classList.remove('syncing');
            }
        }
    </script>
</body>
</html>
