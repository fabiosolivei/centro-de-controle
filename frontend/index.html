<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d1117">
    <meta name="description" content="Centro de Controle - Dashboard do F√°bio">
    <title>Centro de Controle</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="css/style.css?v=22">
    <link rel="manifest" href="manifest.json">
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Auth Check -->
    <script>
        if (!sessionStorage.getItem('auth_token')) {
            window.location.href = 'login';
        }
    </script>
    <!-- GPM Dashboard Styles moved to style.css -->
</head>
<body>
    <a href="#main-content" class="skip-link">Pular para o conteudo</a>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <h1 class="logo">Centro de Controle</h1>
            <nav class="header-nav">
                <a href="./" class="nav-link active" aria-label="Dashboard">Dashboard</a>
                <a href="mba" class="nav-link" aria-label="MBA">MBA</a>
                <a href="work" class="nav-link" aria-label="Work Status">Work</a>
                <a href="files" class="nav-link" aria-label="Arquivos">Arquivos</a>
                <a href="observability" class="nav-link" aria-label="Observability">Observability</a>
            </nav>
            <div class="header-actions">
                <button class="btn-icon" onclick="openCommandPalette()" title="Buscar (Ctrl+K)" aria-label="Buscar">
                    <span>üîç</span>
                </button>
                <div class="sync-dropdown-wrapper">
                    <button class="btn-icon" onclick="toggleSyncMenu()" title="Sincronizar" aria-label="Sincronizar dados" id="sync-btn">
                        <span>üîÑ</span>
                    </button>
                    <div class="sync-dropdown" id="sync-dropdown">
                        <div class="sync-dropdown-item" onclick="quickReload()">
                            <span>‚ö°</span> Atualizar dados
                            <small>Recarrega cache local</small>
                        </div>
                        <div class="sync-dropdown-divider"></div>
                        <div class="sync-dropdown-label">Sincronizar fonte</div>
                        <div class="sync-dropdown-item sync-source" onclick="syncSource('confluence')">
                            <span class="sync-source-icon">üè¢</span>
                            <div class="sync-source-info">
                                <span>Confluence</span>
                                <small class="sync-ts" id="ts-confluence">--</small>
                            </div>
                            <span class="sync-source-badge" id="badge-confluence"></span>
                        </div>
                        <div class="sync-dropdown-item sync-source" onclick="syncSource('notion')">
                            <span class="sync-source-icon">üìì</span>
                            <div class="sync-source-info">
                                <span>Notion</span>
                                <small class="sync-ts" id="ts-notion">--</small>
                            </div>
                            <span class="sync-source-badge" id="badge-notion"></span>
                        </div>
                        <div class="sync-dropdown-item sync-source" onclick="syncSource('calendar')">
                            <span class="sync-source-icon">üìÖ</span>
                            <div class="sync-source-info">
                                <span>Calendario</span>
                                <small class="sync-ts" id="ts-calendar">--</small>
                            </div>
                            <span class="sync-source-badge" id="badge-calendar"></span>
                        </div>
                        <div class="sync-dropdown-item sync-source" onclick="syncSource('mba')">
                            <span class="sync-source-icon">üéì</span>
                            <div class="sync-source-info">
                                <span>MBA / Adalove</span>
                                <small class="sync-ts" id="ts-mba">--</small>
                            </div>
                            <span class="sync-source-badge" id="badge-mba"></span>
                        </div>
                        <div class="sync-dropdown-divider"></div>
                        <div class="sync-dropdown-item" onclick="fullSync()">
                            <span>üîÑ</span> Sincronizar tudo
                            <small>Todas as fontes de uma vez</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main-content dashboard-page" id="main-content">
        <!-- HERO BAR (compact) -->
        <div class="hero-bar">
            <div class="hero-bar-left">
                <h2 id="greeting-message" class="hero-title">Bom dia, Fabio</h2>
                <p id="greeting-summary" class="hero-summary"><span class="skeleton skeleton-text" style="height:14px;width:50%;display:inline-block;"></span></p>
            </div>
            <div class="hero-bar-right">
                <div class="summary-chips" id="summary-chips">
                    <!-- Populated by JS -->
                </div>
                <div class="hero-actions">
                    <button class="quick-action" onclick="openTaskModal()" aria-label="Nova Tarefa">
                        <span>‚ûï</span> Tarefa
                    </button>
                    <button class="quick-action quick-action-icon" onclick="openNoteModal()" aria-label="Nova Nota" title="Nova Nota">
                        <span>üìù</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- OFFLINE BANNER -->
        <div id="offline-banner" class="offline-banner" style="display:none;">
            <span>Backend indisponivel -- dados podem estar desatualizados</span>
            <button onclick="loadAllData()">Tentar novamente</button>
        </div>

        <!-- DASHBOARD WITH SIDEBAR LAYOUT -->
        <div class="dashboard-with-sidebar">

            <!-- LIFE OS SIDEBAR (desktop only, collapsible) -->
            <aside class="life-os-sidebar" id="life-os-sidebar">
                <div class="sidebar-header" onclick="toggleLifeOsSidebar()">
                    <span class="sidebar-title">üß† Life OS</span>
                    <span class="sidebar-toggle" id="sidebar-toggle-icon">‚óÄ</span>
                </div>
                <div class="sidebar-body" id="life-os-sidebar-body">
                    <div id="life-os-summary" style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:0.75rem;">
                        <div class="skeleton skeleton-text" style="height:14px;width:80%;"></div>
                    </div>
                    <div id="life-os-messages"></div>
                </div>
            </aside>

            <!-- MAIN DASHBOARD AREA -->
            <div class="dashboard-main-area">

                <!-- CONTEXT ROW: Priority Pulse + Weekly Brief side by side -->
                <div class="top-context-row">
                    <!-- PRIORITY PULSE -->
                    <div class="priority-pulse" id="priority-pulse" style="display:none;">
                        <div class="pulse-header">
                            <div class="pulse-title">PRIORITY PULSE</div>
                            <div class="pulse-count" id="pulse-count">0 items</div>
                        </div>
                        <div class="pulse-items" id="pulse-items">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- WEEKLY BRIEF -->
                    <div class="weekly-brief-panel" id="weekly-brief-panel">
                        <div class="pulse-header">
                            <div class="pulse-title">WEEKLY BRIEF</div>
                            <span class="brief-week-range" id="brief-week-range"></span>
                        </div>
                        <div id="brief-gauges" class="brief-gauges"></div>
                        <div id="brief-actions" class="brief-actions"></div>
                        <div id="brief-calendar" class="brief-calendar"></div>
                        <div id="brief-footer" class="brief-footer"></div>
                        <div id="brief-detail" class="brief-detail" style="display:none;"></div>
                    </div>
                </div>

                <!-- MAIN DASHBOARD GRID -->
                <div class="dashboard-grid">
                    <!-- LEFT COLUMN: Today + Tasks -->
                    <div class="today-column">
                <!-- Agenda -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üìÖ Agenda de Hoje</h2>
                        <span class="section-action" onclick="refreshCalendar()">Atualizar</span>
                    </div>
                    <div id="agenda-list">
                        <div class="skeleton skeleton-list" style="height:120px;"></div>
                    </div>
                </section>
                
                <!-- Tasks Summary -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üìã Tarefas</h2>
                        <button class="section-action" onclick="showKanban()" type="button">Ver Kanban</button>
                    </div>
                    <div class="kanban-mini">
                        <div class="kanban-mini-col todo">
                            <div class="kanban-mini-count" id="count-todo">0</div>
                            <div class="kanban-mini-label">A Fazer</div>
                        </div>
                        <div class="kanban-mini-col doing">
                            <div class="kanban-mini-count" id="count-doing">0</div>
                            <div class="kanban-mini-label">Fazendo</div>
                        </div>
                        <div class="kanban-mini-col done">
                            <div class="kanban-mini-count" id="count-done">0</div>
                            <div class="kanban-mini-label">Feito</div>
                        </div>
                    </div>
                    <div id="urgent-tasks" style="margin-top: var(--spacing-md);">
                        <!-- Urgent tasks shown here -->
                    </div>
                </section>
                
                <!-- MBA Quick View -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üéì MBA Inteli</h2>
                        <a class="section-action" href="mba">Ver detalhes</a>
                    </div>
                    <div class="kanban-mini">
                        <div class="kanban-mini-col todo">
                            <div class="kanban-mini-count" id="mba-pendentes"><span class="skeleton skeleton-text" style="height:20px;width:24px;display:inline-block;"></span></div>
                            <div class="kanban-mini-label">Pendentes</div>
                        </div>
                        <div class="kanban-mini-col doing">
                            <div class="kanban-mini-count" id="mba-andamento"><span class="skeleton skeleton-text" style="height:20px;width:24px;display:inline-block;"></span></div>
                            <div class="kanban-mini-label">Em Andamento</div>
                        </div>
                        <div class="kanban-mini-col done">
                            <div class="kanban-mini-count" id="mba-concluidas"><span class="skeleton skeleton-text" style="height:20px;width:24px;display:inline-block;"></span></div>
                            <div class="kanban-mini-label">Conclu√≠das</div>
                        </div>
                    </div>
                    <div id="mba-deadlines" style="margin-top: var(--spacing-md);">
                        <!-- MBA deadlines shown here -->
                    </div>
                </section>
            </div>
            
            <!-- RIGHT COLUMN: Portfolio + Updates -->
            <div class="today-column">
                <!-- Work Portfolio -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üíº Projetos Trabalho</h2>
                        <span class="section-action" style="visibility:hidden;">Ver detalhes</span>
                    </div>
                    <div class="portfolio-grid" id="portfolio-grid">
                        <div class="skeleton skeleton-list" style="height:100px;"></div>
                    </div>
                </section>
                
                <!-- Work Status (Confluence) -->
                <section class="card">
                    <div class="section-header-row">
                        <h2 class="section-title">üìä Work Status</h2>
                        <a class="section-action" href="work">Ver detalhes</a>
                    </div>
                    <div class="kanban-mini" id="work-status-mini">
                        <div class="kanban-mini-col todo">
                            <div class="kanban-mini-count" id="work-initiatives">-</div>
                            <div class="kanban-mini-label">Initiatives</div>
                        </div>
                        <div class="kanban-mini-col doing">
                            <div class="kanban-mini-count" id="work-epics">-</div>
                            <div class="kanban-mini-label">Epics</div>
                        </div>
                        <div class="kanban-mini-col done">
                            <div class="kanban-mini-count" id="work-sprints">-</div>
                            <div class="kanban-mini-label">Sprints</div>
                        </div>
                    </div>
                    <div id="work-alerts" style="margin-top: var(--spacing-md);">
                        <!-- Work alerts (risks/bugs) shown here -->
                    </div>
                </section>
                
                <!-- Weekly Brief moved to top-context-row -->
                
                <!-- Observability Summary -->
                <section class="card" data-collapsible="observability">
                    <div class="section-header-row" onclick="toggleCardCollapse(this.parentElement)">
                        <h2 class="section-title">üì° Observability</h2>
                        <a href="observability" class="section-action" style="text-decoration:none;color:var(--accent-blue);" onclick="event.stopPropagation();">Ver detalhes</a>
                    </div>
                    <div class="card-body">
                        <div id="obs-summary" style="font-size:0.85rem;color:var(--text-secondary);">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
                                <div style="background:var(--bg-card);padding:8px 12px;border-radius:8px;">
                                    <div style="font-size:0.7rem;color:var(--text-muted);" title="Porcentagem de chamadas MCP que funcionaram nas ultimas 24h">Tool Health</div>
                                    <div style="font-size:1.2rem;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;" id="obs-tool-health">--</div>
                                </div>
                                <div style="background:var(--bg-card);padding:8px 12px;border-radius:8px;">
                                    <div style="font-size:0.7rem;color:var(--text-muted);" title="Ultima avaliacao de qualidade do routing da Nova">Last Eval</div>
                                    <div style="font-size:1.2rem;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;" id="obs-last-eval">--</div>
                                </div>
                            </div>
                            <div style="font-size:0.75rem;color:var(--text-muted);" id="obs-report-summary"><div class="skeleton skeleton-text" style="height:12px;width:50%;"></div></div>
                        </div>
                    </div>
                </section>
            </div>
        </div><!-- end dashboard-grid -->

            </div><!-- end dashboard-main-area -->
        </div><!-- end dashboard-with-sidebar -->

        <!-- LIFE OS INLINE (mobile only, hidden on desktop) -->
        <div class="life-os-mobile" id="life-os-mobile">
            <section class="card" data-collapsible="life-os">
                <div class="section-header-row" onclick="toggleCardCollapse(this.parentElement)">
                    <h2 class="section-title">üß† Life OS</h2>
                    <span class="section-action" onclick="event.stopPropagation();toggleLifeOsExpand()" id="life-os-toggle">Ver mais</span>
                </div>
                <div class="card-body">
                    <div id="life-os-summary-mobile" style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">
                        <div class="skeleton skeleton-text" style="height:14px;width:60%;"></div>
                    </div>
                    <div id="life-os-messages-mobile" style="display:none;"></div>
                </div>
            </section>
        </div>

    </main>

    <!-- COMMAND PALETTE -->
    <div class="command-palette" id="command-palette">
        <div class="command-input-wrapper">
            <input type="text" class="command-input" id="command-input" 
                   placeholder="Buscar projetos, tarefas, notas... (Esc para fechar)"
                   aria-label="Buscar projetos, tarefas, notas"
                   oninput="handleCommandInput(this.value)">
            <div class="command-results" id="command-results"></div>
        </div>
    </div>

    <!-- KEYBOARD HINT -->
    <div class="keyboard-hint-float" onclick="document.dispatchEvent(new KeyboardEvent('keydown',{key:'?'}))">
        Pressione <kbd>?</kbd> para atalhos
    </div>

    <!-- FOOTER -->
    <footer class="site-footer">Centro de Controle &mdash; Nova &amp; Atlas</footer>

    <!-- TASK MODAL -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="task-modal-title">Nova Tarefa</h3>
                <button class="btn-close" onclick="closeTaskModal()">‚úï</button>
            </div>
            <form id="task-form" onsubmit="saveTask(event)">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label for="task-title">T√≠tulo *</label>
                    <input type="text" id="task-title" required placeholder="O que precisa fazer?">
                </div>
                <div class="form-group">
                    <label for="task-description">Descri√ß√£o</label>
                    <textarea id="task-description" rows="3" placeholder="Detalhes (opcional)"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="task-priority">Prioridade</label>
                        <select id="task-priority">
                            <option value="low">Baixa</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">Alta</option>
                            <option value="urgent">Urgente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-status">Status</label>
                        <select id="task-status">
                            <option value="todo">A Fazer</option>
                            <option value="doing">Fazendo</option>
                            <option value="done">Feito</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="task-project">Projeto</label>
                    <select id="task-project">
                        <option value="">Sem projeto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="task-due-date">Data limite</label>
                    <input type="date" id="task-due-date">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeTaskModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NOTE MODAL -->
    <div class="modal" id="note-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="note-modal-title">Nova Nota</h3>
                <button class="btn-close" onclick="closeNoteModal()">‚úï</button>
            </div>
            <form id="note-form" onsubmit="saveNote(event)">
                <input type="hidden" id="note-id">
                <div class="form-group">
                    <label for="note-title">T√≠tulo *</label>
                    <input type="text" id="note-title" required placeholder="T√≠tulo da reuni√£o/nota">
                </div>
                <div class="form-group">
                    <label for="note-date">Data da Reuni√£o</label>
                    <input type="date" id="note-date">
                </div>
                <div class="form-group">
                    <label for="note-content">Conte√∫do</label>
                    <textarea id="note-content" rows="6" placeholder="Anota√ß√µes da reuni√£o..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeNoteModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- KANBAN MODAL -->
    <div class="modal" id="kanban-modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header">
                <h3>Kanban - Todas as Tarefas</h3>
                <button class="btn-close" onclick="closeKanbanModal()">‚úï</button>
            </div>
            <div class="kanban-board" id="kanban-board-full" style="padding: 20px;">
                <!-- Full kanban board here -->
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="js/api.js?v=7"></script>
    <script>
        // ===========================================
        // GPM DASHBOARD - MAIN SCRIPT
        // ===========================================
        
        // API_BASE is already defined in api.js
        
        // State
        let tasks = [];
        let projects = [];
        let workProjects = [];
        
        // ===========================================
        // INITIALIZATION
        // ===========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            updateGreeting();
            loadAllData();
            setupKeyboardShortcuts();
            initCollapsibleCards();
        });
        
        function updateGreeting() {
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Bom dia' : hour < 18 ? 'Boa tarde' : 'Boa noite';
            document.getElementById('greeting-message').textContent = `${greeting}, Fabio`;
        }
        
        // Shared state for Priority Pulse
        let _calendarEvents = [];
        let _mbaDeadlines = [];
        let _workAlerts = {};
        let _apiOnline = true;

        async function loadAllData() {
            // Health check first
            try {
                const health = await fetch(`${API_BASE}/health`, { signal: AbortSignal.timeout(5000) });
                _apiOnline = health.ok;
            } catch {
                _apiOnline = false;
            }
            const banner = document.getElementById('offline-banner');
            if (banner) banner.style.display = _apiOnline ? 'none' : 'flex';

            try {
                await Promise.all([
                    loadTasks(),
                    loadProjects(),
                    loadWorkProjects(),
                    loadCalendarEvents(),
                    loadMBAStats(),
                    loadWorkStatus()
                ]);
                updateSummary();
                buildPriorityPulse();
                loadWeeklyBrief();
                loadLifeOS();
                loadObsSummary();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // ===========================================
        // TASKS
        // ===========================================
        
        async function loadTasks() {
            try {
                tasks = await apiRequest('/tasks');
                if (!Array.isArray(tasks)) tasks = [];
                renderTaskCounts();
                renderUrgentTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
                tasks = [];
            }
        }
        
        function renderTaskCounts() {
            const todo = tasks.filter(t => t.status === 'todo').length;
            const doing = tasks.filter(t => t.status === 'doing').length;
            const done = tasks.filter(t => t.status === 'done').length;
            
            document.getElementById('count-todo').textContent = todo;
            document.getElementById('count-doing').textContent = doing;
            document.getElementById('count-done').textContent = done;
        }
        
        function renderUrgentTasks() {
            const urgent = tasks.filter(t => 
                (t.priority === 'urgent' || t.priority === 'high') && 
                t.status !== 'done'
            );
            
            const container = document.getElementById('urgent-tasks');
            
            if (urgent.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 0.75rem; color: #ef4444; margin-bottom: 8px; font-weight: 600;">
                        üî• ${urgent.length} tarefa${urgent.length > 1 ? 's' : ''} urgente${urgent.length > 1 ? 's' : ''}
                    </div>
                    ${urgent.slice(0, 3).map(t => `
                        <div style="padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-bottom: 4px; font-size: 0.875rem;">
                            ${escapeHtml(t.title)}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // ===========================================
        // PROJECTS
        // ===========================================
        
        async function loadProjects() {
            try {
                projects = await apiRequest('/projects');
                if (!Array.isArray(projects)) projects = [];
            } catch (error) {
                console.error('Error loading projects:', error);
                projects = [];
            }
        }
        
        let reportCards = {};
        
        async function loadWorkProjects() {
            try {
                const data = await apiRequest('/work-projects');
                workProjects = data.projects || [];
            } catch (error) {
                console.error('Error loading work projects:', error);
                workProjects = [];
            }
            
            // Load report cards in parallel
            try {
                const rcData = await WorkProjectsAPI.getReportCards();
                reportCards = rcData.report_cards || {};
            } catch (error) {
                console.error('Error loading report cards:', error);
                reportCards = {};
            }
            
            renderPortfolio();
        }
        
        function renderPortfolio() {
            const container = document.getElementById('portfolio-grid');
            
            // Get work projects from database
            const workDbProjects = projects.filter(p => p.category === 'trabalho');
            
            if (workDbProjects.length === 0) {
                container.innerHTML = '<div class="empty-state-styled"><span class="empty-icon">üíº</span><span>Nenhum projeto de trabalho</span></div>';
                return;
            }
            
            // Slug lookup from project name
            const NAME_TO_SLUG = {
                '3TPM': '3tpm', '3tpm': '3tpm',
                'Catalog Admin': 'catalog-admin', 'Catalog': 'catalog-admin', 'CATALOG-ADMIN': 'catalog-admin',
                'Company Store': 'company-store', 'COMPANY-STORE': 'company-store',
                'Company & Store': 'company-store',
                'CMS DAM': 'cms-dam', 'CMS-DAM': 'cms-dam', 'CMS / DAM': 'cms-dam',
                'CMS': 'cms-dam', 'DAM': 'cms-dam', 'DAM - Documenta√ß√£o': 'cms-dam',
                'POCs IA': 'pocs-ia', 'POCS-IA': 'pocs-ia',
                'Autonomy': 'autonomy', 'AUTONOMY-AUTOMATION': 'autonomy'
            };
            
            container.innerHTML = workDbProjects.map(project => {
                const slug = NAME_TO_SLUG[project.name] || project.name.toLowerCase().replace(/\s+/g, '-');
                const rc = reportCards[slug];
                
                // Health dot
                let healthDot = '';
                let healthMeta = '';
                if (rc && !rc.error) {
                    const colors = { green: '#22c55e', yellow: '#eab308', red: '#ef4444' };
                    const color = colors[rc.health] || colors.green;
                    healthDot = `<span class="health-dot" style="background:${color};" title="${escapeHtml(rc.health_reason || '')}"></span>`;
                    
                    // Build subtitle chips
                    const chips = [];
                    if (rc.meetings_count > 0) chips.push(`${rc.meetings_count} meeting${rc.meetings_count > 1 ? 's' : ''}`);
                    if (rc.confluence && rc.confluence.current_sprint) chips.push(rc.confluence.current_sprint);
                    if (rc.confluence && rc.confluence.risks > 0) chips.push(`${rc.confluence.risks} risk${rc.confluence.risks > 1 ? 's' : ''}`);
                    if (rc.confluence && rc.confluence.epics_open > 0) chips.push(`${rc.confluence.epics_open} epics`);
                    
                    if (chips.length > 0) {
                        healthMeta = `<div class="portfolio-meta">${chips.join(' ¬∑ ')}</div>`;
                    }
                }
                
                return `
                <div class="portfolio-card ${project.priority === 'high' ? 'high-priority' : ''}" 
                     onclick="window.location.href='project.html?id=${project.id}'">
                    <div class="portfolio-info">
                        <div class="portfolio-name">${healthDot}${escapeHtml(project.name)}</div>
                        <div class="portfolio-status">
                            ${project.status === 'active' ? 'üü¢ Ativo' : project.status === 'paused' ? 'üü° Pausado' : '‚úÖ Conclu√≠do'}
                        </div>
                        ${healthMeta}
                    </div>
                    <div class="portfolio-progress">
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini" style="width: ${project.progress || 0}%"></div>
                        </div>
                        <span class="progress-text">${project.progress || 0}%</span>
                    </div>
                </div>`;
            }).join('');
        }
        
        // ===========================================
        // CALENDAR
        // ===========================================
        
        async function loadCalendarEvents() {
            try {
                const events = await apiRequest('/calendar/today');
                _calendarEvents = Array.isArray(events) ? events : [];
                renderAgenda(events);
            } catch (error) {
                console.error('Error loading calendar:', error);
                _calendarEvents = [];
                document.getElementById('agenda-list').innerHTML = 
                    '<div class="empty-state-styled error"><span class="empty-icon">‚ö†Ô∏è</span><span>Nao foi possivel carregar a agenda</span><span class="section-action" onclick="loadCalendarEvents()" style="margin-left:8px;cursor:pointer;">Tentar novamente</span></div>';
            }
        }
        
        function renderAgenda(events) {
            const container = document.getElementById('agenda-list');
            
            if (!Array.isArray(events) || events.length === 0) {
                container.innerHTML = '<div class="empty-state-styled"><span class="empty-icon">‚úÖ</span><span>Nenhum evento restante hoje</span></div>';
                return;
            }
            
            container.innerHTML = events.slice(0, 5).map(event => `
                <div class="agenda-item">
                    <span class="agenda-time">${event.time || '--:--'}</span>
                    <span class="agenda-title">${escapeHtml(event.summary || event.title)}</span>
                </div>
            `).join('');
        }
        
        function refreshCalendar() {
            loadCalendarEvents();
        }
        
        // ===========================================
        // MBA
        // ===========================================
        
        async function loadMBAStats() {
            try {
                // Use same endpoint as MBA page, with fallback to static data
                let mbaData;
                try {
                    mbaData = await MBAAPI.getData();
                } catch {
                    console.log('MBA API unavailable, using static fallback');
                    mbaData = null;
                }
                
                let _mbaUsingCache = false;
                if (!mbaData || !mbaData.turmas) {
                    // Static fallback with known MBA data (same as mba.html getStaticData)
                    mbaData = getMBAStaticFallback();
                    _mbaUsingCache = true;
                }
                
                if (!mbaData || !mbaData.turmas) {
                    document.getElementById('mba-pendentes').textContent = '-';
                    document.getElementById('mba-andamento').textContent = '-';
                    document.getElementById('mba-concluidas').textContent = '-';
                    return;
                }

                // Calculate stats from turmas data (same logic as mba.html calculateResumo)
                let pendentes = 0, andamento = 0, concluidas = 0;
                const prazos = [];
                
                (mbaData.turmas || []).forEach(turma => {
                    (turma.semanas || []).forEach(semana => {
                        const aFazer = semana.atividades?.a_fazer || [];
                        const fazendo = semana.atividades?.fazendo || [];
                        const feito = semana.atividades?.feito || [];
                        pendentes += aFazer.length;
                        andamento += fazendo.length;
                        concluidas += feito.length;
                        
                        aFazer.forEach(atv => {
                            if (atv.data) {
                                prazos.push({
                                    title: atv.titulo,
                                    data: atv.data,
                                    turma: turma.nome?.split(' - ')[0] || turma.tipo || ''
                                });
                            }
                        });
                    });
                });

                document.getElementById('mba-pendentes').textContent = pendentes;
                document.getElementById('mba-andamento').textContent = andamento;
                document.getElementById('mba-concluidas').textContent = concluidas;
                
                // Store deadlines for Priority Pulse
                _mbaDeadlines = prazos;
                
                // Show upcoming deadlines on the card
                if (prazos.length > 0) {
                    const deadlinesHtml = prazos.slice(0, 2).map(d => {
                        const isOverdue = parseMBADate(d.data) < new Date();
                        return `
                            <div style="padding: 8px; background: ${isOverdue ? 'rgba(239, 68, 68, 0.1)' : 'rgba(234, 179, 8, 0.1)'}; border-radius: 6px; margin-bottom: 4px; font-size: 0.875rem; border-left: 3px solid ${isOverdue ? '#ef4444' : 'transparent'};">
                                ${isOverdue ? '‚ö†Ô∏è' : 'üìÖ'} ${escapeHtml(d.title)} - ${d.data}${isOverdue ? ' <span style="color:#ef4444;font-weight:600;font-size:0.75rem;">ATRASADO</span>' : ''}
                            </div>
                        `;
                    }).join('');
                    document.getElementById('mba-deadlines').innerHTML = deadlinesHtml;
                }
                
                // Show cache badge if using fallback
                if (_mbaUsingCache) {
                    const headerRow = document.querySelector('.card:has(#mba-pendentes) .section-header-row');
                    if (headerRow && !headerRow.querySelector('.cache-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'cache-badge';
                        badge.textContent = 'Dados em cache';
                        badge.style.cssText = 'font-size:0.65rem;background:rgba(234,179,8,0.15);color:#eab308;padding:2px 6px;border-radius:4px;margin-left:auto;';
                        headerRow.insertBefore(badge, headerRow.querySelector('.section-action'));
                    }
                }
            } catch (error) {
                console.error('Error loading MBA stats:', error);
            }
        }
        
        function parseMBADate(dateStr) {
            // Parse "DD/MM/YYYY - HH:MMh" or "DD/MM/YYYY"
            if (!dateStr) return new Date(0);
            const parts = dateStr.split(' - ');
            const dateParts = parts[0].split('/');
            if (dateParts.length < 3) return new Date(0);
            const day = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1;
            const year = parseInt(dateParts[2], 10);
            if (parts[1]) {
                const timeParts = parts[1].replace('h', '').split(':');
                return new Date(year, month, day, parseInt(timeParts[0], 10), parseInt(timeParts[1], 10));
            }
            return new Date(year, month, day);
        }
        
        function getMBAStaticFallback() {
            // MUST match mba.html getStaticData() turmas exactly
            return {
                turmas: [
                    {
                        id: "2026-1A-T30-P",
                        nome: "MBA IA - TURMA 1 - 2026.1A",
                        tipo: "MBA",
                        orientador: "Victor Machado da Silva",
                        inicio: "2026-02-02",
                        nota_acumulada: 0.0,
                        grupo: "G08",
                        semanas: [{
                            numero: 1,
                            status: "em_andamento",
                            atividades: {
                                a_fazer: [
                                    { titulo: "Material Encontro Orientacao 02/02", data: "02/02/2026 - 19:00h" },
                                    { titulo: "Gravacao Encontro Orientacao 02/02", data: "03/02/2026 - 19:00h" }
                                ],
                                fazendo: [
                                    { titulo: "Business Case - Modulo 1" }
                                ],
                                feito: [
                                    { titulo: "Calendario Academico", data: "30/01/2026" },
                                    { titulo: "Material Onboarding Alunos", data: "30/01/2026" },
                                    { titulo: "Gravacao Aula Inaugural", data: "31/01/2026" }
                                ]
                            }
                        }]
                    },
                    {
                        id: "2026-1A-T33-P",
                        nome: "Eletiva Data Engineering - 2026.1A",
                        tipo: "Eletiva",
                        orientador: "Afonso Cesar Lelis Brandao",
                        inicio: "2026-02-02",
                        semanas: [{
                            numero: 1,
                            nome: "Data Engineering",
                            status: "em_andamento",
                            atividades: {
                                a_fazer: [
                                    { titulo: "Videoaulas - Eletiva Data Engineering", data: "06/02/2026 - 19:00h" },
                                    { titulo: "Material Professor - Eletiva Data Engineering", data: "07/02/2026 - 19:00h" }
                                ],
                                fazendo: [],
                                feito: []
                            }
                        }]
                    }
                ]
            };
        }
        
        // ===========================================
        // WORK STATUS (CONFLUENCE)
        // ===========================================
        
        async function loadWorkStatus() {
            try {
                const summary = await apiRequest('/confluence/summary');
                
                // Store for Priority Pulse
                _workAlerts = summary;

                // Update counts
                document.getElementById('work-initiatives').textContent = summary.initiatives || 0;
                document.getElementById('work-epics').textContent = summary.epics || 0;
                document.getElementById('work-sprints').textContent = summary.sprints || 0;
                
                // Show alerts for risks and bugs
                const alertsContainer = document.getElementById('work-alerts');
                let alertsHtml = '';
                
                if (summary.risks > 0) {
                    alertsHtml += `
                        <div style="padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-bottom: 4px; font-size: 0.875rem; display: flex; align-items: center; gap: 8px;">
                            <span>‚ö†Ô∏è</span>
                            <span style="color: #f87171; font-weight: 600;">${summary.risks}</span>
                            <span>riscos ativos</span>
                        </div>
                    `;
                }
                
                if (summary.bugs > 0) {
                    alertsHtml += `
                        <div style="padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; margin-bottom: 4px; font-size: 0.875rem; display: flex; align-items: center; gap: 8px;">
                            <span>üêõ</span>
                            <span style="color: #fbbf24; font-weight: 600;">${summary.bugs}</span>
                            <span>bugs ativos</span>
                        </div>
                    `;
                }
                
                if (summary.current_sprint) {
                    alertsHtml += `
                        <div style="padding: 8px; background: rgba(99, 102, 241, 0.1); border-radius: 6px; font-size: 0.875rem;">
                            üèÉ <strong>${escapeHtml(summary.current_sprint)}</strong>
                        </div>
                    `;
                }
                
                alertsContainer.innerHTML = alertsHtml || '<p style="color: var(--text-muted); font-size: 0.875rem;">Tudo em dia!</p>';
                
            } catch (error) {
                console.log('Work status not available - Confluence sync needed');
                _workAlerts = {};
                document.getElementById('work-initiatives').textContent = '-';
                document.getElementById('work-epics').textContent = '-';
                document.getElementById('work-sprints').textContent = '-';
                document.getElementById('work-alerts').innerHTML = 
                    '<div class="sync-badge not-synced"><span>üîó</span> Nao sincronizado <span class="section-action" onclick="loadWorkStatus()" style="margin-left:8px;cursor:pointer;">Tentar novamente</span></div>';
            }
        }
        
        // ===========================================
        // REMINDERS
        // ===========================================
        
        // ===========================================
        // WEEKLY BRIEF
        // ===========================================
        
        let weeklyBriefData = null;
        let briefExpanded = false;
        let briefSelectedDate = null;
        let briefParsedDays = [];
        
        async function loadWeeklyBrief() {
            try {
                weeklyBriefData = await apiRequest('/weekly-brief');
                renderWeeklyBrief();
            } catch (error) {
                console.log('Weekly Brief not available:', error.message);
                const el = document.getElementById('brief-gauges');
                if (el) el.innerHTML = '<span style="color:var(--text-muted);font-size:0.8rem;">Nenhum brief disponivel</span>';
            }
        }
        
        function briefGaugeColor(val) {
            if (val > 10) return 'brief-gauge-red';
            if (val >= 6) return 'brief-gauge-amber';
            return 'brief-gauge-green';
        }
        
        // Deep link map: keyword -> internal page
        const BRIEF_LINK_MAP = [
            { pattern: /MBA|Artefatos|elective|eletiva/i, href: 'mba', label: 'MBA' },
            { pattern: /Catalog|Book AI/i, href: 'project.html?id=1', label: 'Catalog' },
            { pattern: /CMS|Content|Braze|banner/i, href: 'project.html?id=2', label: 'CMS' },
            { pattern: /DAM|uploader|Acquia/i, href: 'project.html?id=3', label: 'DAM' },
            { pattern: /3TPM|Korea|Visagio/i, href: 'work', label: 'Work' },
            { pattern: /CloudOps|SRE|Sprint|blocker/i, href: 'work', label: 'Work' },
            { pattern: /Deep\s*Link|Feedback|Milano/i, href: 'work', label: 'Work' },
        ];
        
        function briefItemLink(text) {
            for (const m of BRIEF_LINK_MAP) {
                if (m.pattern.test(text)) return m;
            }
            return null;
        }
        
        // Render a single action item with CRUD controls and deep link
        function renderBriefItem(item, section, index, cssClass) {
            const text = item.action || item.decision || item.text || item;
            const deadline = item.deadline || '';
            const context = item.context || item.options || '';
            const isCompleted = item.completed === true;
            const link = briefItemLink(typeof text === 'string' ? text : '');
            const linkHtml = link ? `<a class="brief-item-link" href="${link.href}">${link.label}</a>` : '';
            const rightLabel = deadline || context;
            const completedClass = isCompleted ? ' brief-item-completed' : '';
            
            return `<div class="brief-action-item ${cssClass || ''}${completedClass}" data-section="${section}" data-index="${index}">
                <span class="brief-crud-check" onclick="briefCompleteItem('${section}', ${index})" title="${isCompleted ? 'Desmarcar' : 'Completar'}">&#10003;</span>
                <span class="brief-action-text">${escapeHtml(typeof text === 'string' ? text : JSON.stringify(text))}</span>
                ${linkHtml}
                ${rightLabel ? `<span class="brief-action-deadline">${escapeHtml(rightLabel)}</span>` : ''}
                <span class="brief-crud-remove" onclick="briefRemoveItem('${section}', ${index})" title="Remover">&minus;</span>
            </div>`;
        }
        
        // Section header with + button
        function renderBriefSectionHeader(label, section, cssClass) {
            return `<div class="brief-detail-header">
                <div class="brief-detail-label ${cssClass}">${label}</div>
                <span class="brief-crud-add" onclick="briefShowAddInput('${section}', this)" title="Adicionar">+</span>
            </div>
            <div class="brief-add-input-wrap" id="brief-add-${section}" style="display:none;">
                <input class="brief-add-input" type="text" placeholder="Nova acao..." onkeydown="briefAddKeydown(event, '${section}')" />
            </div>`;
        }
        
        function renderWeeklyBrief() {
            const gaugesEl = document.getElementById('brief-gauges');
            const actionsEl = document.getElementById('brief-actions');
            const calendarEl = document.getElementById('brief-calendar');
            const footerEl = document.getElementById('brief-footer');
            const detailEl = document.getElementById('brief-detail');
            const rangeEl = document.getElementById('brief-week-range');
            if (!gaugesEl || !weeklyBriefData) return;
            
            const b = weeklyBriefData;
            
            // Week range in header
            if (rangeEl && b.week_start) {
                const start = new Date(b.week_start + 'T00:00:00');
                const end = new Date(start); end.setDate(end.getDate() + 4);
                const fmt = (d) => d.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }).replace('.', '');
                rangeEl.textContent = fmt(start) + ' - ' + fmt(end);
            }
            
            // Gauges ‚Äî 3 colored dots
            if (b.energy_check) {
                const e = b.energy_check;
                const items = [
                    { label: 'Reunioes', val: e.meeting_load || 0 },
                    { label: 'Deadlines', val: e.deadline_press || 0 },
                    { label: 'Energia', val: e.energy_risk || 0 }
                ];
                gaugesEl.innerHTML = items.map(g => `
                    <div class="brief-gauge">
                        <span class="brief-gauge-dot ${briefGaugeColor(g.val)}"></span>
                        <span class="brief-gauge-label">${g.label}</span>
                        <span class="brief-gauge-val">${g.val}/15</span>
                    </div>
                `).join('');
            }
            
            // Reminders section ‚Äî above urgent actions
            const reminders = b.reminders || [];
            let actionsHtml = '';
            if (reminders.length > 0 || true) { // always show header for + button
                actionsHtml += renderBriefSectionHeader('LEMBRETES', 'reminders', 'brief-label-reminder');
                actionsHtml += reminders.map((item, i) => renderBriefItem(item, 'reminders', i, 'brief-action-reminder')).join('');
                if (reminders.length === 0) actionsHtml += '<div class="brief-action-item brief-action-clear"><span class="brief-action-text" style="opacity:0.4;">Nenhum lembrete</span></div>';
            }
            
            // Top Actions ‚Äî first 3 urgent with CRUD + links
            const urgent = b.action_items_urgent || [];
            const topActions = urgent.slice(0, 3);
            actionsHtml += topActions.map((item, i) => renderBriefItem(item, 'urgent', i, '')).join('');
            if (topActions.length === 0) {
                actionsHtml += '<div class="brief-action-item brief-action-clear"><span class="brief-action-text">Nenhuma acao urgente</span></div>';
            }
            if (actionsEl) actionsEl.innerHTML = actionsHtml;
            
            // Calendar ‚Äî split layout: day list (left) + day agenda (right)
            if (b.week_glance && calendarEl) {
                const dayMap = { 'MON': 'SEG', 'TUE': 'TER', 'WED': 'QUA', 'THU': 'QUI', 'FRI': 'SEX', 'SAT': 'SAB', 'SUN': 'DOM' };
                const todayAbbrs = ['DOM','SEG','TER','QUA','QUI','SEX','SAB'];
                const todayAbbr = todayAbbrs[new Date().getDay()];
                const weekStart = b.week_start ? new Date(b.week_start + 'T00:00:00') : null;
                
                const rawLines = b.week_glance.split('\n');
                briefParsedDays = [];
                const monthMap = { Jan:0, Feb:1, Mar:2, Apr:3, May:4, Jun:5, Jul:6, Aug:7, Sep:8, Oct:9, Nov:10, Dec:11 };
                const wsYear = weekStart ? weekStart.getFullYear() : new Date().getFullYear();
                rawLines.forEach(line => {
                    const m = line.match(/^(MON|TUE|WED|THU|FRI|SAT|SUN)\s+(\w+)\s+(\d+):\s*(.*)/i);
                    if (m) {
                        const eng = m[1].toUpperCase();
                        const monthStr = m[2];
                        const dayNum = parseInt(m[3]);
                        // Build date from month+day in the line itself
                        let dateStr = '';
                        const mi = monthMap[monthStr];
                        if (mi !== undefined) {
                            const d = new Date(wsYear, mi, dayNum);
                            dateStr = d.toISOString().split('T')[0];
                        }
                        briefParsedDays.push({ abbr: dayMap[eng] || eng, text: m[4].trim(), date: dateStr, dayNum });
                    } else if (briefParsedDays.length > 0 && line.trim()) {
                        briefParsedDays[briefParsedDays.length - 1].text += ', ' + line.trim();
                    }
                });
                
                // Set default selected date to today
                const todayStr = new Date().toISOString().split('T')[0];
                if (!briefSelectedDate) {
                    briefSelectedDate = briefParsedDays.find(d => d.date === todayStr)?.date || (briefParsedDays[0]?.date) || todayStr;
                }
                
                const dayListHtml = briefParsedDays.map(d => {
                    const isToday = d.abbr === todayAbbr;
                    const isSelected = d.date === briefSelectedDate;
                    return `<div class="brief-day-row${isToday ? ' brief-today' : ''}${isSelected ? ' brief-day-selected' : ''}" onclick="briefSelectDay('${d.date}')" data-date="${d.date}">
                        <span class="brief-day-abbr">${d.abbr}</span>
                        <span class="brief-day-text">${escapeHtml(d.text)}</span>
                    </div>`;
                }).join('');
                
                calendarEl.innerHTML = `
                    <div class="brief-calendar-split">
                        <div class="brief-cal-days">${dayListHtml}</div>
                        <div class="brief-cal-agenda" id="brief-day-agenda">
                            <div class="brief-agenda-loading">Carregando...</div>
                        </div>
                    </div>`;
                
                // Load selected day agenda
                loadBriefDayAgenda(briefSelectedDate);
            }
            
            // Footer ‚Äî counts + expand button
            if (footerEl) {
                const decisionCount = (b.decisions || []).length;
                const extraUrgent = Math.max(0, urgent.length - 3);
                const importantCount = (b.action_items_important || []).length;
                const parts = [];
                if (decisionCount > 0) parts.push(`${decisionCount} decisao${decisionCount !== 1 ? 'es' : ''}`);
                if (extraUrgent > 0) parts.push(`+${extraUrgent} urgente${extraUrgent !== 1 ? 's' : ''}`);
                if (importantCount > 0) parts.push(`${importantCount} importante${importantCount !== 1 ? 's' : ''}`);
                
                if (parts.length > 0) {
                    footerEl.innerHTML = `
                        <span class="brief-footer-counts">${parts.join(' &middot; ')}</span>
                        <span class="brief-footer-btn" id="brief-expand-btn" onclick="toggleBriefExpand()">
                            ${briefExpanded ? 'Recolher' : 'Expandir'}
                        </span>`;
                } else {
                    footerEl.innerHTML = '';
                }
            }
            
            // Expanded detail with CRUD + links
            if (briefExpanded && detailEl) {
                let html = '';
                
                // All urgent items (beyond top 3)
                if (urgent.length > 0) {
                    html += renderBriefSectionHeader('URGENTES', 'urgent', 'brief-label-urgent');
                    html += urgent.slice(3).map((item, i) => renderBriefItem(item, 'urgent', i + 3, '')).join('');
                }
                
                // Important items
                const important = b.action_items_important || [];
                html += renderBriefSectionHeader('IMPORTANTE', 'important', 'brief-label-important');
                html += important.map((item, i) => renderBriefItem(item, 'important', i, 'brief-action-important')).join('');
                if (important.length === 0) html += '<div class="brief-action-item brief-action-clear"><span class="brief-action-text" style="opacity:0.4;">Nenhum item</span></div>';
                
                // Decisions
                const decisions = b.decisions || [];
                html += renderBriefSectionHeader('DECISOES', 'decisions', 'brief-label-decision');
                html += decisions.map((d, i) => renderBriefItem(d, 'decisions', i, 'brief-action-decision')).join('');
                if (decisions.length === 0) html += '<div class="brief-action-item brief-action-clear"><span class="brief-action-text" style="opacity:0.4;">Nenhuma decisao</span></div>';
                
                detailEl.innerHTML = html;
                detailEl.style.display = 'block';
            } else if (detailEl) {
                detailEl.style.display = 'none';
            }
        }
        
        function toggleBriefExpand() {
            briefExpanded = !briefExpanded;
            const panel = document.getElementById('weekly-brief-panel');
            if (panel) panel.classList.toggle('expanded', briefExpanded);
            renderWeeklyBrief();
        }
        
        // --- Split calendar: load day agenda ---
        function briefSelectDay(dateStr) {
            briefSelectedDate = dateStr;
            // Update selected class
            document.querySelectorAll('.brief-day-row').forEach(el => {
                el.classList.toggle('brief-day-selected', el.dataset.date === dateStr);
            });
            loadBriefDayAgenda(dateStr);
        }
        
        async function loadBriefDayAgenda(dateStr) {
            const agendaEl = document.getElementById('brief-day-agenda');
            if (!agendaEl || !dateStr) return;
            agendaEl.innerHTML = '<div class="brief-agenda-loading">Carregando...</div>';
            try {
                const data = await CalendarAPI.getByDate(dateStr);
                const events = data.events || data || [];
                if (events.length === 0) {
                    agendaEl.innerHTML = '<div class="brief-agenda-empty">Sem eventos</div>';
                    return;
                }
                const d = new Date(dateStr + 'T00:00:00');
                const dayLabel = d.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'short' }).replace('.', '');
                agendaEl.innerHTML = `<div class="brief-agenda-header">${dayLabel}</div>` +
                    events.map(ev => `
                        <div class="brief-agenda-event">
                            <span class="brief-agenda-time">${escapeHtml(ev.time || '--:--')}</span>
                            <span class="brief-agenda-title">${escapeHtml(ev.summary || ev.title || '')}</span>
                        </div>
                    `).join('');
            } catch (e) {
                agendaEl.innerHTML = '<div class="brief-agenda-empty">Erro ao carregar</div>';
            }
        }
        
        // --- CRUD handlers ---
        function briefShowAddInput(section, btnEl) {
            const wrap = document.getElementById('brief-add-' + section);
            if (!wrap) return;
            const visible = wrap.style.display !== 'none';
            wrap.style.display = visible ? 'none' : 'block';
            if (!visible) {
                const input = wrap.querySelector('input');
                if (input) { input.value = ''; input.focus(); }
            }
        }
        
        async function briefAddKeydown(event, section) {
            if (event.key === 'Escape') {
                const wrap = document.getElementById('brief-add-' + section);
                if (wrap) wrap.style.display = 'none';
                return;
            }
            if (event.key !== 'Enter') return;
            const text = event.target.value.trim();
            if (!text) return;
            event.target.disabled = true;
            try {
                let item;
                if (section === 'urgent') item = { action: text, deadline: '', owner: 'Fabio' };
                else if (section === 'important') item = { action: text, context: '' };
                else if (section === 'decisions') item = { decision: text, options: '', deadline: '', who: 'Fabio' };
                await WeeklyBriefAPI.patchItem(section, 'add', null, item);
                // Refresh data
                weeklyBriefData = await apiRequest('/weekly-brief');
                renderWeeklyBrief();
            } catch (e) {
                console.error('Failed to add brief item:', e);
                event.target.disabled = false;
            }
        }
        
        async function briefCompleteItem(section, index) {
            try {
                await WeeklyBriefAPI.patchItem(section, 'complete', index);
                weeklyBriefData = await apiRequest('/weekly-brief');
                renderWeeklyBrief();
            } catch (e) { console.error('Failed to complete brief item:', e); }
        }
        
        async function briefRemoveItem(section, index) {
            try {
                await WeeklyBriefAPI.patchItem(section, 'remove', index);
                weeklyBriefData = await apiRequest('/weekly-brief');
                renderWeeklyBrief();
            } catch (e) { console.error('Failed to remove brief item:', e); }
        }
        
        // ===========================================
        // LIFE OPERATING SYSTEM
        // ===========================================
        
        let lifeOsMessages = [];
        let lifeOsExpanded = false;
        
        async function loadObsSummary() {
            try {
                const [tools, reports] = await Promise.all([
                    ObservabilityAPI.getToolMetrics(1),
                    ObservabilityAPI.getDailyReports(1),
                ]);
                const rate = tools.overall?.success_rate;
                const el = document.getElementById('obs-tool-health');
                if (el) el.textContent = rate != null ? `${rate}%` : (tools.overall?.total > 0 ? '--' : 'N/A');
                
                const report = (reports.reports || [])[0];
                const lastEvalEl = document.getElementById('obs-last-eval');
                const summaryEl = document.getElementById('obs-report-summary');
                if (report) {
                    if (lastEvalEl) lastEvalEl.textContent = report.report_date || '--';
                    if (summaryEl) summaryEl.textContent = report.summary || 'No summary';
                } else {
                    if (lastEvalEl) lastEvalEl.textContent = 'None';
                    if (summaryEl) summaryEl.textContent = 'No reports yet';
                }
            } catch (e) {
                const el = document.getElementById('obs-report-summary');
                if (el) el.textContent = 'Failed to load';
            }
        }

        async function loadLifeOS() {
            try {
                const response = await fetch(`${API_BASE}/scheduled-messages`);
                if (!response.ok) return;
                lifeOsMessages = await response.json();
                renderLifeOS();
            } catch (error) {
                console.log('Life OS not available:', error.message);
                const el = document.getElementById('life-os-summary');
                if (el) el.innerHTML = '<span style="color:var(--text-muted)">Life OS indisponivel</span>';
            }
        }
        
        function renderLifeOS() {
            const active = lifeOsMessages.filter(m => m.is_active);
            const today = new Date().getDay();
            const todayISO = today === 0 ? '7' : String(today);
            const todayMsgs = active.filter(m => m.days.split(',').includes(todayISO));
            
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const nextMsg = todayMsgs.filter(m => m.time > currentTime).sort((a,b) => a.time.localeCompare(b.time))[0];
            const dayNames = {'1':'Seg','2':'Ter','3':'Qua','4':'Qui','5':'Sex','6':'Sab','7':'Dom'};

            const summaryHTML = `
                <span style="color:var(--text-primary);font-weight:500">${active.length} mensagens ativas</span> ¬∑ 
                ${todayMsgs.length} hoje ¬∑ 
                ${nextMsg ? 'Proxima: <strong>' + nextMsg.time + '</strong> (' + nextMsg.name.replace(/_/g, ' ') + ')' : 'Todas enviadas hoje'}
            `;

            const messagesHTML = todayMsgs.sort((a,b) => a.time.localeCompare(b.time)).map(m => {
                const sent = m.last_sent_at && m.last_sent_at.startsWith(now.toISOString().slice(0,10));
                return `
                    <div class="life-os-msg-item ${sent ? 'sent' : ''}">
                        <div class="life-os-msg-time">${m.time}</div>
                        <div class="life-os-msg-content">
                            <div class="life-os-msg-text">${escapeHtml(m.message).substring(0, 80)}${m.message.length > 80 ? '...' : ''}</div>
                            <div class="life-os-msg-meta">${m.days.split(',').map(d => dayNames[d] || d).join(', ')} ¬∑ ${m.name.replace(/_/g, ' ')}${sent ? ' ¬∑ ‚úì Enviada' : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // SIDEBAR (desktop) ‚Äî always show messages (sidebar is the expanded view)
            const sidebarSummary = document.getElementById('life-os-summary');
            const sidebarMessages = document.getElementById('life-os-messages');
            if (sidebarSummary) sidebarSummary.innerHTML = summaryHTML;
            if (sidebarMessages) sidebarMessages.innerHTML = messagesHTML;

            // MOBILE ‚Äî uses collapsible card with toggle
            const mobileSummary = document.getElementById('life-os-summary-mobile');
            const mobileMessages = document.getElementById('life-os-messages-mobile');
            if (mobileSummary) mobileSummary.innerHTML = summaryHTML;
            if (lifeOsExpanded && mobileMessages) {
                mobileMessages.innerHTML = messagesHTML;
                mobileMessages.style.display = 'block';
            } else if (mobileMessages) {
                mobileMessages.style.display = 'none';
            }
        }
        
        function toggleLifeOsExpand() {
            lifeOsExpanded = !lifeOsExpanded;
            const toggle = document.getElementById('life-os-toggle');
            if (toggle) toggle.textContent = lifeOsExpanded ? 'Recolher' : 'Ver mais';
            renderLifeOS();
        }

        function toggleLifeOsSidebar() {
            const sidebar = document.getElementById('life-os-sidebar');
            if (!sidebar) return;
            sidebar.classList.toggle('collapsed');
            const icon = document.getElementById('sidebar-toggle-icon');
            if (icon) icon.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
            localStorage.setItem('life-os-sidebar-collapsed', sidebar.classList.contains('collapsed'));
        }

        // Restore sidebar state from localStorage
        (function initLifeOsSidebar() {
            const collapsed = localStorage.getItem('life-os-sidebar-collapsed');
            if (collapsed === 'true') {
                const sidebar = document.getElementById('life-os-sidebar');
                if (sidebar) sidebar.classList.add('collapsed');
                const icon = document.getElementById('sidebar-toggle-icon');
                if (icon) icon.textContent = '‚ñ∂';
            }
        })();
        
        // ===========================================
        // SUMMARY
        // ===========================================
        
        function updateSummary() {
            const todoCount = tasks.filter(t => t.status === 'todo').length;
            const urgentCount = tasks.filter(t => t.priority === 'urgent' && t.status !== 'done').length;
            const doingCount = tasks.filter(t => t.status === 'doing').length;
            
            // Update greeting summary
            const summaryParts = [];
            if (todoCount > 0) summaryParts.push(`${todoCount} tarefa${todoCount > 1 ? 's' : ''} a fazer`);
            if (doingCount > 0) summaryParts.push(`${doingCount} em andamento`);
            
            document.getElementById('greeting-summary').textContent = 
                summaryParts.length > 0 ? `Voc√™ tem ${summaryParts.join(', ')}.` : 'Tudo em dia!';
            
            // Update chips
            const chipsContainer = document.getElementById('summary-chips');
            let chipsHtml = '';
            
            if (todoCount > 0) {
                chipsHtml += `
                    <div class="summary-chip">
                        <span>üìã</span>
                        <span class="chip-number">${todoCount}</span>
                        <span>tarefas</span>
                    </div>
                `;
            }
            
            if (urgentCount > 0) {
                chipsHtml += `
                    <div class="summary-chip urgent">
                        <span>üî•</span>
                        <span class="chip-number">${urgentCount}</span>
                        <span>urgente${urgentCount > 1 ? 's' : ''}</span>
                    </div>
                `;
            }
            
            const workProjectCount = projects.filter(p => p.category === 'trabalho' && p.status === 'active').length;
            if (workProjectCount > 0) {
                chipsHtml += `
                    <div class="summary-chip">
                        <span>üíº</span>
                        <span class="chip-number">${workProjectCount}</span>
                        <span>projetos ativos</span>
                    </div>
                `;
            }
            
            chipsContainer.innerHTML = chipsHtml || '<span style="color: var(--text-muted);">Tudo organizado!</span>';
        }
        
        // ===========================================
        // PRIORITY PULSE
        // ===========================================
        
        function buildPriorityPulse() {
            const pulseEl = document.getElementById('priority-pulse');
            const itemsEl = document.getElementById('pulse-items');
            const countEl = document.getElementById('pulse-count');
            if (!pulseEl || !itemsEl) return;
            
            const items = [];
            const now = new Date();
            
            // 1. Overdue MBA items (red)
            _mbaDeadlines.forEach(d => {
                const dueDate = parseMBADate(d.data);
                if (dueDate < now) {
                    items.push({
                        type: 'overdue',
                        icon: 'üéì',
                        label: `MBA: "${d.title}" venceu ${d.data.split(' - ')[0]}`,
                        link: 'mba',
                        linkText: 'Ver MBA',
                        priority: 1
                    });
                }
            });
            
            // 2. Urgent tasks (orange)
            tasks.filter(t => (t.priority === 'urgent' || t.priority === 'high') && t.status !== 'done').forEach(t => {
                items.push({
                    type: 'urgent',
                    icon: 'üî•',
                    label: `Tarefa urgente: "${t.title}"`,
                    link: '#',
                    linkText: 'Abrir',
                    onclick: `openTaskModal('${t.id}')`,
                    priority: 2
                });
            });
            
            // 3. Next meeting (blue)
            if (_calendarEvents.length > 0) {
                const nextEvent = _calendarEvents[0];
                const eventTime = nextEvent.time || '--:--';
                // Calculate time until meeting
                let timeLabel = eventTime;
                if (eventTime && eventTime !== '--:--') {
                    const [h, m] = eventTime.split(':').map(Number);
                    const eventDate = new Date();
                    eventDate.setHours(h, m, 0, 0);
                    const diffMin = Math.round((eventDate - now) / 60000);
                    if (diffMin > 0 && diffMin <= 60) {
                        timeLabel = `em ${diffMin}min`;
                    } else if (diffMin <= 0) {
                        timeLabel = 'agora';
                    }
                }
                items.push({
                    type: 'meeting',
                    icon: 'üìÖ',
                    label: `Proxima reuniao: ${eventTime} ${nextEvent.summary || nextEvent.title}`,
                    link: null,
                    linkText: timeLabel,
                    isInfo: true,
                    priority: 3
                });
            }
            
            // 4. Work risks (purple)
            if (_workAlerts.risks > 0) {
                items.push({
                    type: 'work',
                    icon: '‚ö†Ô∏è',
                    label: `${_workAlerts.risks} risco${_workAlerts.risks > 1 ? 's' : ''} ativo${_workAlerts.risks > 1 ? 's' : ''} no trabalho`,
                    link: 'work',
                    linkText: 'Ver Work',
                    priority: 4
                });
            }
            if (_workAlerts.bugs > 0) {
                items.push({
                    type: 'work',
                    icon: 'üêõ',
                    label: `${_workAlerts.bugs} bug${_workAlerts.bugs > 1 ? 's' : ''} ativo${_workAlerts.bugs > 1 ? 's' : ''} no trabalho`,
                    link: 'work',
                    linkText: 'Ver Work',
                    priority: 5
                });
            }
            
            // Sort by priority, limit to 5
            items.sort((a, b) => a.priority - b.priority);
            const display = items.slice(0, 5);
            
            if (display.length === 0) {
                // All clear state
                pulseEl.style.display = 'block';
                pulseEl.classList.add('all-clear');
                countEl.textContent = 'Tudo em dia';
                itemsEl.innerHTML = '<div class="pulse-item pulse-clear"><span class="pulse-item-icon">‚úÖ</span><span class="pulse-item-label">Nenhum item urgente. Bom trabalho!</span></div>';
                return;
            }
            
            pulseEl.style.display = 'block';
            pulseEl.classList.remove('all-clear');
            countEl.textContent = `${display.length} item${display.length > 1 ? 's' : ''}`;
            
            itemsEl.innerHTML = display.map(item => {
                let actionHtml;
                if (item.onclick) {
                    actionHtml = `<button class="pulse-item-action" type="button" onclick="${item.onclick}">${item.linkText}</button>`;
                } else if (item.isInfo || !item.link) {
                    actionHtml = `<span class="pulse-item-action">${item.linkText}</span>`;
                } else {
                    actionHtml = `<a class="pulse-item-action" href="${item.link}">${item.linkText}</a>`;
                }
                return `<div class="pulse-item pulse-${item.type}">
                    <span class="pulse-item-icon">${item.icon}</span>
                    <span class="pulse-item-label">${escapeHtml(item.label)}</span>
                    ${actionHtml}
                </div>`;
            }).join('');
        }
        
        // ===========================================
        // COLLAPSIBLE CARDS
        // ===========================================
        
        function initCollapsibleCards() {
            document.querySelectorAll('[data-collapsible]').forEach(card => {
                const key = card.getAttribute('data-collapsible');
                const saved = localStorage.getItem(`card-collapsed-${key}`);
                if (saved === null) {
                    // First visit: default to collapsed for secondary cards
                    card.classList.add('collapsed');
                } else if (saved === 'true') {
                    card.classList.add('collapsed');
                }
                // saved === 'false' ‚Üí user explicitly expanded, leave open
            });
        }
        
        function toggleCardCollapse(card) {
            if (!card || !card.hasAttribute('data-collapsible')) return;
            card.classList.toggle('collapsed');
            const key = card.getAttribute('data-collapsible');
            localStorage.setItem(`card-collapsed-${key}`, card.classList.contains('collapsed'));
        }

        // ===========================================
        // MODALS
        // ===========================================
        
        function openTaskModal(taskId = null) {
            document.getElementById('task-modal').classList.add('active');
            document.getElementById('task-modal-title').textContent = taskId ? 'Editar Tarefa' : 'Nova Tarefa';
            document.getElementById('task-id').value = taskId || '';
            
            if (!taskId) {
                document.getElementById('task-form').reset();
            }
            
            // Populate project select
            const projectSelect = document.getElementById('task-project');
            projectSelect.innerHTML = '<option value="">Sem projeto</option>' +
                projects.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
            
            document.getElementById('task-title').focus();
        }
        
        function closeTaskModal() {
            document.getElementById('task-modal').classList.remove('active');
        }
        
        function openNoteModal() {
            document.getElementById('note-modal').classList.add('active');
            document.getElementById('note-form').reset();
            document.getElementById('note-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('note-title').focus();
        }
        
        function closeNoteModal() {
            document.getElementById('note-modal').classList.remove('active');
        }
        
        function showKanban() {
            document.getElementById('kanban-modal').classList.add('active');
            renderFullKanban();
        }
        
        function closeKanbanModal() {
            document.getElementById('kanban-modal').classList.remove('active');
        }
        
        function renderFullKanban() {
            const container = document.getElementById('kanban-board-full');
            const todoTasks = tasks.filter(t => t.status === 'todo');
            const doingTasks = tasks.filter(t => t.status === 'doing');
            const doneTasks = tasks.filter(t => t.status === 'done');
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div>
                        <h4 style="color: #ef4444; margin-bottom: 12px;">üî¥ A Fazer (${todoTasks.length})</h4>
                        ${renderTaskList(todoTasks)}
                    </div>
                    <div>
                        <h4 style="color: #eab308; margin-bottom: 12px;">üü° Fazendo (${doingTasks.length})</h4>
                        ${renderTaskList(doingTasks)}
                    </div>
                    <div>
                        <h4 style="color: #22c55e; margin-bottom: 12px;">üü¢ Feito (${doneTasks.length})</h4>
                        ${renderTaskList(doneTasks)}
                    </div>
                </div>
            `;
        }
        
        function renderTaskList(taskList) {
            if (taskList.length === 0) {
                return '<div class="empty-state-styled"><span class="empty-icon">‚úÖ</span><span>Nenhuma tarefa</span></div>';
            }
            
            return taskList.map(t => `
                <div style="background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer;"
                     onclick="openTaskModal(${t.id})">
                    <div style="font-weight: 500;">${escapeHtml(t.title)}</div>
                    ${t.priority === 'urgent' || t.priority === 'high' ? 
                        '<div style="font-size: 0.75rem; color: #ef4444; margin-top: 4px;">üî• Alta prioridade</div>' : ''}
                </div>
            `).join('');
        }
        
        // ===========================================
        // SAVE HANDLERS
        // ===========================================
        
        async function saveTask(event) {
            event.preventDefault();
            
            const taskId = document.getElementById('task-id').value;
            const data = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                priority: document.getElementById('task-priority').value,
                status: document.getElementById('task-status').value,
                project_id: document.getElementById('task-project').value || null,
                due_date: document.getElementById('task-due-date').value || null
            };
            
            try {
                if (taskId) {
                    await apiRequest(`/tasks/${taskId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                } else {
                    await apiRequest('/tasks', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }
                
                closeTaskModal();
                showNotification(taskId ? 'Tarefa atualizada!' : 'Tarefa criada!');
                loadTasks();
                updateSummary();
            } catch (error) {
                console.error('Error saving task:', error);
                showNotification('Erro ao salvar tarefa');
            }
        }
        
        async function saveNote(event) {
            event.preventDefault();
            
            const data = {
                title: document.getElementById('note-title').value,
                content: document.getElementById('note-content').value,
                meeting_date: document.getElementById('note-date').value
            };
            
            try {
                await apiRequest('/notes', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                closeNoteModal();
                showNotification('Nota salva!');
            } catch (error) {
                console.error('Error saving note:', error);
                showNotification('Erro ao salvar nota');
            }
        }
        
        // ===========================================
        // COMMAND PALETTE
        // ===========================================
        
        function openCommandPalette() {
            document.getElementById('command-palette').classList.add('active');
            document.getElementById('command-input').value = '';
            document.getElementById('command-input').focus();
            document.getElementById('command-results').innerHTML = '';
            commandSelectedIndex = 0; // Reset selection
        }
        
        function closeCommandPalette() {
            document.getElementById('command-palette').classList.remove('active');
        }
        
        function handleCommandInput(query) {
            if (!query.trim()) {
                document.getElementById('command-results').innerHTML = '';
                return;
            }
            
            const results = [];
            const q = query.toLowerCase();
            
            // Search tasks
            tasks.filter(t => t.title.toLowerCase().includes(q)).slice(0, 3).forEach(t => {
                results.push({
                    icon: 'üìã',
                    text: t.title,
                    hint: `Tarefa - ${t.status}`,
                    action: () => openTaskModal(t.id)
                });
            });
            
            // Search projects
            projects.filter(p => p.name.toLowerCase().includes(q)).slice(0, 3).forEach(p => {
                results.push({
                    icon: 'üöÄ',
                    text: p.name,
                    hint: 'Projeto',
                    action: () => window.location.href = `project.html?id=${p.id}`
                });
            });
            
            // Quick actions
            if ('nova tarefa'.includes(q) || 'new task'.includes(q)) {
                results.push({
                    icon: '‚ûï',
                    text: 'Nova Tarefa',
                    hint: 'Criar nova tarefa',
                    action: () => { closeCommandPalette(); openTaskModal(); }
                });
            }
            
            if ('nota'.includes(q) || 'reuni√£o'.includes(q)) {
                results.push({
                    icon: 'üìù',
                    text: 'Nova Nota',
                    hint: 'Criar nota de reuni√£o',
                    action: () => { closeCommandPalette(); openNoteModal(); }
                });
            }
            
            renderCommandResults(results);
        }
        
        function renderCommandResults(results) {
            const container = document.getElementById('command-results');
            commandSelectedIndex = 0; // Reset selection on new results
            
            if (results.length === 0) {
                container.innerHTML = '<div class="command-result"><span style="color: var(--text-muted);">Nenhum resultado</span></div>';
                return;
            }
            
            container.innerHTML = results.map((r, i) => `
                <div class="command-result ${i === 0 ? 'selected' : ''}" onclick="executeCommandResult(${i})">
                    <span class="command-result-icon">${r.icon}</span>
                    <span class="command-result-text">${escapeHtml(r.text)}</span>
                    <span class="command-result-hint">${r.hint}</span>
                </div>
            `).join('');
            
            // Store results for execution
            window.commandResults = results;
        }
        
        function executeCommandResult(index) {
            if (window.commandResults && window.commandResults[index]) {
                window.commandResults[index].action();
                closeCommandPalette();
            }
        }
        
        // ===========================================
        // KEYBOARD SHORTCUTS
        // ===========================================
        
        function setupKeyboardShortcuts() {
            // Track selected task for keyboard navigation
            let selectedTaskIndex = -1;
            
            document.addEventListener('keydown', (e) => {
                // Ignore when typing in inputs
                const isTyping = ['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName);
                const isPaletteOpen = document.getElementById('command-palette').classList.contains('active');
                
                // Command palette (Ctrl + K) - works always
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    if (isPaletteOpen) {
                        closeCommandPalette();
                    } else {
                        openCommandPalette();
                    }
                    return;
                }
                
                // New task (Ctrl + N)
                if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                    e.preventDefault();
                    openTaskModal();
                    return;
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    closeCommandPalette();
                    closeTaskModal();
                    closeReminderModal();
                    closeNoteModal();
                    closeKanbanModal();
                    return;
                }
                
                // Enter to execute selected command result
                if (e.key === 'Enter' && isPaletteOpen) {
                    e.preventDefault();
                    executeCommandResult(commandSelectedIndex);
                    return;
                }
                
                // Skip other shortcuts if typing
                if (isTyping) return;
                
                // === Linear-inspired shortcuts (single key when not typing) ===
                
                // C = Create task
                if (e.key === 'c' || e.key === 'C') {
                    e.preventDefault();
                    openTaskModal();
                    return;
                }
                
                // N = New note
                if (e.key === 'n') {
                    e.preventDefault();
                    openNoteModal();
                    return;
                }
                
                // B = Show board/kanban
                if (e.key === 'b' || e.key === 'B') {
                    e.preventDefault();
                    showKanban();
                    return;
                }
                
                // P = (Portfolio removed)
                
                // M = MBA
                if (e.key === 'm' || e.key === 'M') {
                    e.preventDefault();
                    window.location.href = 'mba.html';
                    return;
                }
                
                // S = Sync
                if (e.key === 's' || e.key === 'S') {
                    e.preventDefault();
                    syncAllData();
                    return;
                }
                
                // ? = Show shortcuts help
                if (e.key === '?') {
                    e.preventDefault();
                    showShortcutsHelp();
                    return;
                }
                
                // 1-3 = Quick filter tasks by status
                if (e.key === '1') {
                    e.preventDefault();
                    filterTasksQuick('todo');
                    return;
                }
                if (e.key === '2') {
                    e.preventDefault();
                    filterTasksQuick('doing');
                    return;
                }
                if (e.key === '3') {
                    e.preventDefault();
                    filterTasksQuick('done');
                    return;
                }
                
                // Arrow navigation in command palette
                if (isPaletteOpen) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        navigateCommandResults(1);
                    }
                    if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        navigateCommandResults(-1);
                    }
                }
            });
        }
        
        // Shortcuts help modal
        function showShortcutsHelp() {
            const shortcuts = [
                { key: 'Ctrl + K', desc: 'Command palette' },
                { key: 'Ctrl + N', desc: 'Nova tarefa' },
                { key: 'C', desc: 'Criar tarefa' },
                { key: 'N', desc: 'Nova nota' },
                { key: 'R', desc: 'Novo lembrete' },
                { key: 'B', desc: 'Ver Kanban board' },
                { key: 'M', desc: 'MBA' },
                { key: 'S', desc: 'Sincronizar dados' },
                { key: '1/2/3', desc: 'Filtrar tarefas (todo/doing/done)' },
                { key: 'Esc', desc: 'Fechar modais' },
                { key: '?', desc: 'Esta ajuda' }
            ];
            
            const html = `
                <div class="shortcuts-modal" onclick="this.remove()">
                    <div class="shortcuts-content" onclick="event.stopPropagation()">
                        <h2>‚å®Ô∏è Atalhos de Teclado</h2>
                        <div class="shortcuts-list">
                            ${shortcuts.map(s => `
                                <div class="shortcut-item">
                                    <kbd>${s.key}</kbd>
                                    <span>${s.desc}</span>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()">Fechar</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function filterTasksQuick(status) {
            // Highlight the status section in mini-kanban
            const statusMap = { 'todo': 'A Fazer', 'doing': 'Fazendo', 'done': 'Feito' };
            showNotification(`Filtro: ${statusMap[status]}`);
            // Could expand to actual filtering logic
        }
        
        function syncAllData() {
            fullSync();
        }
        
        function showNotification(message) {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        
        let commandSelectedIndex = 0;
        
        function navigateCommandResults(direction) {
            const results = document.querySelectorAll('.command-result');
            if (results.length === 0) return;
            
            // Remove previous selection
            results[commandSelectedIndex]?.classList.remove('selected');
            
            // Update index
            commandSelectedIndex += direction;
            if (commandSelectedIndex < 0) commandSelectedIndex = results.length - 1;
            if (commandSelectedIndex >= results.length) commandSelectedIndex = 0;
            
            // Add selection
            results[commandSelectedIndex]?.classList.add('selected');
            results[commandSelectedIndex]?.scrollIntoView({ block: 'nearest' });
        }
        
        // ===========================================
        // UTILITIES
        // ===========================================
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'agora';
            if (diff < 3600) return `h√° ${Math.floor(diff / 60)} min`;
            if (diff < 86400) return `h√° ${Math.floor(diff / 3600)}h`;
            if (diff < 604800) return `h√° ${Math.floor(diff / 86400)} dias`;
            return date.toLocaleDateString('pt-BR');
        }
        
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // ===========================================
        // SYNC SYSTEM
        // ===========================================
        
        function toggleSyncMenu() {
            const dropdown = document.getElementById('sync-dropdown');
            const isOpen = dropdown.classList.contains('open');
            dropdown.classList.toggle('open');
            if (!isOpen) loadSyncStatus();
        }
        
        // Close sync menu when clicking outside
        document.addEventListener('click', (e) => {
            const wrapper = document.querySelector('.sync-dropdown-wrapper');
            if (wrapper && !wrapper.contains(e.target)) {
                document.getElementById('sync-dropdown')?.classList.remove('open');
            }
        });
        
        async function quickReload() {
            document.getElementById('sync-dropdown')?.classList.remove('open');
            showNotification('Atualizando dados...');
            APICache.data.clear();
            await loadAllData();
            showNotification('Dados atualizados!');
        }
        
        async function fullSync() {
            document.getElementById('sync-dropdown')?.classList.remove('open');
            const syncBtn = document.getElementById('sync-btn');
            syncBtn?.classList.add('syncing');
            showNotification('Sincronizando todas as fontes...');
            
            try {
                // Run Confluence + Notion in parallel
                const [confResult, notionResult] = await Promise.allSettled([
                    apiRequest('/sync/all', { method: 'POST' }),
                    apiRequest('/notion/sync', { method: 'POST' })
                ]);
                
                const messages = [];
                if (confResult.status === 'fulfilled' && confResult.value?.confluence?.status === 'ok') {
                    messages.push('Confluence OK');
                } else if (confResult.status === 'rejected' || confResult.value?.confluence?.status === 'error') {
                    messages.push('Confluence: erro');
                }
                if (notionResult.status === 'fulfilled' && notionResult.value?.status === 'ok') {
                    messages.push(`Notion OK (${notionResult.value.meetings_synced || 0})`);
                } else {
                    messages.push('Notion: erro');
                }
                
                APICache.data.clear();
                await loadAllData();
                await loadSyncStatus();
                
                showNotification(messages.join(' | '));
            } catch (error) {
                console.error('Full sync error:', error);
                showNotification('Erro na sincronizacao');
                APICache.data.clear();
                await loadAllData();
            } finally {
                syncBtn?.classList.remove('syncing');
            }
        }
        
        async function syncData() {
            await quickReload();
        }
        
        async function loadSyncStatus() {
            try {
                const status = await apiRequest('/sync/status');
                
                const sources = ['confluence', 'notion', 'calendar', 'mba'];
                for (const src of sources) {
                    const tsEl = document.getElementById(`ts-${src}`);
                    const badgeEl = document.getElementById(`badge-${src}`);
                    if (!tsEl || !badgeEl) continue;
                    
                    const info = status[src] || {};
                    const lastSync = info.last_sync;
                    
                    if (lastSync) {
                        const ago = formatTimeAgo(new Date(lastSync));
                        tsEl.textContent = ago;
                        
                        // Determine freshness: <1h = ok, <24h = stale, else error
                        const ageMs = Date.now() - new Date(lastSync).getTime();
                        const ageHours = ageMs / (1000 * 60 * 60);
                        if (info.status === 'error') {
                            badgeEl.className = 'sync-source-badge error';
                        } else if (ageHours < 2) {
                            badgeEl.className = 'sync-source-badge ok';
                        } else if (ageHours < 24) {
                            badgeEl.className = 'sync-source-badge stale';
                        } else {
                            badgeEl.className = 'sync-source-badge error';
                        }
                    } else if (info.status === 'never_synced') {
                        tsEl.textContent = 'nunca sincronizado';
                        badgeEl.className = 'sync-source-badge never';
                    } else if (info.status === 'ok') {
                        tsEl.textContent = info.source || 'arquivo local';
                        badgeEl.className = 'sync-source-badge ok';
                    } else {
                        tsEl.textContent = '--';
                        badgeEl.className = 'sync-source-badge never';
                    }
                }
            } catch (error) {
                console.error('Failed to load sync status:', error);
            }
        }
        
        async function syncSource(source) {
            // Confirm heavy operations
            if (source === 'mba' && !confirm('Sincronizar MBA pode levar 1-2 minutos. Continuar?')) return;
            
            document.getElementById('sync-dropdown')?.classList.remove('open');
            const syncBtn = document.getElementById('sync-btn');
            syncBtn?.classList.add('syncing');
            
            const names = {confluence: 'Confluence', notion: 'Notion', calendar: 'Calendario', mba: 'MBA'};
            showNotification(`Sincronizando ${names[source] || source}...`);
            
            try {
                let result;
                if (source === 'notion') {
                    result = await apiRequest('/notion/sync', { method: 'POST' });
                } else if (source === 'confluence') {
                    result = await apiRequest('/sync/all', { method: 'POST' });
                } else if (source === 'calendar' || source === 'mba') {
                    showNotification(`${names[source]}: sincronizado via cron automatico`);
                    syncBtn?.classList.remove('syncing');
                    return;
                }
                
                if (result?.status === 'ok') {
                    const count = result.meetings_synced || result.items_synced || result.confluence?.items || '';
                    showNotification(`${names[source]}: sincronizado${count ? ` (${count} itens)` : ''}`);
                } else if (result?.status === 'not_configured') {
                    showNotification(`${names[source]}: nao configurado no backend`);
                } else {
                    showNotification(`${names[source]}: ${result?.message || 'erro'}`);
                }
                
                APICache.data.clear();
                await loadAllData();
                await loadSyncStatus();
            } catch (error) {
                console.error(`Sync ${source} error:`, error);
                showNotification(`Erro ao sincronizar ${names[source]}`);
            } finally {
                syncBtn?.classList.remove('syncing');
            }
        }
    </script>
    <script src="js/mobile-nav.js?v=7"></script>
</body>
</html>
